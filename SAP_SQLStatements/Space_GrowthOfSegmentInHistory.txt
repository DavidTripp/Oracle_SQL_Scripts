SELECT NULL BEGIN_TIME, NULL UNUSED_MB, NULL "QUALITY_%", NULL GROSS_MB,
  NULL NET_MB, NULL GROSS_DELTA_MB, NULL NET_DELTA_MB FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT NULL BEGIN_TIME, NULL UNUSED_MB, NULL "QUALITY_%", NULL GROSS_MB,
  NULL NET_MB, NULL GROSS_DELTA_MB, NULL NET_DELTA_MB FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT 
    BEGIN_DATE,
    END_DATE,
    TO_TIMESTAMP(TO_CHAR(BEGIN_DATE, 'dd.mm.yyyy hh24:mi:ss'), 
      'dd.mm.yyyy hh24:mi:ss') BEGIN_TIME,
    TO_TIMESTAMP(TO_CHAR(END_DATE, 'dd.mm.yyyy hh24:mi:ss'), 
      'dd.mm.yyyy hh24:mi:ss') END_TIME,
    BEGIN_SNAP_ID,    
    END_SNAP_ID,
    SEGMENT_NAME,
    PARTITION_NAME,
    DECODE(B.INSTANCE_NUMBER, -1, I.INSTANCE_NUMBER) INSTANCE_NUMBER
  FROM
  ( SELECT
      TO_DATE('01.01.1000 18:00:00', 'dd.mm.yyyy hh24:mi:ss') BEGIN_DATE,
      TO_DATE('31.12.9999 18:00:00', 'dd.mm.yyyy hh24:mi:ss') END_DATE,
      -1 BEGIN_SNAP_ID,   /* explicit SNAP_IDs sometimes required for ASH partition pruning */
      -1 END_SNAP_ID,
      'DFKKOP' SEGMENT_NAME,    /* Single segment, no search pattern possible */
      '%' PARTITION_NAME,
      -1 INSTANCE_NUMBER
    FROM
      DUAL
  ) B,
  ( SELECT INSTANCE_NUMBER FROM V$INSTANCE ) I
),
SNAPSHOTS AS
( SELECT 
    HSS.INSTANCE_NUMBER,
    MIN(HSS.SNAP_ID) BEGIN_SNAP_ID,
    MIN(HSS.BEGIN_INTERVAL_TIME) BEGIN_TIME,
    MAX(HSS.SNAP_ID) END_SNAP_ID,
    MAX(HSS.END_INTERVAL_TIME) END_TIME
  FROM 
    DBA_HIST_SNAPSHOT HSS,
    BASIS_INFO BI
  WHERE
    HSS.INSTANCE_NUMBER = BI.INSTANCE_NUMBER AND
    HSS.END_INTERVAL_TIME >= BI.BEGIN_TIME AND
    HSS.BEGIN_INTERVAL_TIME <= BI.END_TIME
  GROUP BY
    HSS.INSTANCE_NUMBER
)
SELECT
  TO_CHAR(BEGIN_INTERVAL_TIME, 'dd.mm.yyyy hh24:mi:ss') BEGIN_TIME,
  TO_CHAR((SPACE_ALLOC_TOTAL - SPACE_USED_TOTAL) / 1024 / 1024, 9999990.99) UNUSED_MB,
  TO_CHAR(DECODE(SPACE_ALLOC_TOTAL, 0, 0, SPACE_USED_TOTAL / 
    SPACE_ALLOC_TOTAL) * 100, 99990.99) "QUALITY_%",
  TO_CHAR(SPACE_ALLOC_TOTAL / 1024 / 1024, 9999990.99) GROSS_MB,
  TO_CHAR(SPACE_USED_TOTAL / 1024 / 1024, 999990.99) NET_MB,
  TO_CHAR(SPACE_ALLOC_DELTA / 1024 / 1024, 9999999990.99) GROSS_DELTA_MB,
  TO_CHAR(SPACE_USED_DELTA / 1024 / 1024, 99999990.99) NET_DELTA_MB
FROM
( SELECT
    HSS.SNAP_ID,
    HSS.BEGIN_INTERVAL_TIME,
    SUM(SS.SPACE_USED_TOTAL) SPACE_USED_TOTAL,
    SUM(SS.SPACE_USED_DELTA) SPACE_USED_DELTA,
    SUM(SS.SPACE_ALLOCATED_TOTAL) SPACE_ALLOC_TOTAL,
    SUM(SS.SPACE_ALLOCATED_DELTA) SPACE_ALLOC_DELTA
  FROM
    BASIS_INFO BI,
    SNAPSHOTS S,
    DBA_HIST_SNAPSHOT HSS,
    DBA_HIST_SEG_STAT SS,
    DBA_HIST_SEG_STAT_OBJ SSO
  WHERE
    SSO.OBJECT_NAME = BI.SEGMENT_NAME AND
    NVL(SSO.SUBOBJECT_NAME, ' ') LIKE BI.PARTITION_NAME AND
    HSS.SNAP_ID BETWEEN S.BEGIN_SNAP_ID AND S.END_SNAP_ID AND
    SS.SNAP_ID = HSS.SNAP_ID AND
    SSO.OBJ# = SS.OBJ# AND
    SSO.DATAOBJ# = SS.DATAOBJ#
  GROUP BY
    HSS.SNAP_ID,
    HSS.BEGIN_INTERVAL_TIME
)
ORDER BY
  SNAP_ID DESC
));