SELECT NULL OWNER, NULL TABLE_NAME, NULL COMPRESS_FOR, NULL FINDING, NULL IMPACT, NULL SAP_NOTES FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT NULL OWNER, NULL TABLE_NAME, NULL COMPRESS_FOR, NULL FINDING, NULL IMPACT, NULL SAP_NOTES FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT
    '%' OWNER,
    '%' TABLE_NAME,
    255 MIN_COLUMN_THRESHOLD,
    'X' REPORT_LONG_COLUMNS
  FROM
    DUAL
)
SELECT
  OWNER,
  TABLE_NAME,
  COMPRESS_FOR,
  CASE
    WHEN MIN_COLUMN_THRESHOLD != -1 AND NUM_COLUMNS > MIN_COLUMN_THRESHOLD THEN
      'Number of columns (' || NUM_COLUMNS || ') exceeds ' || MIN_COLUMN_THRESHOLD
    WHEN REPORT_LONG_COLUMNS = 'X' AND DATA_TYPE IS NOT NULL THEN
      DATA_TYPE || ' column ' || COLUMN_NAME
  END FINDING,
  CASE
    WHEN MIN_COLUMN_THRESHOLD != -1 AND NUM_COLUMNS > MIN_COLUMN_THRESHOLD THEN
      'Risk of bad performance and corruptions'
    WHEN REPORT_LONG_COLUMNS = 'X' AND DATA_TYPE IS NOT NULL THEN
      'Risk of corruptions'
  END IMPACT,
  CASE
    WHEN MIN_COLUMN_THRESHOLD != -1 AND NUM_COLUMNS > MIN_COLUMN_THRESHOLD THEN
      '1970224'
    WHEN REPORT_LONG_COLUMNS = 'X' AND DATA_TYPE IS NOT NULL THEN
      '1818320, 1871529'
  END SAP_NOTES
FROM
( SELECT 
    T.OWNER,
    T.TABLE_NAME,
    T.COMPRESS_FOR,
    COUNT(*) NUM_COLUMNS,
    MIN(CASE WHEN TC.DATA_TYPE IN ( 'LONG', 'LONG RAW' ) THEN TC.COLUMN_NAME END) COLUMN_NAME,
    MIN(CASE WHEN TC.DATA_TYPE IN ( 'LONG', 'LONG RAW' ) THEN TC.DATA_TYPE END) DATA_TYPE,
    BI.MIN_COLUMN_THRESHOLD,
    BI.REPORT_LONG_COLUMNS
  FROM
    BASIS_INFO BI,
    DBA_TABLES T,
    DBA_TAB_COLUMNS TC
  WHERE
    T.OWNER LIKE BI.OWNER AND
    T.TABLE_NAME LIKE BI.TABLE_NAME AND
    T.OWNER = TC.OWNER AND
    T.TABLE_NAME = TC.TABLE_NAME AND
    T.COMPRESSION = 'ENABLED' AND
    T.COMPRESS_FOR = 'OLTP' 
  GROUP BY
    T.OWNER,
    T.TABLE_NAME,
    T.COMPRESS_FOR,
    BI.MIN_COLUMN_THRESHOLD,
    BI.REPORT_LONG_COLUMNS
)
WHERE
  ( MIN_COLUMN_THRESHOLD != -1 AND NUM_COLUMNS > MIN_COLUMN_THRESHOLD OR
    REPORT_LONG_COLUMNS = 'X' AND DATA_TYPE IS NOT NULL
  )
ORDER BY
  OWNER,
  TABLE_NAME
));

