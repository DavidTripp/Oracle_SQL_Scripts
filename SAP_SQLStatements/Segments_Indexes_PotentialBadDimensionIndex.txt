SELECT 
	NULL TABLE_NAME, NULL INDEX_NAME, NULL NUM_ROWS, NULL NUM_DISTINCT,
	NULL IND_COL, NULL IND_COL_POS, NULL TAB_COL, NULL RANK
FROM DUAL WHERE 1=0 UNION ALL
(
SELECT 
	NULL TABLE_NAME, NULL INDEX_NAME, NULL NUM_ROWS, NULL NUM_DISTINCT,
	NULL IND_COL, NULL IND_COL_POS, NULL TAB_COL, NULL RANK
FROM DUAL WHERE 1=0
) UNION ALL
SELECT * FROM (
WITH INDEX_LIST AS
(
SELECT TABLE_NAME, INDEX_NAME
	FROM DBA_IND_COLUMNS
WHERE 
	INDEX_OWNER LIKE 'SAP%' AND
	TABLE_NAME LIKE '/BI_/D%'
GROUP BY TABLE_NAME,INDEX_NAME
HAVING COUNT(*) = 16
),
TABLE_LIST AS
(
SELECT TABLE_NAME
	FROM DBA_TAB_COLUMNS
WHERE
	OWNER LIKE 'SAP%' AND
	TABLE_NAME LIKE '/BI_/D%'
GROUP BY TABLE_NAME
HAVING COUNT(*) > 17
),
INDEX_LIST_ALL AS
(
SELECT
	IL.TABLE_NAME, IL.INDEX_NAME
FROM
	INDEX_LIST IL,
	TABLE_LIST TL
WHERE
	IL.TABLE_NAME = TL.TABLE_NAME
),
TAB_COLUMN_LIST AS
(
SELECT 
	DTC.TABLE_NAME, DTC.COLUMN_NAME, DT.NUM_ROWS, DTC.NUM_DISTINCT
FROM
	INDEX_LIST_ALL ILA,
	DBA_TAB_COLUMNS DTC,
	DBA_TABLES DT
WHERE
	DTC.TABLE_NAME = ILA.TABLE_NAME AND
	DT.TABLE_NAME = ILA.TABLE_NAME AND
	DTC.COLUMN_NAME <> 'DIMID'
),
IND_COLUMN_LIST AS
(
SELECT
	DIC.TABLE_NAME, DIC.INDEX_NAME, DIC.COLUMN_NAME, DIC.COLUMN_POSITION
FROM
	INDEX_LIST_ALL ILA,
	DBA_IND_COLUMNS DIC
WHERE
	DIC.INDEX_NAME = ILA.INDEX_NAME
)
SELECT 
	TCL.TABLE_NAME, 
	ICL.INDEX_NAME,
	TCL.NUM_ROWS,
	TCL.NUM_DISTINCT,
	ICL.COLUMN_NAME IND_COL,
	ICL.COLUMN_POSITION IND_COL_POS,
	TCL.COLUMN_NAME TAB_COL,
	RANK() OVER (PARTITION BY TCL.TABLE_NAME ORDER BY TCL.TABLE_NAME, TCL.NUM_DISTINCT DESC) RANK
FROM
	TAB_COLUMN_LIST TCL, 
	IND_COLUMN_LIST ICL
WHERE
	TCL.TABLE_NAME = ICL.TABLE_NAME (+) AND
	TCL.COLUMN_NAME  = ICL.COLUMN_NAME (+)
ORDER BY
	TCL.TABLE_NAME, RANK
)






