SELECT NULL LINE FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT NULL LINE FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT
    'SAP%' OWNER,
    '%' TABLE_NAME,
    100 NUM_LARGEST_TABLES,
    -1 MIN_TOTAL_SIZE_MB,
    16 PX_DEGREE
  FROM
    DUAL
),
TABLE_SIZES AS
( SELECT /*+ MATERIALIZE */
    S.OWNER,
    S.TABLE_NAME,
    S.BYTES
  FROM
  ( SELECT
      OWNER,
      TABLE_NAME,
      SUM(BYTES) BYTES
    FROM
    ( SELECT
        S.OWNER,
        S.SEGMENT_NAME TABLE_NAME,
        S.BYTES
      FROM
        BASIS_INFO BI,
        DBA_SEGMENTS S
      WHERE
        S.OWNER LIKE BI.OWNER AND
        S.SEGMENT_NAME LIKE BI.TABLE_NAME AND
        S.SEGMENT_TYPE LIKE 'TABLE%'
      UNION ALL
      ( SELECT
          I.TABLE_OWNER OWNER,
          I.TABLE_NAME,
          S.BYTES
        FROM
          BASIS_INFO BI,
          DBA_INDEXES I,
          DBA_SEGMENTS S
        WHERE
          I.TABLE_OWNER LIKE BI.OWNER AND
          I.TABLE_NAME LIKE BI.TABLE_NAME AND
          I.OWNER = S.OWNER AND
          I.INDEX_NAME = S.SEGMENT_NAME AND
          S.SEGMENT_TYPE LIKE 'INDEX%'
      )
      UNION ALL
      ( SELECT
          L.OWNER,
          L.TABLE_NAME TABLE_NAME,
          S.BYTES
        FROM
          BASIS_INFO BI,
          DBA_LOBS L,
          DBA_SEGMENTS S
        WHERE
          L.OWNER LIKE BI.OWNER AND
          L.TABLE_NAME LIKE BI.TABLE_NAME AND
          L.OWNER = S.OWNER AND
          L.SEGMENT_NAME = S.SEGMENT_NAME AND
          S.SEGMENT_TYPE LIKE 'LOB%'
      )
    )
    GROUP BY
      OWNER,
      TABLE_NAME
    ORDER BY
      3 DESC
  ) S,
    BASIS_INFO BI
  WHERE
    S.BYTES / 1024 / 1024 >= BI.MIN_TOTAL_SIZE_MB AND
    ( BI.NUM_LARGEST_TABLES = -1 OR ROWNUM <= BI.NUM_LARGEST_TABLES )
),
TABLE_INFO_HELPER AS
( SELECT /*+ MATERIALIZE */
    TS.OWNER,
    TS.TABLE_NAME,
    TS.BYTES,
    NVL(TC.COLUMN_NAME, 'CLIENT INDEPENDENT') COLUMN_NAME
  FROM
    TABLE_SIZES TS,
    DBA_TAB_COLUMNS TC
  WHERE
    TC.OWNER (+) = TS.OWNER AND
    TC.TABLE_NAME (+) = TS.TABLE_NAME AND
    TC.COLUMN_NAME (+) IN ('MANDT', 'MANDANT', 'CLIENT')
),
TABLE_INFO AS
( SELECT /*+ MATERIALIZE */
    TIH.OWNER,
    TIH.TABLE_NAME,
    TIH.BYTES,
    TIH.COLUMN_NAME,
    MIN(NVL(IC.INDEX_NAME, I.INDEX_NAME)) INDEX_NAME
  FROM
    TABLE_INFO_HELPER TIH,
    DBA_IND_COLUMNS IC,
    DBA_INDEXES I
  WHERE
    TIH.OWNER = IC.TABLE_OWNER (+) AND
    TIH.TABLE_NAME = IC.TABLE_NAME (+) AND
    TIH.COLUMN_NAME = IC.COLUMN_NAME (+) AND
    IC.COLUMN_POSITION (+) = 1 AND
    TIH.OWNER = I.TABLE_OWNER (+) AND
    TIH.TABLE_NAME = I.TABLE_NAME (+)
  GROUP BY
    TIH.OWNER,
    TIH.TABLE_NAME,
    TIH.BYTES,
    TIH.COLUMN_NAME
)
SELECT   'SELECT NULL OWNER, NULL TABLE_NAME, NULL TOTAL_SIZE_GB, NULL CLIENT_COLUMN, NULL SIZE_GB_1,' LINE FROM DUAL UNION ALL
( SELECT '  NULL SIZE_GB_2, NULL SIZE_GB_3, NULL SIZE_GB_4, NULL SIZE_GB_5, NULL SIZE_GB_6,' LINE FROM DUAL ) UNION ALL
( SELECT '  NULL SIZE_GB_7, NULL SIZE_GB_8, NULL SIZE_GB_9, NULL SIZE_GB10 FROM DUAL WHERE 1 = 0' FROM DUAL ) UNION ALL
( SELECT 'UNION ALL (' FROM DUAL ) UNION ALL
( SELECT 'SELECT NULL OWNER, NULL TABLE_NAME, NULL TOTAL_SIZE_GB, NULL CLIENT_COLUMN, NULL SIZE_GB_1,' FROM DUAL ) UNION ALL
( SELECT '  NULL SIZE_GB_2, NULL SIZE_GB_3, NULL SIZE_GB_4, NULL SIZE_GB_5, NULL SIZE_GB_6,' LINE FROM DUAL ) UNION ALL
( SELECT '  NULL SIZE_GB_7, NULL SIZE_GB_8, NULL SIZE_GB_9, NULL SIZE_GB10 FROM DUAL WHERE 1 = 0' FROM DUAL ) UNION ALL
( SELECT ') UNION ALL ( SELECT * FROM (' FROM DUAL ) UNION ALL
( SELECT 'WITH CLIENT_TABLE_DISTRIBUTION AS' FROM DUAL ) UNION ALL
( SELECT '( SELECT O OWNER, T TABLE_NAME, C CLIENT, CC CLIENT_COLUMN_NAME, B BYTES, CR CLIENT_ROWS,' FROM DUAL ) UNION ALL
( SELECT '  TR TOTAL_ROWS, CR / TR * B CLIENT_BYTES FROM' FROM DUAL ) UNION ALL
( SELECT '  ( SELECT O, T, C, CC, B, CR, SUM(CR) OVER (PARTITION BY O, T) TR FROM (' FROM DUAL ) UNION ALL
( SELECT LINE FROM
  ( SELECT LINE FROM
    ( SELECT 1 RN, T.OWNER, T.TABLE_NAME, 'SELECT ' || DECODE(PX_DEGREE, 1, NULL, '/*+ INDEX_FFS("' || T.TABLE_NAME || '" "' || T.INDEX_NAME || 
        '") PARALLEL_INDEX("' || T.TABLE_NAME || '" "' || T.INDEX_NAME || '" ' || BI.PX_DEGREE || ') */') LINE FROM BASIS_INFO BI, TABLE_INFO T UNION ALL
      ( SELECT 2 RN, OWNER, TABLE_NAME, '''' || OWNER || ''' O, ''' || TABLE_NAME || ''' T, ' || DECODE(COLUMN_NAME, 'CLIENT INDEPENDENT', '''n/a''', COLUMN_NAME) || 
        ' C, ''' || DECODE(COLUMN_NAME, 'CLIENT INDEPENDENT', 'n/a', COLUMN_NAME) || ''' CC, ' FROM TABLE_INFO ) UNION ALL
      ( SELECT 3 RN, OWNER, TABLE_NAME, BYTES || ' B, COUNT(*) CR FROM "' || OWNER || '"."' || TABLE_NAME || 
        '" GROUP BY ' || DECODE(COLUMN_NAME, 'CLIENT INDEPENDENT', '''n/a''', COLUMN_NAME) || ' UNION ALL' FROM TABLE_INFO )
    ) 
    ORDER BY OWNER, TABLE_NAME, RN
  )
) UNION ALL
( SELECT 'SELECT '' '', '' '', '' '', '' '', 1, 1 FROM DUAL WHERE 1 = 0 )' FROM DUAL ) UNION ALL
( SELECT '  )' FROM DUAL ) UNION ALL
( SELECT '),' FROM DUAL ) UNION ALL
( SELECT 'CLIENT_DISTRIBUTION AS' FROM DUAL ) UNION ALL
( SELECT '( SELECT ROWNUM CLIENT_POS, CLIENT, BYTES FROM' FROM DUAL ) UNION ALL
( SELECT '  ( SELECT CLIENT, SUM(CLIENT_BYTES) BYTES' FROM DUAL ) UNION ALL
( SELECT '    FROM CLIENT_TABLE_DISTRIBUTION' FROM DUAL ) UNION ALL
( SELECT '    GROUP BY CLIENT' FROM DUAL ) UNION ALL
( SELECT '    ORDER BY 2 DESC' FROM DUAL ) UNION ALL
( SELECT '  )' FROM DUAL ) UNION ALL
( SELECT ')' FROM DUAL ) UNION ALL
( SELECT 'SELECT' FROM DUAL ) UNION ALL
( SELECT '  '' '' OWNER,' FROM DUAL ) UNION ALL
( SELECT '  ''CLIENTS'' TABLE_NAME,' FROM DUAL ) UNION ALL
( SELECT '  '' '' TOTAL_SIZE_GB,' FROM DUAL ) UNION ALL
( SELECT '  '' '' CLIENT_COLUMN,' FROM DUAL ) UNION ALL
( SELECT '  LPAD(MAX(DECODE(CLIENT_POS, 1, CLIENT)), 6) SIZE_GB_1,' FROM DUAL ) UNION ALL
( SELECT '  LPAD(MAX(DECODE(CLIENT_POS, 2, CLIENT)), 6) SIZE_GB_2,' FROM DUAL ) UNION ALL
( SELECT '  LPAD(MAX(DECODE(CLIENT_POS, 3, CLIENT)), 6) SIZE_GB_3,' FROM DUAL ) UNION ALL
( SELECT '  LPAD(MAX(DECODE(CLIENT_POS, 4, CLIENT)), 6) SIZE_GB_4,' FROM DUAL ) UNION ALL
( SELECT '  LPAD(MAX(DECODE(CLIENT_POS, 5, CLIENT)), 6) SIZE_GB_5,' FROM DUAL ) UNION ALL
( SELECT '  LPAD(MAX(DECODE(CLIENT_POS, 6, CLIENT)), 6) SIZE_GB_6,' FROM DUAL ) UNION ALL
( SELECT '  LPAD(MAX(DECODE(CLIENT_POS, 7, CLIENT)), 6) SIZE_GB_7,' FROM DUAL ) UNION ALL
( SELECT '  LPAD(MAX(DECODE(CLIENT_POS, 8, CLIENT)), 6) SIZE_GB_8,' FROM DUAL ) UNION ALL
( SELECT '  LPAD(MAX(DECODE(CLIENT_POS, 9, CLIENT)), 6) SIZE_GB_9,' FROM DUAL ) UNION ALL
( SELECT '  LPAD(MAX(DECODE(CLIENT_POS, 10, CLIENT)), 6) SIZE_GB10' FROM DUAL ) UNION ALL
( SELECT 'FROM' FROM DUAL ) UNION ALL
( SELECT '  CLIENT_DISTRIBUTION' FROM DUAL ) UNION ALL
( SELECT 'UNION ALL' FROM DUAL ) UNION ALL
( SELECT '( SELECT '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '' FROM DUAL )' FROM DUAL ) UNION ALL
( SELECT 'UNION ALL' FROM DUAL ) UNION ALL
( SELECT '( SELECT' FROM DUAL ) UNION ALL
( SELECT '    '' '' OWNER,' FROM DUAL ) UNION ALL
( SELECT '    ''TOTAL'' TABLE_NAME,' FROM DUAL ) UNION ALL
( SELECT '    TO_CHAR(SUM(CTD.CLIENT_BYTES / 1024 / 1024 / 1024), 999999990.99) TOTAL_SIZE_GB,' FROM DUAL ) UNION ALL
( SELECT '    '' '' CLIENT_COLUMN,' FROM DUAL ) UNION ALL
( SELECT '    TO_CHAR(SUM(DECODE(CD.CLIENT_POS, 1, CTD.CLIENT_BYTES / 1024 / 1024 / 1024)), 99990.99) SIZE_GB_1,' FROM DUAL ) UNION ALL
( SELECT '    TO_CHAR(SUM(DECODE(CD.CLIENT_POS, 2, CTD.CLIENT_BYTES / 1024 / 1024 / 1024)), 99990.99) SIZE_GB_2,' FROM DUAL ) UNION ALL
( SELECT '    TO_CHAR(SUM(DECODE(CD.CLIENT_POS, 3, CTD.CLIENT_BYTES / 1024 / 1024 / 1024)), 99990.99) SIZE_GB_3,' FROM DUAL ) UNION ALL
( SELECT '    TO_CHAR(SUM(DECODE(CD.CLIENT_POS, 4, CTD.CLIENT_BYTES / 1024 / 1024 / 1024)), 99990.99) SIZE_GB_4,' FROM DUAL ) UNION ALL
( SELECT '    TO_CHAR(SUM(DECODE(CD.CLIENT_POS, 5, CTD.CLIENT_BYTES / 1024 / 1024 / 1024)), 99990.99) SIZE_GB_5,' FROM DUAL ) UNION ALL
( SELECT '    TO_CHAR(SUM(DECODE(CD.CLIENT_POS, 6, CTD.CLIENT_BYTES / 1024 / 1024 / 1024)), 99990.99) SIZE_GB_6,' FROM DUAL ) UNION ALL
( SELECT '    TO_CHAR(SUM(DECODE(CD.CLIENT_POS, 7, CTD.CLIENT_BYTES / 1024 / 1024 / 1024)), 99990.99) SIZE_GB_7,' FROM DUAL ) UNION ALL
( SELECT '    TO_CHAR(SUM(DECODE(CD.CLIENT_POS, 8, CTD.CLIENT_BYTES / 1024 / 1024 / 1024)), 99990.99) SIZE_GB_8,' FROM DUAL ) UNION ALL
( SELECT '    TO_CHAR(SUM(DECODE(CD.CLIENT_POS, 9, CTD.CLIENT_BYTES / 1024 / 1024 / 1024)), 99990.99) SIZE_GB_9,' FROM DUAL ) UNION ALL
( SELECT '    TO_CHAR(SUM(DECODE(CD.CLIENT_POS, 10, CTD.CLIENT_BYTES / 1024 / 1024 / 1024)), 99990.99) SIZE_GB10' FROM DUAL ) UNION ALL
( SELECT '  FROM' FROM DUAL ) UNION ALL
( SELECT '    CLIENT_TABLE_DISTRIBUTION CTD,' FROM DUAL ) UNION ALL
( SELECT '    CLIENT_DISTRIBUTION CD' FROM DUAL ) UNION ALL
( SELECT '  WHERE' FROM DUAL ) UNION ALL
( SELECT '    CTD.CLIENT = CD.CLIENT (+)' FROM DUAL ) UNION ALL
( SELECT ')' FROM DUAL ) UNION ALL
( SELECT 'UNION ALL' FROM DUAL ) UNION ALL
( SELECT '( SELECT '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '' FROM DUAL )' FROM DUAL ) UNION ALL
( SELECT 'UNION ALL' FROM DUAL ) UNION ALL
( SELECT '( SELECT * FROM ' FROM DUAL ) UNION ALL
( SELECT '( SELECT' FROM DUAL ) UNION ALL
( SELECT '    CTD.OWNER, CTD.TABLE_NAME, TO_CHAR(CTD.BYTES / 1024 / 1024 / 1024, 999999990.99) TOTAL_SIZE_GB,' FROM DUAL ) UNION ALL
( SELECT '      CTD.CLIENT_COLUMN_NAME CLIENT_COLUMN,' FROM DUAL ) UNION ALL
( SELECT '    TO_CHAR(SUM(DECODE(CD.CLIENT_POS, 1, CTD.CLIENT_BYTES / 1024 / 1024 / 1024)), 99990.99) SIZE_GB_1,' FROM DUAL ) UNION ALL
( SELECT '    TO_CHAR(SUM(DECODE(CD.CLIENT_POS, 2, CTD.CLIENT_BYTES / 1024 / 1024 / 1024)), 99990.99) SIZE_GB_2,' FROM DUAL ) UNION ALL
( SELECT '    TO_CHAR(SUM(DECODE(CD.CLIENT_POS, 3, CTD.CLIENT_BYTES / 1024 / 1024 / 1024)), 99990.99) SIZE_GB_3,' FROM DUAL ) UNION ALL
( SELECT '    TO_CHAR(SUM(DECODE(CD.CLIENT_POS, 4, CTD.CLIENT_BYTES / 1024 / 1024 / 1024)), 99990.99) SIZE_GB_4,' FROM DUAL ) UNION ALL
( SELECT '    TO_CHAR(SUM(DECODE(CD.CLIENT_POS, 5, CTD.CLIENT_BYTES / 1024 / 1024 / 1024)), 99990.99) SIZE_GB_5,' FROM DUAL ) UNION ALL
( SELECT '    TO_CHAR(SUM(DECODE(CD.CLIENT_POS, 6, CTD.CLIENT_BYTES / 1024 / 1024 / 1024)), 99990.99) SIZE_GB_6,' FROM DUAL ) UNION ALL
( SELECT '    TO_CHAR(SUM(DECODE(CD.CLIENT_POS, 7, CTD.CLIENT_BYTES / 1024 / 1024 / 1024)), 99990.99) SIZE_GB_7,' FROM DUAL ) UNION ALL
( SELECT '    TO_CHAR(SUM(DECODE(CD.CLIENT_POS, 8, CTD.CLIENT_BYTES / 1024 / 1024 / 1024)), 99990.99) SIZE_GB_8,' FROM DUAL ) UNION ALL
( SELECT '    TO_CHAR(SUM(DECODE(CD.CLIENT_POS, 9, CTD.CLIENT_BYTES / 1024 / 1024 / 1024)), 99990.99) SIZE_GB_9,' FROM DUAL ) UNION ALL
( SELECT '    TO_CHAR(SUM(DECODE(CD.CLIENT_POS, 10, CTD.CLIENT_BYTES / 1024 / 1024 / 1024)), 99990.99) SIZE_GB10' FROM DUAL ) UNION ALL
( SELECT '  FROM' FROM DUAL ) UNION ALL
( SELECT '    CLIENT_TABLE_DISTRIBUTION CTD,' FROM DUAL ) UNION ALL
( SELECT '    CLIENT_DISTRIBUTION CD' FROM DUAL ) UNION ALL
( SELECT '  WHERE' FROM DUAL ) UNION ALL
( SELECT '    CTD.CLIENT = CD.CLIENT (+)' FROM DUAL ) UNION ALL
( SELECT '  GROUP BY' FROM DUAL ) UNION ALL
( SELECT '    CTD.OWNER,' FROM DUAL ) UNION ALL
( SELECT '    CTD.TABLE_NAME,' FROM DUAL ) UNION ALL
( SELECT '    CTD.BYTES,' FROM DUAL ) UNION ALL
( SELECT '    CTD.CLIENT_COLUMN_NAME' FROM DUAL ) UNION ALL
( SELECT '  ORDER BY' FROM DUAL ) UNION ALL
( SELECT '    CTD.BYTES DESC, CTD.OWNER, CTD.TABLE_NAME' FROM DUAL ) UNION ALL
( SELECT ')' FROM DUAL ) UNION ALL
( SELECT ')' FROM DUAL ) UNION ALL
( SELECT '));' FROM DUAL )
));


