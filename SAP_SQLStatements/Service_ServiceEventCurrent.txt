SELECT NULL SERVICE_NAME, NULL EVENT, NULL TIME_WAITED_S, NULL TOTAL_WAITS, NULL AVG_WAIT_MS FROM DUAL WHERE 1=0
UNION ALL
(SELECT NULL SERVICE_NAME, NULL EVENT, NULL TIME_WAITED_S, NULL TOTAL_WAITS, NULL AVG_WAIT_MS FROM DUAL WHERE 1=0)
UNION ALL
SELECT * FROM (
SELECT
/*+
	# Top wait event for each service is listed according to total waited time.
	# Change WHERE NUM <= <10> in the bottom to control the number of records to be listed for each service.
	# Wait events are aggregated instance wise because the focus are on service not instance.
*/
	DECODE(SERVICE_NAME,'SYS$BACKGROUND','Oracle BG Workload','SYS$USERS','Non-SAP Workload',SERVICE_NAME) SERVICE_NAME,
	EVENT,
	TO_CHAR(TIME_WAITED_MICRO / 1000000, '99999999990.99') TIME_WAITED_S,
	TOTAL_WAITS,
	TO_CHAR(AVG_WAIT / 1000,'99999990.99') AVG_WAIT_MS
FROM
(	
	SELECT
		SERVICE_NAME,
		EVENT,
		TIME_WAITED_MICRO,
		TOTAL_WAITS,
		AVG_WAIT,
		ROW_NUMBER() OVER (PARTITION BY SERVICE_NAME ORDER BY TIME_WAITED_MICRO DESC) NUM
	FROM
	(
		SELECT
			VSE.SERVICE_NAME,
			VSE.EVENT,
			SUM(VSE.TIME_WAITED_MICRO) TIME_WAITED_MICRO,
			SUM(VSE.TOTAL_WAITS) TOTAL_WAITS,
			DECODE(SUM(VSE.TOTAL_WAITS), 0, -1, SUM(VSE.TIME_WAITED_MICRO) / SUM(VSE.TOTAL_WAITS)) AVG_WAIT
		FROM
			GV$SERVICE_EVENT VSE,
			V$EVENT_NAME VEN
		WHERE
			VSE.EVENT = VEN.NAME AND
			VEN.WAIT_CLASS <> 'Idle' AND
			VEN.WAIT_CLASS <> 'Administrative' AND
			VEN.WAIT_CLASS <> 'System I/O'
		GROUP BY
			VSE.SERVICE_NAME, VSE.EVENT
		UNION ALL
		SELECT
			SERVICE_NAME,
			'CPU' EVENT,
			SUM(VALUE) TIME_WAITED_MICRO,
			NULL TOTAL_WAITS,
			NULL AVG_WAIT
		FROM
			GV$SERVICE_STATS
		WHERE
			STAT_NAME = 'DB CPU'
		GROUP BY
			SERVICE_NAME
		UNION ALL
		SELECT
			SERVICE_NAME,
			'Network' EVENT,
			SUM(VALUE) * 400 TIME_WAITED_MICRO,
			NULL TOTAL_WAITS,
			NULL AVG_WAIT
		FROM
			GV$SERVICE_STATS
		WHERE
			STAT_NAME = 'user calls'
		GROUP BY
			SERVICE_NAME	
	)
)
WHERE NUM <= 10
ORDER BY
	SERVICE_NAME, TIME_WAITED_S DESC
)