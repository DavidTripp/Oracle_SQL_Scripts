SELECT NULL OWNER, NULL TABLE_NAME, NULL BLOCKS, NULL NUM_INDEXES FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT NULL OWNER, NULL TABLE_NAME, NULL BLOCKS, NULL NUM_INDEXES FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT /*+ MATERIALIZE */
    'SAP%' OWNER,
    '%' TABLE_NAME,
    10 MIN_INDEX_THRESHOLD
  FROM
    DUAL
),
TABLES AS
( SELECT /*+ MATERIALIZE */
    T.OWNER,
    T.TABLE_NAME,
    T.BLOCKS
  FROM
    BASIS_INFO BI,
    DBA_TABLES T
  WHERE
    T.OWNER LIKE BI.OWNER AND
    T.TABLE_NAME LIKE BI.TABLE_NAME 
),
INDEXES AS
( SELECT /*+ MATERIALIZE */
    I.OWNER,
    I.TABLE_NAME,
    COUNT(*) NUM_INDEXES
  FROM
    BASIS_INFO BI,
    DBA_INDEXES I
  WHERE
    I.OWNER LIKE BI.OWNER AND
    I.TABLE_NAME LIKE BI.TABLE_NAME
  GROUP BY
    I.OWNER,
    I.TABLE_NAME,
    BI.MIN_INDEX_THRESHOLD
  HAVING
    COUNT(*) > BI.MIN_INDEX_THRESHOLD
)    
SELECT
  T.OWNER,
  T.TABLE_NAME,
  TO_CHAR(T.BLOCKS, 99999990) BLOCKS,
  TO_CHAR(I.NUM_INDEXES, 9999999990) NUM_INDEXES
FROM
  TABLES T,
  INDEXES I
WHERE
  T.OWNER = I.OWNER AND
  T.TABLE_NAME = I.TABLE_NAME 
ORDER BY
  I.NUM_INDEXES DESC,
  T.OWNER,
  T.TABLE_NAME
));
