WITH BASIS_INFO AS
( SELECT /*+ MATERIALIZE */
    DECODE(DBID, -1, OWN_DBID, DBID) DBID,
    DECODE(INSTANCE_NUMBER, -1, USERENV('INSTANCE'), INSTANCE_NUMBER) INSTANCE_NUMBER,
    BEGIN_DATE,
    END_DATE,
    TO_TIMESTAMP(TO_CHAR(BEGIN_DATE, 'dd.mm.yyyy hh24:mi:ss'), 
      'dd.mm.yyyy hh24:mi:ss') BEGIN_TIME,
    TO_TIMESTAMP(TO_CHAR(END_DATE, 'dd.mm.yyyy hh24:mi:ss'), 
      'dd.mm.yyyy hh24:mi:ss') END_TIME,
    DECODE(AGGREGATE_BY,
      'SNAPSHOT',    'YYYY-MM-DD HH24:MI',
      'DAY',         'YYYY-MM-DD (DY)',
      'HOUR_OF_DAY', 'HH24',
      AGGREGATE_BY ) AGGREGATE_BY,
    EXCLUDE_WEEKENDS
	FROM
  ( SELECT
      -1 DBID,
      -3 INSTANCE_NUMBER,          /* -1: current instance, -2: all instances aggregated, -3: all instances individually */
      TO_DATE('01.01.1000 09:07:00', 'dd.mm.yyyy hh24:mi:ss') BEGIN_DATE,
      TO_DATE('31.12.9999 18:05:00', 'dd.mm.yyyy hh24:mi:ss') END_DATE,
      'DAY' AGGREGATE_BY,    /* SNAPSHOT, DAY, HOUR_OF_DAY or Oracle time pattern */
      ' ' EXCLUDE_WEEKENDS
    FROM
      DUAL
  ),
  ( SELECT DBID OWN_DBID FROM V$DATABASE )
),
SNAPSHOTS AS
(
SELECT /*+ MATERIALIZE */ 
    DBID,
    INSTANCE_NUMBER,
    SNAP_ID,
    PREV_SNAP_ID,
    MIN_SNAP_ID,
    BEGIN_INTERVAL_TIME,
    END_INTERVAL_TIME,
    INTERVAL_SECONDS,
    SUM(INTERVAL_SECONDS) OVER () TOTAL_SECONDS,
    RESTART
  FROM
  ( SELECT
      HSS2.DBID,
      HSS2.INSTANCE_NUMBER,
      HSS2.SNAP_ID,
      HSS1.SNAP_ID PREV_SNAP_ID,
      FIRST_VALUE(HSS2.SNAP_ID) OVER (ORDER BY HSS2.SNAP_ID) MIN_SNAP_ID,
      HSS2.BEGIN_INTERVAL_TIME,
      HSS2.END_INTERVAL_TIME,
      TO_CHAR(HSS2.END_INTERVAL_TIME, 'SSSSS') -
        TO_CHAR(HSS2.BEGIN_INTERVAL_TIME, 'SSSSS') +
        86400 * (TO_CHAR(HSS2.END_INTERVAL_TIME, 'J') - 
                 TO_CHAR(HSS2.BEGIN_INTERVAL_TIME, 'J'))
        INTERVAL_SECONDS,
      DECODE(HSS2.STARTUP_TIME, HSS1.STARTUP_TIME, 'NO', 'YES') RESTART
    FROM 
      BASIS_INFO BI,
      DBA_HIST_SNAPSHOT HSS1, 
      DBA_HIST_SNAPSHOT HSS2
    WHERE
      HSS2.DBID = BI.DBID AND
      HSS1.DBID (+) = HSS2.DBID AND
      ( BI.INSTANCE_NUMBER = -2 OR 
        BI.INSTANCE_NUMBER = -3 OR
        HSS2.INSTANCE_NUMBER = BI.INSTANCE_NUMBER
      ) AND
      HSS1.INSTANCE_NUMBER (+) = HSS2.INSTANCE_NUMBER AND
      HSS2.END_INTERVAL_TIME BETWEEN BI.BEGIN_TIME AND BI.END_TIME AND
      HSS1.SNAP_ID (+) = HSS2.SNAP_ID - 1
    ORDER BY
      HSS2.SNAP_ID
  )
),
PING_HELP AS
(
SELECT /*+ MATERIALIZE */ * FROM
(
	SELECT
		BEGIN_INTERVAL_TIME,
		SNAP_ID,
		MIN_SNAP_ID,
		INSTANCE_NUMBER,
		TARGET_INSTANCE,
		CONNECTION,
		DECODE(RESTART,'YES', CNT_500B, 
					CNT_500B - LAG(CNT_500B,1) OVER (PARTITION BY INSTANCE_NUMBER,TARGET_INSTANCE ORDER BY BEGIN_INTERVAL_TIME)) CNT_500B,
		DECODE(RESTART,'YES', WAIT_500B, 
				WAIT_500B - LAG(WAIT_500B,1) OVER (PARTITION BY INSTANCE_NUMBER,TARGET_INSTANCE ORDER BY BEGIN_INTERVAL_TIME)) WAIT_500B,
		DECODE(RESTART,'YES', CNT_8K, 
				CNT_8K - LAG(CNT_8K,1) OVER (PARTITION BY INSTANCE_NUMBER,TARGET_INSTANCE ORDER BY BEGIN_INTERVAL_TIME)) CNT_8K,
		DECODE(RESTART,'YES', WAIT_8K, 
				WAIT_8K - LAG(WAIT_8K,1) OVER (PARTITION BY INSTANCE_NUMBER,TARGET_INSTANCE ORDER BY BEGIN_INTERVAL_TIME)) WAIT_8K
	FROM
	(
		SELECT
			SS.BEGIN_INTERVAL_TIME,
			SS.RESTART,
			SS.SNAP_ID,
			SS.MIN_SNAP_ID,
			TO_CHAR(DHIP.INSTANCE_NUMBER,'9')||'=>'||TO_CHAR(DHIP.TARGET_INSTANCE,'9') CONNECTION,
			DHIP.INSTANCE_NUMBER,
			DHIP.TARGET_INSTANCE,
			DHIP.CNT_500B CNT_500B,
			DHIP.WAIT_500B WAIT_500B,
			DHIP.CNT_8K CNT_8K,
			DHIP.WAIT_8K WAIT_8K
		FROM
			DBA_HIST_INTERCONNECT_PINGS DHIP,
			SNAPSHOTS SS,
			V$ACTIVE_INSTANCES VAI
		WHERE
			DHIP.DBID = SS.DBID AND
			DHIP.SNAP_ID = SS.SNAP_ID AND
			DHIP.INSTANCE_NUMBER = SS.INSTANCE_NUMBER AND
			DHIP.TARGET_INSTANCE = VAI.INST_NUMBER AND
			DHIP.INSTANCE_NUMBER <> DHIP.TARGET_INSTANCE
		ORDER BY
			SS.BEGIN_INTERVAL_TIME,
			DHIP.INSTANCE_NUMBER,
			DHIP.TARGET_INSTANCE
	)
)
WHERE
	SNAP_ID <> MIN_SNAP_ID
ORDER BY
	BEGIN_INTERVAL_TIME,
	INSTANCE_NUMBER,
	TARGET_INSTANCE
)
SELECT
	BEGIN_TIME,
	CONNECTION,
	TO_CHAR(DECODE(SUM(CNT_500B),0,0,SUM(WAIT_500B)/SUM(CNT_500B)/1000),'990.99') LATENCY_500B_MS,
	TO_CHAR(DECODE(SUM(CNT_8K),0,0,SUM(WAIT_8K)/SUM(CNT_8K)/1000),'990.99') LATENCY_8K_MS
FROM
(	SELECT 
		TO_CHAR(PH.BEGIN_INTERVAL_TIME,BI.AGGREGATE_BY) BEGIN_TIME,
		DECODE(BI.INSTANCE_NUMBER, -2, 0, PH.INSTANCE_NUMBER) INSTANCE_NUMBER,
		DECODE(BI.INSTANCE_NUMBER, -2, 'X=>X',PH.CONNECTION) CONNECTION,
		PH.CNT_500B,
		PH.WAIT_500B,
		PH.CNT_8K,
		PH.WAIT_8K
	FROM
		PING_HELP PH,
		BASIS_INFO BI
	WHERE
		 BI.EXCLUDE_WEEKENDS = ' ' OR TO_CHAR(PH.BEGIN_INTERVAL_TIME, 'D') NOT IN (7, 1)
)
GROUP BY 
	BEGIN_TIME,
	INSTANCE_NUMBER,
	CONNECTION
ORDER BY
	BEGIN_TIME,
	INSTANCE_NUMBER,
	CONNECTION