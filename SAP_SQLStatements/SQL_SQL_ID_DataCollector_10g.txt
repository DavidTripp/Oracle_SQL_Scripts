SELECT /*
  SQL_ID DATA COLLECTOR for Oracle 10g
  Description:  Collection of comprehensive information for a SQL statement with a given SQL_ID
  Version:      3.73 (September, 27th 2011)
  Author:       Martin Frauendorfer (SAP Active Global Support)
  Feedback:     martin.frauendorfer@sap.com
  Performance:  Runtime up to 10 minutes is acceptable, in case of longer runtime check the following:
                - Proper Oracle parameters (SAP Note 830576)
                - Current Oracle patches (10.2.0.2: SAP Note 981875; 10.2.0.4: SAP Note 1137346)
                - Existence of DDIC and fixed object statistics (SAP Note 838725)
                - DBA_SEGMENTS optimizations (SAP Note 871455)
                - Exclude output components based on the AREA_ACTIVATION section below
  Restrictions: - Oracle Diagnostics Pack must be licensed
                - In RAC environments only the current instance is taken into account.
  Usage:
    DBACOCKPIT (SQL Command Editor):
      Replace &&sql_id at all locations with the SQL_ID you want to analyze
      Execute
      Choose monospaced output (e.g. "List" -> "Print Preview" or "List Output") for better readability
    SQLPLUS:
      Make sure that client terminal has configured width of >= 250 characters
      sqlplus / as sysdba
      COLUMN PART1 FORMAT A80
      COLUMN PART2 FORMAT A80
      COLUMN PART3 FORMAT A80
      SET LINESIZE 250
      SET PAGESIZE 0
      SET VERIFY OFF
      SPOOL sql.out
      @SQL_SQL_ID_DataCollector_10g.txt
      <sql_id>
      SPOOL OFF
      EXIT
      Display generated text file sql.out
*/
  /*+ OPT_PARAM('_PUSH_JOIN_UNION_VIEW', 'FALSE') OPT_PARAM('_COMPLEX_VIEW_MERGING', 'FALSE') */
  /* _PUSH_JOIN_UNION_VIEW hint is necessary to avoid ORA-00600 [12811] (bug 6408017) */
  /* Both parameter hints can improve the performance of this complex query */
  SUBSTR(LINE, 1, 80) PART1,  SUBSTR(LINE, 81, 80) PART2,
  SUBSTR(LINE, 161, 80) PART3
FROM (
( SELECT NULL LINE FROM DUAL WHERE 1 = 0 )
UNION ALL
( SELECT NULL LINE FROM DUAL WHERE 1 = 0 )
UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT
    '&&sql_id' SQL_ID,
    'X' SEGMENT_INFO,
    ' ' COMPLEX_INDEX_STATS,
    'X' ASH_INFO,
    'X' FRAGMENTATION_INFO,
    'X' VIEW_INFO,
    'X' INDEX_COLUMNS,
    'X' COMPLEX_SQL_TEXT,
    'X' INCLUDE_PREDICATES,
    SYSDATE - 43 AWR_BEGIN_DATE,
    SYSDATE AWR_END_DATE,
    ' ' DEBUGGING_INFO
  FROM
    DUAL 
),
START_STATE AS
( SELECT /*+ MATERIALIZE */
    SES1.VALUE BUFFER_GETS,
    SES2.VALUE DISK_READS,
    L.CTIME SECONDS
  FROM
    V$SYSSTAT SYS1,
    V$SYSSTAT SYS2,
    V$MYSTAT SES1,
    V$MYSTAT SES2,
    ( SELECT CTIME FROM V$LOCK WHERE TYPE = 'MR' AND ROWNUM = 1) L
  WHERE
    SYS1.NAME = 'session logical reads' AND 
    SYS1.STATISTIC# = SES1.STATISTIC# AND
    SYS2.NAME = 'physical reads' AND 
    SYS2.STATISTIC# = SES2.STATISTIC#
),
SNAPSHOTS AS
( SELECT /*+ MATERIALIZE */
    MIN(SS.SNAP_ID) BEGIN_SNAP_ID,
    MIN(SS.BEGIN_INTERVAL_TIME) BEGIN_TIME,
    MAX(SS.SNAP_ID) END_SNAP_ID,
    MAX(SS.END_INTERVAL_TIME) END_TIME,
    SUM(TO_CHAR(SS.END_INTERVAL_TIME, 'SSSSS') -
      TO_CHAR(SS.BEGIN_INTERVAL_TIME, 'SSSSS') +
      86400 * (TO_CHAR(SS.END_INTERVAL_TIME, 'J') - 
               TO_CHAR(SS.BEGIN_INTERVAL_TIME, 'J')))
      SECONDS
  FROM 
    DBA_HIST_SNAPSHOT SS,
    BASIS_INFO BI
  WHERE
    SS.BEGIN_INTERVAL_TIME >= BI.AWR_BEGIN_DATE AND
    SS.END_INTERVAL_TIME <= BI.AWR_END_DATE
),
SQL_TEXT_LOB AS 
( SELECT 
    SS.SQL_FULLTEXT SQL_TEXT,
    DBMS_LOB.GETLENGTH("SQL_FULLTEXT") LENGTH,
    LENGTH(REGEXP_REPLACE(SS.SQL_FULLTEXT, '[^ ]', '')) NUM_BLANKS,
    LENGTH(REGEXP_REPLACE(SS.SQL_FULLTEXT, '[^,]', '')) NUM_COMMA
  FROM
    V$SQLSTATS SS
  WHERE
    SS.SQL_ID = '&&sql_id'
  UNION ALL 
  ( SELECT 
      HST.SQL_TEXT,
      DBMS_LOB.GETLENGTH("SQL_TEXT") LENGTH,
      LENGTH(REGEXP_REPLACE(HST.SQL_TEXT, '[^ ]', '')) NUM_BLANKS,
      LENGTH(REGEXP_REPLACE(HST.SQL_TEXT, '[^,]', '')) NUM_COMMA
    FROM
      DBA_HIST_SQLTEXT HST
    WHERE
      HST.SQL_ID = '&&sql_id' AND
      NOT EXISTS 
      ( SELECT 1 FROM V$SQLSTATS SS WHERE SS.SQL_ID = '&&sql_id' )
  )
),
START_POSITIONS AS
( SELECT /*+ LEADING(AA) */
    DECODE(ROWNUM, 
      1, 1, 
      NUM_BLANKS + 2, LENGTH + 1, 
      DBMS_LOB.INSTR(STL.SQL_TEXT, ' ', 1, ROWNUM - 1) + 1) POS
  FROM
    BASIS_INFO BI,
    SQL_TEXT_LOB STL,
    ( SELECT 1 FROM V$SESSTAT, V$SESSTAT WHERE ROWNUM <= 
      ( SELECT NUM_BLANKS + 2 FROM SQL_TEXT_LOB)
    )
  WHERE
    BI.COMPLEX_SQL_TEXT = 'X'
  UNION
  ( SELECT /*+ LEADING(AA) */
      DECODE(ROWNUM, 
        1, 1, 
        NUM_COMMA + 2, LENGTH + 1, 
        DBMS_LOB.INSTR(STL.SQL_TEXT, ',', 1, ROWNUM - 1) + 1) POS
    FROM
      BASIS_INFO BI,
      SQL_TEXT_LOB STL,
      ( SELECT 1 FROM V$SESSTAT, V$SESSTAT WHERE ROWNUM <= 
        ( SELECT NUM_COMMA + 2 FROM SQL_TEXT_LOB)
      )
    WHERE
      BI.COMPLEX_SQL_TEXT = 'X'
  )
),
START_END_POSITIONS AS
( SELECT 
    POS1,
    NVL(POS2, POS_OVERFLOW) POS2
  FROM
  ( SELECT
      SP1.POS POS1,
      MAX(SP2.POS) POS2,
      MIN(SP3.POS) POS_OVERFLOW
    FROM
      START_POSITIONS SP1,
      START_POSITIONS SP2,
      START_POSITIONS SP3
    WHERE
      SP2.POS (+) BETWEEN SP1.POS + 1 AND SP1.POS + 80 AND
      SP3.POS > SP1.POS
    GROUP BY
      SP1.POS
  )
),
START_END_LINE_POSITIONS AS
( SELECT 
    POS1,
    POS2
  FROM
    START_END_POSITIONS
  START WITH
    POS1 = 1
  CONNECT BY PRIOR 
    POS2 = POS1
  UNION ALL
  ( SELECT
      (R.ROWNUMBER - 1) * 80 + 1 POS1,
      R.ROWNUMBER * 80 + 1 POS2
    FROM
      BASIS_INFO BI,
      SQL_TEXT_LOB STL,
      ( SELECT ROWNUM ROWNUMBER FROM V$SESSTAT WHERE ROWNUM <= 1000 ) R
    WHERE
      BI.COMPLEX_SQL_TEXT = ' ' AND
      R.ROWNUMBER * 80 <= LENGTH(STL.SQL_TEXT) + 80
  )
),
ASH_DISTRIBUTION AS
( SELECT
    SAMPLE_TIME,
    TO_CHAR(SAMPLE_TIME, 'YYYY-MM-DD HH24') HOUR,
    PLAN_HASH_VALUE,
    EVENT,
    WAIT_CLASS,
    OBJECT_NAME,
    SUM(BLOCKS_ACCESSED) BLOCKS_ACCESSED,
    SQL_OPCODE,
    MODULE,
    MOD_ACTION,
    USER_NAME,
    COUNT(*) OCCURRENCES
  FROM
  ( SELECT /*+ LEADING(AA) */ DISTINCT
      DECODE(ASH.SQL_OPCODE, 
        3, ASH.SQL_PLAN_HASH_VALUE, 
        6, ASH.SQL_PLAN_HASH_VALUE, 
        7, ASH.SQL_PLAN_HASH_VALUE, 0) PLAN_HASH_VALUE,
      ASH.SESSION_ID SID,
      ASH.SAMPLE_TIME SAMPLE_TIME,
      DECODE(SESSION_STATE,
        'WAITING', EVENT || DECODE(SUBSTR(EVENT, 1, 5),
        'enq: ', ' (' || TO_CHAR(BITAND(P1, 65535)) || ' / ' ||
        TO_CHAR(DECODE(BITAND(P1, 65535),
          1, 'Null',
          2, 'Sub-Share',
          3, 'Sub-Exclusive',
          4, 'Share',
          5, 'Share/Sub-Exclusive',
          6, 'Exclusive', 'Other')) || ')' ), 'CPU') EVENT,
      ASH.WAIT_CLASS,
      NVL(DECODE(ASH.WAIT_CLASS,
        'Application', NVL(O.OBJECT_NAME, DECODE(ASH.CURRENT_OBJ#, -1, 
        'Header / Rollback / ANALYZE', 0, 'Undo Data', 'not available')),
        'Cluster', NVL(O.OBJECT_NAME, DECODE(ASH.CURRENT_OBJ#, -1, 
        'Header / Rollback / ANALYZE', 0, 'Undo Data', 'not available')),
        'User I/O', DECODE(EVENT, 'direct path read temp', 'not available',
        'direct path write temp', 'not available', 
        'Data file init write', 'not available',
        NVL(O.OBJECT_NAME, DECODE(ASH.CURRENT_OBJ#, -1, 
        'Header / Rollback / ANALYZE', 0, 'Undo Data', NULL))),
        'not available'), 
        DECODE(SSO.OBJECT_NAME, NULL, 'not available',
          SSO.OBJECT_NAME || ' (previous)')) OBJECT_NAME,
      DECODE(ASH.WAIT_CLASS, 'User I/O', P3, 0) BLOCKS_ACCESSED,
      SQL_OPCODE,
      MODULE,
      ACTION MOD_ACTION,
      NVL(DU.USERNAME, 'not available') USER_NAME 
    FROM
      DBA_HIST_ACTIVE_SESS_HISTORY ASH,
      DBA_OBJECTS O,
      DBA_HIST_SEG_STAT_OBJ SSO,
      V$INSTANCE I, 
      DBA_USERS DU,
      BASIS_INFO BI,
      SNAPSHOTS SS
    WHERE
      I.INSTANCE_NUMBER = ASH.INSTANCE_NUMBER AND
      ASH.CURRENT_OBJ# = O.OBJECT_ID (+) AND
      ASH.CURRENT_OBJ# = SSO.OBJ# (+) AND
      ASH.USER_ID = DU.USER_ID (+) AND
      ASH.SQL_ID = BI.SQL_ID AND
      BI.ASH_INFO = 'X' AND
      ASH.SNAP_ID BETWEEN SS.BEGIN_SNAP_ID AND SS.END_SNAP_ID
  )
  GROUP BY
    SAMPLE_TIME,
    TO_CHAR(SAMPLE_TIME, 'YYYY-MM-DD HH24'),
    PLAN_HASH_VALUE,
    EVENT,
    WAIT_CLASS,
    OBJECT_NAME,
    SQL_OPCODE,
    MODULE,
    MOD_ACTION,
    USER_NAME
),
TABLE_INFO AS
( SELECT /*+ MATERIALIZE */ DISTINCT 
    OBJECT_OWNER TABLE_OWNER, 
    OBJECT_NAME TABLE_NAME
  FROM
    BASIS_INFO BI,
    DBA_HIST_SQL_PLAN SP
  WHERE
    SP.SQL_ID = BI.SQL_ID AND
    ( OBJECT_TYPE LIKE '%TABLE%' OR 
      OPERATION = 'DELETE' )
  UNION
  ( SELECT DISTINCT 
      OBJECT_OWNER TABLE_OWNER, 
      OBJECT_NAME TABLE_NAME
    FROM
      BASIS_INFO BI,
      V$SQL_PLAN SP
    WHERE
      SP.SQL_ID = BI.SQL_ID AND
      ( OBJECT_TYPE LIKE '%TABLE%' OR 
        OPERATION = 'DELETE' )
  )
  UNION
  ( SELECT DISTINCT 
      I.TABLE_OWNER TABLE_OWNER, 
      I.TABLE_NAME TABLE_NAME
    FROM 
      BASIS_INFO BI,
      DBA_HIST_SQL_PLAN HSP, 
      DBA_INDEXES I
    WHERE
      HSP.OBJECT_OWNER = I.OWNER AND 
      HSP.OBJECT_NAME = I.INDEX_NAME AND
      HSP.SQL_ID = BI.SQL_ID AND 
      HSP.OBJECT_TYPE LIKE '%INDEX%'
  )
  UNION
  ( SELECT DISTINCT 
      I.TABLE_OWNER TABLE_OWNER, 
      I.TABLE_NAME TABLE_NAME
    FROM 
      BASIS_INFO BI,
      V$SQL_PLAN HSP, 
      DBA_INDEXES I
    WHERE
      HSP.OBJECT_OWNER = I.OWNER AND 
      HSP.OBJECT_NAME = I.INDEX_NAME AND
      HSP.SQL_ID = BI.SQL_ID AND 
      HSP.OBJECT_TYPE LIKE '%INDEX%'
  )
  UNION
  ( SELECT DISTINCT 
      OD.TO_OWNER TABLE_OWNER, 
      OD.TO_NAME TABLE_NAME
    FROM 
      BASIS_INFO BI,
      V$SQL S, 
      V$OBJECT_DEPENDENCY OD
    WHERE
      S.ADDRESS = OD.FROM_ADDRESS AND 
      S.HASH_VALUE = OD.FROM_HASH AND
      S.SQL_ID = BI.SQL_ID AND 
      OD.TO_TYPE = 2
  )
  UNION
  ( SELECT 
      HSS.PARSING_SCHEMA_NAME TABLE_OWNER,
      REGEXP_REPLACE(TO_CHAR(SUBSTR(HST.SQL_TEXT, 1, 200)),
        'INSERT INTO[ "]+([^ "]+)[ "]+.*', '\1', 1, 1, 'i')
        TABLE_NAME
    FROM 
      BASIS_INFO BI,
      DBA_HIST_SQLTEXT HST, 
      DBA_HIST_SQLSTAT HSS, 
      V$INSTANCE I
    WHERE 
      I.INSTANCE_NUMBER = HSS.INSTANCE_NUMBER AND
      HSS.SQL_ID = HST.SQL_ID AND 
      HST.SQL_ID = BI.SQL_ID
  )
  UNION
  ( SELECT 
      REGEXP_REPLACE(TO_CHAR(SUBSTR(HST.SQL_TEXT, 1, 200)),
        'BEGIN DBMS_STATS.*OWNNAME => [''"]+([^''"]+)[''"]+.*', '\1', 1, 1, 'i') TABLE_OWNER,
      REGEXP_REPLACE(TO_CHAR(SUBSTR(HST.SQL_TEXT, 1, 200)),
        'BEGIN DBMS_STATS.*TABNAME => [''"]+([^''"]+)[''"]+.*', '\1', 1, 1, 'i') TABLE_NAME
    FROM
      BASIS_INFO BI,
      DBA_HIST_SQLTEXT HST,
      DBA_HIST_SQLSTAT HSS,
      V$INSTANCE I
    WHERE 
      I.INSTANCE_NUMBER = HSS.INSTANCE_NUMBER AND
      HSS.SQL_ID = HST.SQL_ID AND 
      HST.SQL_ID = BI.SQL_ID
  )
  UNION
  ( SELECT 
      REGEXP_REPLACE(TO_CHAR(SUBSTR(HST.SQL_TEXT, 1, 200)),
        'BEGIN DBMS_REDEFINITION.*UNAME => [''"]+([^''"]+)[''"]+.*', '\1', 1, 1, 'i') TABLE_OWNER,
      REGEXP_REPLACE(TO_CHAR(SUBSTR(HST.SQL_TEXT, 1, 200)),
        'BEGIN DBMS_REDEFINITION.*ORIG_TABLE => [''"]+([^''"]+)[''"]+.*', '\1', 1, 1, 'i') TABLE_NAME
    FROM
      BASIS_INFO BI,
      DBA_HIST_SQLTEXT HST,
      DBA_HIST_SQLSTAT HSS,
      V$INSTANCE I
    WHERE 
      I.INSTANCE_NUMBER = HSS.INSTANCE_NUMBER AND
      HSS.SQL_ID = HST.SQL_ID AND 
      HST.SQL_ID = BI.SQL_ID
  )
),
TABLE_STORAGE AS
( SELECT /*+ MATERIALIZE */
    TI.TABLE_OWNER, 
    TI.TABLE_NAME, 
    NULL PARTITION_NAME, 
    DT.IOT_TYPE,
    NVL(DT.PCT_FREE, 10) PCT_FREE, 
    NVL(DT.INI_TRANS, 1) INI_TRANS,
    DECODE(DT.CLUSTER_NAME, NULL, 'NO', 'YES') CLUSTER_TABLE,
    0 PARTITION_POSITION,
    LTRIM(DT.DEGREE) DEGREE
  FROM 
    DBA_TABLES DT, 
    TABLE_INFO TI
  WHERE 
    TI.TABLE_OWNER = DT.OWNER AND 
   TI.TABLE_NAME = DT.TABLE_NAME
  UNION ALL
  ( SELECT 
      TI.TABLE_OWNER, 
      TI.TABLE_NAME, 
      DTP.PARTITION_NAME, 
      NULL,
      DTP.PCT_FREE, 
      DTP.INI_TRANS,
      DECODE(DT.CLUSTER_NAME, NULL, 'NO', 'YES') CLUSTER_TABLE,
      DTP.PARTITION_POSITION,
      LTRIM(DT.DEGREE) DEGREE
    FROM 
      DBA_TABLES DT,
      DBA_TAB_PARTITIONS DTP, 
      TABLE_INFO TI
    WHERE 
      DT.OWNER = TI.TABLE_OWNER AND  
      DT.TABLE_NAME = TI.TABLE_NAME AND
      TI.TABLE_OWNER = DTP.TABLE_OWNER AND 
      TI.TABLE_NAME = DTP.TABLE_NAME
  )
),
TABLE_MODIFICATIONS AS
( SELECT /*+ MATERIALIZE */
    TI.TABLE_OWNER,
    TI.TABLE_NAME,
    TI.PARTITION_NAME,
    NVL(TM.INSERTS, 0) INSERTS,
    NVL(TM.UPDATES, 0) UPDATES,
    NVL(TM.DELETES, 0) DELETES
  FROM
    TABLE_STORAGE TI,
    ALL_TAB_MODIFICATIONS TM
  WHERE
    TI.TABLE_OWNER = TM.TABLE_OWNER (+) AND
    TI.TABLE_NAME = TM.TABLE_NAME (+) AND
    NVL(TI.PARTITION_NAME, ' ') = NVL(TM.PARTITION_NAME (+), ' ')
),
TABLE_COLUMNS AS
( SELECT /*+ MATERIALIZE */
    TI.TABLE_OWNER,
    TI.TABLE_NAME,
    NVL(DTC.LONG_RAW, 'NO') LONG_RAW,
    NVL(DTC.LOB, 'NO') LOB
  FROM
  ( SELECT
      OWNER, 
      TABLE_NAME, 
      DECODE(SUM(DECODE(DATA_TYPE, 'LONG RAW', 1, 0)), 0, 'NO', 'YES') LONG_RAW,
      DECODE(SUM(DECODE(DATA_TYPE, 'LONG RAW', 0, 1)), 0, 'NO', 'YES') LOB
    FROM
      DBA_TAB_COLS
    WHERE
      DATA_TYPE IN ( 'LONG RAW', 'CLOB', 'BLOB', 'NCLOB' )
    GROUP BY
      OWNER,
      TABLE_NAME
  ) DTC,
    TABLE_INFO TI
  WHERE
    TI.TABLE_OWNER = DTC.OWNER (+) AND
    TI.TABLE_NAME = DTC.TABLE_NAME (+)    
),
INDEX_INFO AS
( SELECT /*+ MATERIALIZE */ DISTINCT 
    T.TABLE_OWNER TABLE_OWNER,
    T.TABLE_NAME TABLE_NAME,
    I.OWNER INDEX_OWNER, 
    I.INDEX_NAME, 
    I.INDEX_TYPE,
    I.UNIQUENESS,
    DECODE(I.COMPRESSION, 'ENABLED', 'YES', 'NO') COMPRESSION,
    NVL(I.PREFIX_LENGTH, 0) PREFIX_LENGTH
  FROM
    DBA_INDEXES I, 
    TABLE_INFO T
  WHERE 
    T.TABLE_OWNER = I.TABLE_OWNER AND
    T.TABLE_NAME = I.TABLE_NAME AND 
    I.INDEX_TYPE != 'LOB'
),
INDEX_STORAGE AS
( SELECT /*+ MATERIALIZE */
    TI.INDEX_OWNER, 
    TI.INDEX_NAME, 
    NULL PARTITION_NAME,
    DT.INDEX_TYPE, 
    NVL(DT.PCT_FREE, 10) PCT_FREE,
    NVL(DT.INI_TRANS, 2) INI_TRANS,
    0 PARTITION_POSITION,
    TI.COMPRESSION,
    TI.PREFIX_LENGTH
  FROM 
    DBA_INDEXES DT, 
    INDEX_INFO TI
  WHERE 
    TI.INDEX_OWNER = DT.OWNER AND 
    TI.INDEX_NAME = DT.INDEX_NAME 
  UNION ALL
  ( SELECT 
      TI.INDEX_OWNER, 
      TI.INDEX_NAME, 
      DTP.PARTITION_NAME,
      TI.INDEX_TYPE, 
      DTP.PCT_FREE, 
      DTP.INI_TRANS,
      DTP.PARTITION_POSITION,
      TI.COMPRESSION,
      TI.PREFIX_LENGTH
    FROM 
      DBA_IND_PARTITIONS DTP, 
      INDEX_INFO TI
    WHERE 
      TI.INDEX_OWNER = DTP.INDEX_OWNER AND 
      TI.INDEX_NAME = DTP.INDEX_NAME
  )
),
INDEX_ROWS_HELPER AS
( SELECT /*+ MATERIALIZE LEADING(AA) */
    IC.TABLE_NAME TABLE_NAME,
    IC.INDEX_NAME INDEX_NAME,
    IC.INDEX_OWNER INDEX_OWNER,
    IC.COLUMN_NAME COLUMN_NAME,
    II.UNIQUENESS,
    II.COMPRESSION,
    II.PREFIX_LENGTH,
    IC.COLUMN_POSITION
  FROM
    INDEX_INFO II,
    DBA_IND_COLUMNS IC,
    BASIS_INFO BI
  WHERE
    BI.SEGMENT_INFO = 'X' AND
    II.INDEX_OWNER = IC.INDEX_OWNER AND
    II.INDEX_NAME = IC.INDEX_NAME
),
INDEX_ROWS AS
( SELECT /*+ MATERIALIZE */
    IR.INDEX_NAME INDEX_NAME,
    IR.INDEX_OWNER INDEX_OWNER,
    SUM(NVL(TC.AVG_COL_LEN, 0) +               /* Length of all indexed columns */
      DECODE(TC.GLOBAL_STATS, 'YES', 0, 1)) +  /* Additional length byte in case of ANALYZE */
      6 +                                      /* ROWID bytes */
      DECODE(IR.UNIQUENESS, 'UNIQUE', 0, 1) +  /* Additional ROWID length byte for NONUNIQUE indexes */
      1 +                                      /* Lock byte */
      1 +                                      /* Flag byte */
      2                                        /* Row directory entry */
      IND_ROW_LEN,
    SUM(DECODE(SIGN(IR.COLUMN_POSITION - IR.PREFIX_LENGTH), 1, 0, 
      NVL(TC.AVG_COL_LEN, 0) + DECODE(TC.GLOBAL_STATS, 'YES', 0, 1))) COMP_ROW_LEN,
    SUM(DECODE(TC.AVG_COL_LEN, NULL, 1, 0)) COL_LEN_NULL,
    SUM(DECODE(IR.COLUMN_POSITION, 1, NVL(TC.NUM_DISTINCT, 0))) FIRST_NUM_DIST
  FROM
    INDEX_ROWS_HELPER IR,
    DBA_TAB_COLS TC
  WHERE
    TC.TABLE_NAME = IR.TABLE_NAME AND
    TC.OWNER = IR.INDEX_OWNER AND
    TC.COLUMN_NAME = IR.COLUMN_NAME 
  GROUP BY
    IR.INDEX_OWNER,
    IR.INDEX_NAME,
    IR.UNIQUENESS
),
INDEX_STATISTICS AS
( SELECT /*+ MATERIALIZE LEADING(AA) */
    /* Simple index statistics without partition, STATTYPE_LOCKED, STALE_STATS */
    DIS.OWNER,
    DIS.INDEX_NAME,
    NULL PARTITION_NAME,
    DIS.TABLE_OWNER,
    DIS.TABLE_NAME,
    DIS.LEAF_BLOCKS,
    DIS.NUM_ROWS,
    DIS.DISTINCT_KEYS,
    DIS.USER_STATS,
    NULL STATTYPE_LOCKED,
    NULL STALE_STATS,
    DIS.LAST_ANALYZED,
    DIS.AVG_LEAF_BLOCKS_PER_KEY
  FROM
    INDEX_INFO II,
    DBA_INDEXES DIS,
    BASIS_INFO BI
  WHERE
    BI.COMPLEX_INDEX_STATS != 'X' AND
    DIS.OWNER = II.INDEX_OWNER AND
    DIS.INDEX_NAME = II.INDEX_NAME 
  UNION ALL
  ( SELECT /*+ MATERIALIZE LEADING(AA) USE_NL(DIS) USE_NL(II) */
      DIS.OWNER,
      DIS.INDEX_NAME,
      DIS.PARTITION_NAME,
      DIS.TABLE_OWNER,
      DIS.TABLE_NAME,
      DIS.LEAF_BLOCKS,
      DIS.NUM_ROWS,
      DIS.DISTINCT_KEYS,
      DIS.USER_STATS,
      DIS.STATTYPE_LOCKED,
      DIS.STALE_STATS,
      DIS.LAST_ANALYZED,
      DIS.AVG_LEAF_BLOCKS_PER_KEY
    FROM
      INDEX_INFO II,
      DBA_IND_STATISTICS DIS,
      BASIS_INFO BI
    WHERE
      BI.COMPLEX_INDEX_STATS = 'X' AND
      DIS.OWNER = II.INDEX_OWNER AND
      DIS.INDEX_NAME = II.INDEX_NAME 
  )
),
SEGMENT_INFO AS
( SELECT
    TABLE_OWNER OWNER,
    TABLE_NAME SEGMENT_NAME,
    'TABLE' SEGMENT_TYPE,
    NULL LOB_TABLE_NAME,
    NULL LOB_COLUMN_NAME
  FROM
    TABLE_INFO
  UNION ALL
  ( SELECT
      INDEX_OWNER OWNER,
      INDEX_NAME SEGMENT_NAME,
      'INDEX' SEGMENT_TYPE,
      NULL LOB_TABLE_NAME,
      NULL LOB_COLUMN_NAME
    FROM
      INDEX_INFO
  )
  UNION ALL
  ( SELECT
      DL.OWNER OWNER,
      DL.SEGMENT_NAME SEGMENT_NAME,
      'LOBSEGMENT' SEGMENT_TYPE,
      DL.TABLE_NAME LOB_TABLE_NAME,
      DL.COLUMN_NAME LOB_COLUMN_NAME
    FROM
      TABLE_INFO TI,
      DBA_LOBS DL
    WHERE
      TI.TABLE_OWNER = DL.OWNER AND
      TI.TABLE_NAME = DL.TABLE_NAME 
  )
  UNION ALL
  ( SELECT
      DL.OWNER OWNER,
      DL.INDEX_NAME SEGMENT_NAME,
      'LOBINDEX' SEGMENT_TYPE,
      DL.TABLE_NAME LOB_TABLE_NAME,
      DL.COLUMN_NAME LOB_COLUMN_NAME
    FROM
      TABLE_INFO TI,
      DBA_LOBS DL
    WHERE
      TI.TABLE_OWNER = DL.OWNER AND
      TI.TABLE_NAME = DL.TABLE_NAME 
  )
),
SEGMENTS AS
( SELECT /*+ MATERIALIZE LEADING(AA) */
    S.OWNER,
    S.SEGMENT_NAME,
    S.PARTITION_NAME,
    S.SEGMENT_TYPE,
    S.TABLESPACE_NAME,
    S.BUFFER_POOL,
    S.BYTES,
    S.EXTENTS,
    S.INITIAL_EXTENT,
    S.NEXT_EXTENT,
    S.MIN_EXTENTS,
    S.MAX_EXTENTS,
    S.FREELISTS,
    S.FREELIST_GROUPS,
    TS.BLOCK_SIZE,
    DECODE(TS.EXTENT_MANAGEMENT, 'DICTIONARY', 'DMTS', 'LMTS') || '/' ||
      SUBSTR(TS.CONTENTS, 1, 1) || 
      DECODE(TS.ALLOCATION_TYPE, 'SYSTEM', ' (SYS)', 'UNIFORM', 
      ' (UNI ' || ROUND(TS.MIN_EXTLEN / 1024 / 1024) || 'M)') ||
      DECODE(TS.SEGMENT_SPACE_MANAGEMENT, 'AUTO', ', ASSM', ', MSSM') TABLESPACE_TYPE,
    TS.EXTENT_MANAGEMENT,
    TS.ALLOCATION_TYPE,
    TS.SEGMENT_SPACE_MANAGEMENT,
    SI.LOB_COLUMN_NAME,
    SI.LOB_TABLE_NAME,
    O.CREATED
  FROM
    BASIS_INFO BI,
    DBA_SEGMENTS S,
    SEGMENT_INFO SI,
    DBA_TABLESPACES TS,
    DBA_OBJECTS O
  WHERE
    BI.SEGMENT_INFO = 'X' AND
    S.SEGMENT_TYPE IN 
    ( 'TABLE', 
      'TABLE PARTITION',
      'INDEX',
      'INDEX PARTITION',
      'LOBSEGMENT',
      'LOBINDEX' 
    ) AND
    S.OWNER = SI.OWNER AND
    S.SEGMENT_NAME = SI.SEGMENT_NAME AND
    S.TABLESPACE_NAME = TS.TABLESPACE_NAME AND
    S.OWNER = O.OWNER (+) AND
    S.SEGMENT_NAME = O.OBJECT_NAME (+) AND
    NVL(S.PARTITION_NAME, ' ') = NVL(O.SUBOBJECT_NAME (+), ' ') 
),
CACHES AS
( SELECT /*+ MATERIALIZE */
    SDC.COMPONENT CACHE_NAME,
    SDC.CURRENT_SIZE / 1024 / 1024 POOL_SIZE_MB,
    DECODE(SDC.COMPONENT, 
      'KEEP buffer cache', 'KEEP',
      'RECYCLE buffer cache', 'RECYCLE',
      'DEFAULT') BUFFER_POOL,
    DECODE(SDC.COMPONENT,
      'DEFAULT 2K buffer cache', 2048,
      'DEFAULT 4K buffer cache', 4096,
      'DEFAULT 8K buffer cache', 8192,
      'DEFAULT 16K buffer cache', 16384,
      'DEFAULT 32K buffer cache', 32768,
      B.VALUE) BLOCK_SIZE
  FROM
    V$SGA_DYNAMIC_COMPONENTS SDC,
    V$PARAMETER B
  WHERE
    SDC.COMPONENT IN
    ( 'DEFAULT buffer cache',
      'KEEP buffer cache',
      'RECYCLE buffer cache',
      'DEFAULT 2K buffer cache',
      'DEFAULT 4K buffer cache',
      'DEFAULT 8K buffer cache',
      'DEFAULT 16K buffer cache',
      'DEFAULT 32K buffer cache'
    ) AND
    B.NAME = 'db_block_size' 
),
BIND_CONTENTS AS
( SELECT /*+ MATERIALIZE */
    CAPTURE_TIME,
    POSITION,
    NAME,
    VALUE_STRING
  FROM
  ( SELECT
      MIN(SNAP_ID) OVER (PARTITION BY LAST_CAPTURED) MIN_SNAP_ID,
      SNAP_ID,
      LAST_CAPTURED CAPTURE_TIME, 
      POSITION, 
      NAME, 
      VALUE_STRING
    FROM 
      BASIS_INFO BI,
      DBA_HIST_SQLBIND HSB,
      SNAPSHOTS SS
    WHERE  
      HSB.SQL_ID = '&&sql_id' AND 
      HSB.SNAP_ID BETWEEN SS.BEGIN_SNAP_ID AND SS.END_SNAP_ID AND
      LAST_CAPTURED IS NOT NULL
  )
  WHERE
    SNAP_ID = MIN_SNAP_ID
),
SQL_SHARED_CURSOR AS
( SELECT
    SUM(DECODE(UNBOUND_CURSOR, 'Y', 1, 0)) UNBOUND_CURSOR,
    SUM(DECODE(SQL_TYPE_MISMATCH, 'Y', 1, 0)) SQL_TYPE_MISMATCH,
    SUM(DECODE(OPTIMIZER_MISMATCH, 'Y', 1, 0)) OPTIMIZER_MISMATCH,
    SUM(DECODE(OUTLINE_MISMATCH, 'Y', 1, 0)) OUTLINE_MISMATCH,
    SUM(DECODE(STATS_ROW_MISMATCH, 'Y', 1, 0)) STATS_ROW_MISMATCH,
    SUM(DECODE(LITERAL_MISMATCH, 'Y', 1, 0)) LITERAL_MISMATCH,
    SUM(DECODE(SEC_DEPTH_MISMATCH, 'Y', 1, 0)) SEC_DEPTH_MISMATCH,
    SUM(DECODE(EXPLAIN_PLAN_CURSOR, 'Y', 1, 0)) EXPLAIN_PLAN_CURSOR,
    SUM(DECODE(BUFFERED_DML_MISMATCH, 'Y', 1, 0)) BUFFERED_DML_MISMATCH,
    SUM(DECODE(PDML_ENV_MISMATCH, 'Y', 1, 0)) PDML_ENV_MISMATCH,
    SUM(DECODE(INST_DRTLD_MISMATCH, 'Y', 1, 0)) INST_DRTLD_MISMATCH,
    SUM(DECODE(SLAVE_QC_MISMATCH, 'Y', 1, 0)) SLAVE_QC_MISMATCH,
    SUM(DECODE(TYPECHECK_MISMATCH, 'Y', 1, 0)) TYPECHECK_MISMATCH,
    SUM(DECODE(AUTH_CHECK_MISMATCH, 'Y', 1, 0)) AUTH_CHECK_MISMATCH,
    SUM(DECODE(BIND_MISMATCH, 'Y', 1, 0)) BIND_MISMATCH,
    SUM(DECODE(DESCRIBE_MISMATCH, 'Y', 1, 0)) DESCRIBE_MISMATCH,
    SUM(DECODE(LANGUAGE_MISMATCH, 'Y', 1, 0)) LANGUAGE_MISMATCH,
    SUM(DECODE(TRANSLATION_MISMATCH, 'Y', 1, 0)) TRANSLATION_MISMATCH,
    SUM(DECODE(ROW_LEVEL_SEC_MISMATCH, 'Y', 1, 0)) ROW_LEVEL_SEC_MISMATCH,
    SUM(DECODE(INSUFF_PRIVS, 'Y', 1, 0)) INSUFF_PRIVS,
    SUM(DECODE(INSUFF_PRIVS_REM, 'Y', 1, 0)) INSUFF_PRIVS_REM,
    SUM(DECODE(REMOTE_TRANS_MISMATCH, 'Y', 1, 0)) REMOTE_TRANS_MISMATCH,
    SUM(DECODE(LOGMINER_SESSION_MISMATCH, 'Y', 1, 0)) LOGMINER_SESSION_MISMATCH,
    SUM(DECODE(INCOMP_LTRL_MISMATCH, 'Y', 1, 0)) INCOMP_LTRL_MISMATCH,
    SUM(DECODE(OVERLAP_TIME_MISMATCH, 'Y', 1, 0)) OVERLAP_TIME_MISMATCH,
    SUM(DECODE(SQL_REDIRECT_MISMATCH, 'Y', 1, 0)) SQL_REDIRECT_MISMATCH,
    SUM(DECODE(MV_QUERY_GEN_MISMATCH, 'Y', 1, 0)) MV_QUERY_GEN_MISMATCH,
    SUM(DECODE(USER_BIND_PEEK_MISMATCH, 'Y', 1, 0)) USER_BIND_PEEK_MISMATCH,
    SUM(DECODE(TYPCHK_DEP_MISMATCH, 'Y', 1, 0)) TYPCHK_DEP_MISMATCH,
    SUM(DECODE(NO_TRIGGER_MISMATCH, 'Y', 1, 0)) NO_TRIGGER_MISMATCH,
    SUM(DECODE(FLASHBACK_CURSOR, 'Y', 1, 0)) FLASHBACK_CURSOR,
    SUM(DECODE(ANYDATA_TRANSFORMATION, 'Y', 1, 0)) ANYDATA_TRANSFORMATION,
    SUM(DECODE(INCOMPLETE_CURSOR, 'Y', 1, 0)) INCOMPLETE_CURSOR,
    SUM(DECODE(TOP_LEVEL_RPI_CURSOR, 'Y', 1, 0)) TOP_LEVEL_RPI_CURSOR,
    SUM(DECODE(DIFFERENT_LONG_LENGTH, 'Y', 1, 0)) DIFFERENT_LONG_LENGTH,
    SUM(DECODE(LOGICAL_STANDBY_APPLY, 'Y', 1, 0)) LOGICAL_STANDBY_APPLY,
    SUM(DECODE(DIFF_CALL_DURN, 'Y', 1, 0)) DIFF_CALL_DURN,
    SUM(DECODE(BIND_UACS_DIFF, 'Y', 1, 0)) BIND_UACS_DIFF,
    SUM(DECODE(PLSQL_CMP_SWITCHS_DIFF, 'Y', 1, 0)) PLSQL_CMP_SWITCHS_DIFF,
    SUM(DECODE(CURSOR_PARTS_MISMATCH, 'Y', 1, 0)) CURSOR_PARTS_MISMATCH,
    SUM(DECODE(STB_OBJECT_MISMATCH, 'Y', 1, 0)) STB_OBJECT_MISMATCH,
    SUM(DECODE(ROW_SHIP_MISMATCH, 'Y', 1, 0)) ROW_SHIP_MISMATCH,
    SUM(DECODE(PQ_SLAVE_MISMATCH, 'Y', 1, 0)) PQ_SLAVE_MISMATCH,
    SUM(DECODE(TOP_LEVEL_DDL_MISMATCH, 'Y', 1, 0)) TOP_LEVEL_DDL_MISMATCH,
    SUM(DECODE(MULTI_PX_MISMATCH, 'Y', 1, 0)) MULTI_PX_MISMATCH,
    SUM(DECODE(BIND_PEEKED_PQ_MISMATCH, 'Y', 1, 0)) BIND_PEEKED_PQ_MISMATCH,
    SUM(DECODE(MV_REWRITE_MISMATCH, 'Y', 1, 0)) MV_REWRITE_MISMATCH,
    SUM(DECODE(ROLL_INVALID_MISMATCH, 'Y', 1, 0)) ROLL_INVALID_MISMATCH,
    SUM(DECODE(OPTIMIZER_MODE_MISMATCH, 'Y', 1, 0)) OPTIMIZER_MODE_MISMATCH,
    SUM(DECODE(PX_MISMATCH, 'Y', 1, 0)) PX_MISMATCH,
    SUM(DECODE(MV_STALEOBJ_MISMATCH, 'Y', 1, 0)) MV_STALEOBJ_MISMATCH,
    SUM(DECODE(FLASHBACK_TABLE_MISMATCH, 'Y', 1, 0)) FLASHBACK_TABLE_MISMATCH,
    SUM(DECODE(LITREP_COMP_MISMATCH, 'Y', 1, 0)) LITREP_COMP_MISMATCH
  FROM
    BASIS_INFO BI,
    V$SQL_SHARED_CURSOR VSC
  WHERE
    VSC.SQL_ID = BI.SQL_ID 
),
DISTINCT_LITERALS AS
( SELECT /*+ MATERIALIZE */
    POSITION, 
    NAME, 
    MIN(VALUE_STRING) EXAMPLE_VALUE,
    COUNT(DISTINCT(VALUE_STRING)) NUM_DISTINCT
  FROM 
    BIND_CONTENTS
  GROUP BY POSITION, NAME
),
SQL_PLANS AS
( SELECT 
    PLAN_HASH_VALUE,
    CHILD_NUMBER,
    ID,
    SQL_ID,
    DEPTH,
    OPTIMIZER,
    OPERATION || DECODE(OPTIONS, NULL, NULL, ' ' || OPTIONS || 
      DECODE(OBJECT_NAME, NULL, NULL, ' (' || OBJECT_NAME || ')')) ACTION_INFO,
    DECODE(INCLUDE_PREDICATES, 'X', 
      DECODE(SOURCE, 'HISTORY', 
        DECODE(SEARCH_COLUMNS, NULL, NULL, 0, NULL, 'Search columns: ' || SEARCH_COLUMNS), 
        NULL),
      DECODE(SEARCH_COLUMNS, NULL, NULL, 0, NULL, 'Search columns: ' || SEARCH_COLUMNS)) SEARCH_COLUMNS_INFO,
    DECODE(INCLUDE_PREDICATES, 'X', DECODE(ACCESS_PREDICATES, NULL, NULL, 
      SUBSTR(ACCESS_PREDICATES, 1, 3000)), NULL) ACCESS_PREDICATE_INFO,
    DECODE(INCLUDE_PREDICATES, 'X', DECODE(FILTER_PREDICATES, NULL, NULL, 
      SUBSTR(FILTER_PREDICATES, 1, 3000)), NULL) FILTER_PREDICATE_INFO,
    DECODE(MEMORY_USED, NULL, NULL, 'PGA space: ' || ROUND(MEMORY_USED / 1024) || ' KB' || 
      DECODE(TEMP_SPACE, NULL, NULL, ', Temp space: ' || ROUND(TEMP_SPACE / 1024) || ' KB')) SPACE_INFO,
    DECODE(PARTITION_START, NULL, NULL, 'Partitions: ' || PARTITION_START || ' - ' || PARTITION_STOP ||
      ', Partition ID: ' || PARTITION_ID) PARTITION_INFO,
    DECODE(PX_DEGREE, NULL, NULL, 1, NULL, 'PX degree: ' || PX_DEGREE) PX_INFO,
    DECODE(COST, NULL, NULL, 'Total costs: ' || TO_CHAR(COST) ) || 
      DECODE(IO_COST, NULL, NULL, ', I/O costs: ' || TO_CHAR(IO_COST) ) || 
      DECODE(COST, NULL, NULL, DECODE(IO_COST, NULL, NULL, ', CPU costs: ' || TO_CHAR(COST - IO_COST) )) || 
      DECODE(CARDINALITY, NULL, NULL, DECODE(IO_COST || COST, NULL, NULL, ', ') || 
      'E-Rows: ' || TO_CHAR(CARDINALITY) ) COST_INFO,
    DECODE(LAST_STARTS, NULL , NULL, 'Starts: ' || LAST_STARTS || ', A-Rows: ' || LAST_OUTPUT_ROWS || ', Gets: ' || LAST_BUFFER_GETS ||
      ', Reads: ' || LAST_DISK_READS || ', Time: ' || LAST_ELAPSED_TIME || ' us') PLAN_STATISTICS_INFO
  FROM 
  ( ( SELECT
        SP.PLAN_HASH_VALUE,
        TO_CHAR(SP.CHILD_NUMBER) CHILD_NUMBER,
        SP.ID,
        SP.SEARCH_COLUMNS,
        SP."DEPTH",
        SP.OPERATION,
        SP.OPTIONS,
        SP.OBJECT_NAME,
        SP.ACCESS_PREDICATES,
        SP.FILTER_PREDICATES,
        SP.TEMP_SPACE,
        SPA.LAST_MEMORY_USED MEMORY_USED,
        SPA.LAST_DEGREE PX_DEGREE,
        SP.PARTITION_START,
        SP.PARTITION_STOP,
        SP.PARTITION_ID,
        SP.COST,
        SP.IO_COST,
        SP.CARDINALITY,
        SPA.LAST_STARTS,
        SPA.LAST_OUTPUT_ROWS,
        SPA.LAST_CR_BUFFER_GETS + SPA.LAST_CU_BUFFER_GETS LAST_BUFFER_GETS,
        SPA.LAST_DISK_READS,
        SPA.LAST_ELAPSED_TIME,
        SP.OPTIMIZER,
        BI.SQL_ID,
        BI.INCLUDE_PREDICATES,
        'CURRENT' SOURCE
      FROM
        V$SQL_PLAN SP, 
        V$SQL_PLAN_STATISTICS_ALL SPA,
        BASIS_INFO BI
      WHERE
        SP.SQL_ID = SPA.SQL_ID (+) AND
        SP.CHILD_NUMBER = SPA.CHILD_NUMBER (+) AND
        SP.ID = SPA.ID (+) AND
        SP.SQL_ID = BI.SQL_ID
    ) 
    UNION 
    ( SELECT
        PLAN_HASH_VALUE,
        'n/a' CHILD_NUMBER,
        ID,
        SEARCH_COLUMNS,
        DEPTH,
        OPERATION,
        OPTIONS,
        OBJECT_NAME,
        ACCESS_PREDICATES,
        FILTER_PREDICATES,
        TEMP_SPACE,
        NULL MEMORY_USED,
        NULL PX_DEGREE,
        PARTITION_START,
        PARTITION_STOP,
        PARTITION_ID,
        COST,
        IO_COST,
        CARDINALITY,
        NULL LAST_STARTS,
        NULL LAST_OUTPUT_ROWS,
        NULL LAST_BUFFER_GETS,
        NULL LAST_DISK_READS,
        NULL LAST_ELAPSED_TIME,
        OPTIMIZER,
        BI.SQL_ID,
        BI.INCLUDE_PREDICATES,
        'HISTORY' SOURCE
      FROM
        DBA_HIST_SQL_PLAN HSP,
        BASIS_INFO BI
      WHERE
        HSP.SQL_ID = BI.SQL_ID AND
        NOT EXISTS 
        ( SELECT 
            1 
          FROM 
            V$SQL_PLAN SP
          WHERE 
            SP.SQL_ID = HSP.SQL_ID AND 
            SP.PLAN_HASH_VALUE = HSP.PLAN_HASH_VALUE
        )
    )
  )
),
PREDICATE_INFOS AS
( SELECT
    'ACCESS' PREDICATE_TYPE,
    PLAN_HASH_VALUE,
    CHILD_NUMBER,
    ID,
    DEPTH, 
    ' Access predicates: ' || ACCESS_PREDICATE_INFO || ' ' PREDICATE_INFO
  FROM
    SQL_PLANS
  WHERE
    ACCESS_PREDICATE_INFO IS NOT NULL
  UNION ALL
  ( SELECT
      'FILTER' PREDICATE_TYPE,
      PLAN_HASH_VALUE,
      CHILD_NUMBER,
      ID,
      DEPTH,
      ' Filter predicates: ' || FILTER_PREDICATE_INFO || ' ' PREDICATE_INFO
    FROM
      SQL_PLANS
    WHERE
      FILTER_PREDICATE_INFO IS NOT NULL
  )
  UNION ALL
  ( SELECT
      'DUMMY' PREDICATE_TYPE,
      123 PLAN_HASH_VALUE,
      '345' CHILD_NUMBER,
      567 ID,
      789 DEPTH,
      ' XXX ' PREDICATE_INFO
    FROM
      DUAL
  )
),
PRED_START_POSITIONS AS
( SELECT
    *
  FROM
  ( SELECT 
      PREDICATE_TYPE,
      PREDICATE_INFO,
      PLAN_HASH_VALUE,
      CHILD_NUMBER,
      ID, 
      INSTR(PREDICATE_INFO, ' ', 1, ROWN) POS
    FROM
      PREDICATE_INFOS PI,
      ( SELECT ROWNUM ROWN FROM V$SESSTAT, V$SESSTAT WHERE ROWNUM <= 1000 ) RN
  )
  WHERE
    POS != 0
),
PRED_START_END_POSITIONS AS
( SELECT /*+ MATERIALIZE */
    PREDICATE_TYPE,
    PREDICATE_INFO,
    PLAN_HASH_VALUE,
    CHILD_NUMBER,
    ID,
    POS1,
    PREDICATE_TYPE || PLAN_HASH_VALUE || CHILD_NUMBER || ID || POS1 CONN_ID1,
    POS2,
    PREDICATE_TYPE || PLAN_HASH_VALUE || CHILD_NUMBER || ID || POS2 CONN_ID2
  FROM
  ( SELECT
      PREDICATE_TYPE,
      PREDICATE_INFO,
      PLAN_HASH_VALUE,
      CHILD_NUMBER,
      ID,
      POS1,
      NVL(POS2, POS_OVERFLOW) POS2
    FROM
    ( SELECT
        SP1.PREDICATE_TYPE,
        SP1.PREDICATE_INFO,
        SP1.PLAN_HASH_VALUE,
        SP1.CHILD_NUMBER,
        SP1.ID,
        SP1.POS POS1,
        MAX(SP2.POS) POS2,
        MIN(SP3.POS) POS_OVERFLOW
      FROM
        BASIS_INFO BI,
        PRED_START_POSITIONS SP1,
        PRED_START_POSITIONS SP2,
        PRED_START_POSITIONS SP3
      WHERE
        SP2.PREDICATE_TYPE (+) = SP1.PREDICATE_TYPE AND
        SP2.PLAN_HASH_VALUE (+) = SP1.PLAN_HASH_VALUE AND
        SP2.CHILD_NUMBER (+) = SP1.CHILD_NUMBER AND
        SP2.ID (+) = SP1.ID AND
        SP2.POS (+) BETWEEN SP1.POS + 1 AND SP1.POS + 80 AND
        SP3.PREDICATE_TYPE = SP1.PREDICATE_TYPE AND
        SP3.PLAN_HASH_VALUE = SP1.PLAN_HASH_VALUE AND
        SP3.CHILD_NUMBER = SP1.CHILD_NUMBER AND
        SP3.ID = SP1.ID AND
        SP3.POS > SP1.POS
      GROUP BY
        SP1.PREDICATE_TYPE,
        SP1.PREDICATE_INFO,
        SP1.PLAN_HASH_VALUE,
        SP1.CHILD_NUMBER,
        SP1.ID,
        SP1.POS
    )
  )  
),
PRED_START_END_LINE_POSITIONS AS
( SELECT /*+ MATERIALIZE */
    PREDICATE_TYPE,
    PREDICATE_INFO,
    PLAN_HASH_VALUE,
    CHILD_NUMBER,
    ID,
    POS1,
    POS2,
    ROW_NUMBER () OVER (ORDER BY POS1) LINE
  FROM
    PRED_START_END_POSITIONS
  START WITH
    POS1 = 1
  CONNECT BY PRIOR 
    CONN_ID2 = CONN_ID1
),
LINES AS
( SELECT 1 NUM, 'ACTION' CONTENT FROM DUAL
  UNION ALL
  SELECT 2 NUM, 'COST' CONTENT FROM DUAL 
  UNION ALL
  SELECT 3 NUM, 'SEARCH COLUMNS' CONTENT FROM DUAL
  UNION ALL
  SELECT 4 NUM, 'ACCESS PREDICATE' CONTENT FROM DUAL
  UNION ALL
  SELECT 5 NUM, 'FILTER PREDICATE' CONTENT FROM DUAL
  UNION ALL
  SELECT 6 NUM, 'SPACE' CONTENT FROM DUAL
  UNION ALL
  SELECT 7 NUM, 'PARTITION' CONTENT FROM DUAL
  UNION ALL
  SELECT 8 NUM, 'PX' CONTENT FROM DUAL
  UNION ALL
  SELECT 9 NUM, 'PLAN STATISTICS' CONTENT FROM DUAL
  UNION ALL
  SELECT 10 NUM, 'EMPTY' CONTENT FROM DUAL
),
SEGMENT_STATISTICS AS
( SELECT
    S.INSTANCE_NUMBER,
    DECODE(NVL(O.OWNER, SSO.OWNER), 
      '** UNAVAILABLE **', NVL(O2.OWNER, S.OBJ# || '/' || S.DATAOBJ#),
      NVL(O.OWNER, NVL(SSO.OWNER, S.OBJ# || '/' || S.DATAOBJ#))) OWNER,
    DECODE(NVL(O.OBJECT_NAME, SSO.OBJECT_NAME), 
      '** UNAVAILABLE **', NVL(O2.OBJECT_NAME, S.OBJ# || '/' || S.DATAOBJ#),
      NVL(O.OBJECT_NAME, NVL(SSO.OBJECT_NAME, S.OBJ# || '/' || S.DATAOBJ#))) SEGMENT_NAME,
    MIN(NVL(O.OBJECT_TYPE, SSO.OBJECT_TYPE)) SEG_TYPE,
    SUM(S.LOGICAL_READS_DELTA) LOGICAL_READS,
    SUM(S.PHYSICAL_READS_DELTA) PHYSICAL_READS,
    SUM(S.DB_BLOCK_CHANGES_DELTA) DB_BLOCK_CHANGES,
    SUM(S.PHYSICAL_WRITES_DELTA) PHYSICAL_WRITES,
    SUM(S.PHYSICAL_READS_DIRECT_DELTA) PHYSICAL_READS_DIRECT,
    SUM(S.PHYSICAL_WRITES_DIRECT_DELTA) PHYSICAL_WRITES_DIRECT,
    SUM(S.BUFFER_BUSY_WAITS_DELTA) BUFFER_BUSY_WAITS,
    SUM(S.ITL_WAITS_DELTA) ITL_WAITS,
    SUM(S.ROW_LOCK_WAITS_DELTA) ROW_LOCK_WAITS,
    SUM(S.TABLE_SCANS_DELTA) SEGMENT_SCANS,
    SUM(S.SPACE_USED_DELTA) / 1024 / 1024 SPACE_USED_DELTA_MB,
    SUM(S.SPACE_ALLOCATED_DELTA) / 1024 / 1024 SPACE_ALLOC_DELTA_MB,
    SUM(S.GC_CR_BLOCKS_SERVED_DELTA) GC_CR_BLOCKS_SERVED_DELTA,
    SUM(S.GC_CU_BLOCKS_SERVED_DELTA) GC_CU_BLOCKS_SERVED_DELTA,
    SUM(S.GC_CR_BLOCKS_RECEIVED_DELTA) GC_CR_BLOCKS_RECEIVED_DELTA,
    SUM(S.GC_CU_BLOCKS_RECEIVED_DELTA) GC_CU_BLOCKS_RECEIVED_DELTA,
    SUM(S.GC_BUFFER_BUSY_DELTA) GC_BUFFER_BUSY_DELTA
  FROM
    V$INSTANCE I,
    SNAPSHOTS SS,
    DBA_HIST_SEG_STAT S,
    DBA_OBJECTS O,
    DBA_HIST_SEG_STAT_OBJ SSO,
    DBA_OBJECTS O2
  WHERE
    S.INSTANCE_NUMBER = I.INSTANCE_NUMBER AND
    S.SNAP_ID BETWEEN SS.BEGIN_SNAP_ID AND SS.END_SNAP_ID AND
    S.OBJ# = O.OBJECT_ID (+) AND
    S.DATAOBJ# = O.DATA_OBJECT_ID (+) AND
    S.OBJ# = SSO.OBJ# (+) AND
    S.DATAOBJ# = SSO.DATAOBJ# (+) AND
    S.OBJ# = O2.OBJECT_ID (+) 
  GROUP BY
    DECODE(NVL(O.OWNER, SSO.OWNER), 
      '** UNAVAILABLE **', NVL(O2.OWNER, S.OBJ# || '/' || S.DATAOBJ#),
      NVL(O.OWNER, NVL(SSO.OWNER, S.OBJ# || '/' || S.DATAOBJ#))),
    DECODE(NVL(O.OBJECT_NAME, SSO.OBJECT_NAME), 
      '** UNAVAILABLE **', NVL(O2.OBJECT_NAME, S.OBJ# || '/' || S.DATAOBJ#),
      NVL(O.OBJECT_NAME, NVL(SSO.OBJECT_NAME, S.OBJ# || '/' || S.DATAOBJ#))),
    S.INSTANCE_NUMBER
)
SELECT
  'DETAIL INFORMATION FOR SQL_ID: ' || SQL_ID LINE
FROM
  BASIS_INFO
UNION ALL
( SELECT
    RPAD('EVALUATION TIME:', 31) || TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') LINE
  FROM DUAL
)
UNION ALL
( SELECT
    RPAD('ANALYSIS INTERVAL:', 31) || 
      TO_CHAR(BEGIN_TIME, 'YYYY-MM-DD HH24:MI:SS') || ' - ' || 
      TO_CHAR(END_TIME, 'YYYY-MM-DD HH24:MI:SS') LINE
  FROM 
    SNAPSHOTS
)
UNION ALL
( SELECT
    RPAD(DECODE(LINE, 1, 'LAST STARTUP TIMES:', ' '), 31) ||
    TO_CHAR(STARTUP_TIME, 'YYYY-MM-DD HH24:MI:SS') LINE
  FROM
  ( SELECT
      ROW_NUMBER () OVER (ORDER BY STARTUP_TIME DESC) LINE,
      STARTUP_TIME
    FROM
     DBA_HIST_DATABASE_INSTANCE
    ORDER BY
      STARTUP_TIME DESC
  )
  WHERE
    ROWNUM <= 5
)
UNION ALL
( SELECT
    RPAD('DATABASE NAME:', 31) || NAME
  FROM
    V$DATABASE
)
UNION ALL
( SELECT
    RPAD('INSTANCE NAME:', 31) || INSTANCE_NAME
  FROM
    V$INSTANCE
)
UNION ALL
( SELECT
    RPAD('VERSION:', 31) || VERSION
  FROM
    V$INSTANCE
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    '### Debugging info ### Elapsed time: ' || ROUND(L.CTIME - STS.SECONDS) ||
    ' s, logical reads: ' || TO_CHAR(SES1.VALUE - STS.BUFFER_GETS) || 
    ', physical reads: ' || TO_CHAR(SES2.VALUE - STS.DISK_READS) LINE
  FROM
    BASIS_INFO BI,
    START_STATE STS,
    V$SYSSTAT SYS1,
    V$SYSSTAT SYS2,
    V$MYSTAT SES1,
    V$MYSTAT SES2,
    ( SELECT CTIME FROM V$LOCK WHERE TYPE = 'MR' AND ROWNUM = 1) L
  WHERE
    BI.DEBUGGING_INFO = 'X' AND
    SYS1.NAME = 'session logical reads' AND 
    SYS1.STATISTIC# = SES1.STATISTIC# AND
    SYS2.NAME = 'physical reads' AND 
    SYS2.STATISTIC# = SES2.STATISTIC#
)
UNION ALL
( SELECT LPAD('*', 240, '*') FROM DUAL )
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    'SQL STATEMENT (V$SQLSTATS, DBA_HIST_SQLTEXT, V$SQL):'
  FROM DUAL )
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    LINE
  FROM
  ( SELECT
      TRANSLATE(DBMS_LOB.SUBSTR(STL.SQL_TEXT, SEP.POS2 - SEP.POS1, SEP.POS1), CHR(10), ' ') LINE
    FROM
      START_END_LINE_POSITIONS SEP, 
      SQL_TEXT_LOB STL
    ORDER BY 
      SEP.POS1
  )
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    '### Debugging info ### Elapsed time: ' || ROUND(L.CTIME - STS.SECONDS) ||
    ' s, logical reads: ' || TO_CHAR(SES1.VALUE - STS.BUFFER_GETS) || 
    ', physical reads: ' || TO_CHAR(SES2.VALUE - STS.DISK_READS) LINE
  FROM
    BASIS_INFO BI,
    START_STATE STS,
    V$SYSSTAT SYS1,
    V$SYSSTAT SYS2,
    V$MYSTAT SES1,
    V$MYSTAT SES2,
    ( SELECT CTIME FROM V$LOCK WHERE TYPE = 'MR' AND ROWNUM = 1) L
  WHERE
    BI.DEBUGGING_INFO = 'X' AND
    SYS1.NAME = 'session logical reads' AND 
    SYS1.STATISTIC# = SES1.STATISTIC# AND
    SYS2.NAME = 'physical reads' AND 
    SYS2.STATISTIC# = SES2.STATISTIC#
)
UNION ALL
( SELECT LPAD('*', 240, '*') FROM DUAL )
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    'SQL CACHE (V$SQLSTATS, DBA_HIST_SQLSTAT):' LINE
  FROM DUAL
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    RPAD('BEGIN_TIME', 19) ||
    LPAD('PLAN_HASH', 11) ||
    LPAD('EXECUTIONS', 11) ||
    LPAD('ELA_TIME_MS', 12) ||
    LPAD('ELA_TIME_MS/EXE', 16) ||
    LPAD('CPU_TIME_MS', 12) ||
    LPAD('RECORDS', 12) ||
    LPAD('REC/EXEC', 12) ||
    LPAD('DISK_READS', 11) ||
    LPAD('DISK_READS/EXE', 15) ||
    LPAD('BUFFER_GETS', 12) ||
    LPAD('BUFFER_GETS/EXE', 16) ||
    LPAD('BUFFER_GETS/REC', 16) ||
    LPAD('PARSE_MS', 12) ||
    LPAD('PARSES', 7) ||
    RPAD(' MODULE', 41) LINE
  FROM
    DUAL
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    RPAD('V$SQL', 19) ||
    LPAD(PLAN_HASH_VALUE, 11) ||
    LPAD(EXECUTIONS, 11) ||
    LPAD(ROUND(ELAPSED_TIME / 1000), 12) ||
    TO_CHAR(DECODE(EXECUTIONS, 0, 0, ROUND(ELAPSED_TIME / 1000 / EXECUTIONS, 
      2)), 999999999990.99) ||
    LPAD(ROUND(CPU_TIME / 1000), 12) ||
    LPAD(ROWS_PROCESSED, 12) ||
    TO_CHAR(DECODE(EXECUTIONS, 0, 0, ROUND(ROWS_PROCESSED / EXECUTIONS, 2)), 
      99999990.99) ||
    LPAD(DISK_READS, 11) ||
    TO_CHAR(DECODE(EXECUTIONS, 0, 0, ROUND(DISK_READS / EXECUTIONS, 2)),  
      99999999990.99) ||
    LPAD(BUFFER_GETS, 12) ||
    TO_CHAR(DECODE(EXECUTIONS, 0, 0, ROUND(BUFFER_GETS / EXECUTIONS, 2)), 
      999999999990.99) ||
    TO_CHAR(DECODE(ROWS_PROCESSED, 0, 0, ROUND(BUFFER_GETS / ROWS_PROCESSED, 
      2)), 999999999990.99) ||
    LPAD('not avail.', 12) ||
    LPAD(PARSE_CALLS, 7) ||
    RPAD(' ' || MODULE, 41) LINE
  FROM
    BASIS_INFO BI,
    V$SQL S
  WHERE
    S.SQL_ID = BI.SQL_ID
)
UNION ALL
( SELECT
    RPAD('V$SQLSTATS', 19) ||
    LPAD(PLAN_HASH_VALUE, 11) ||
    LPAD(EXECUTIONS, 11) ||
    LPAD(ROUND(ELAPSED_TIME / 1000), 12) ||
    TO_CHAR(DECODE(EXECUTIONS, 0, 0, ROUND(ELAPSED_TIME / 1000 / EXECUTIONS, 
      2)), 999999999990.99) ||
    LPAD(ROUND(CPU_TIME / 1000), 12) ||
    LPAD(ROWS_PROCESSED, 12) ||
    TO_CHAR(DECODE(EXECUTIONS, 0, 0, ROUND(ROWS_PROCESSED / EXECUTIONS, 2)), 
      99999990.99) ||
    LPAD(DISK_READS, 11) ||
    TO_CHAR(DECODE(EXECUTIONS, 0, 0, ROUND(DISK_READS / EXECUTIONS, 2)),  
      99999999990.99) ||
    LPAD(BUFFER_GETS, 12) ||
    TO_CHAR(DECODE(EXECUTIONS, 0, 0, ROUND(BUFFER_GETS / EXECUTIONS, 2)), 
      999999999990.99) ||
    TO_CHAR(DECODE(ROWS_PROCESSED, 0, 0, ROUND(BUFFER_GETS / ROWS_PROCESSED, 
      2)), 999999999990.99) ||
    LPAD(ROUND(AVG_HARD_PARSE_TIME / 1000, 2), 12) ||
    LPAD(PARSE_CALLS, 7) ||
    RPAD(' not available in V$SQLSTATS', 41) LINE
  FROM
    BASIS_INFO BI,
    V$SQLSTATS SS
  WHERE
    SS.SQL_ID = BI.SQL_ID
)
UNION ALL
( SELECT
    RPAD(BEGIN_TIME, 19) || 
    LPAD(PLAN_HASH_VALUE, 11) ||
    LPAD(EXECUTIONS, 11) || 
    LPAD(ELAPSED_TIME_MS, 12) || 
    LPAD(ELAPSED_TIME_MS_PER_EXEC, 16) || 
    LPAD(CPU_TIME_MS, 12) ||
    LPAD(RECORDS, 12) ||
    LPAD(RECORDS_PER_EXEC, 12) || 
    LPAD(DISK_READS, 11) || 
    LPAD(DISK_READS_PER_EXEC, 15) ||
    LPAD(BUFFER_GETS, 12) || 
    LPAD(BUFFER_GETS_PER_EXEC, 16) || 
    LPAD(BUFFER_GETS_PER_RECORD, 16) ||
    LPAD(AVG_PARSE, 12) || 
    LPAD(PARSE_CALLS, 7) || 
    RPAD(' ' || MODULE, 41) LINE
  FROM
  ( SELECT
      'TOTAL (HISTORY)' BEGIN_TIME,
      SUM(HSQ.EXECUTIONS_DELTA) EXECUTIONS,
      SUM(HSQ.ROWS_PROCESSED_DELTA) RECORDS,
      TO_CHAR(DECODE(SUM(HSQ.EXECUTIONS_DELTA), 0, 0, SUM(HSQ.ROWS_PROCESSED_DELTA) / 
        SUM(HSQ.EXECUTIONS_DELTA)), 99999990.99) RECORDS_PER_EXEC,
      SUM(HSQ.DISK_READS_DELTA) DISK_READS,
      TO_CHAR(DECODE(SUM(HSQ.EXECUTIONS_DELTA), 0, 0, SUM(HSQ.DISK_READS_DELTA) / 
        SUM(HSQ.EXECUTIONS_DELTA)), 99999999990.99) DISK_READS_PER_EXEC,
      SUM(HSQ.BUFFER_GETS_DELTA) BUFFER_GETS,
      TO_CHAR(DECODE(SUM(HSQ.EXECUTIONS_DELTA), 0, 0, SUM(HSQ.BUFFER_GETS_DELTA) / 
        SUM(HSQ.EXECUTIONS_DELTA)), 999999999990.99) BUFFER_GETS_PER_EXEC,
      TO_CHAR(DECODE(SUM(HSQ.ROWS_PROCESSED_DELTA), 0, 0, SUM(HSQ.BUFFER_GETS_DELTA) / 
        SUM(HSQ.ROWS_PROCESSED_DELTA)), 999999999990.99) BUFFER_GETS_PER_RECORD,
      ROUND(SUM(HSQ.ELAPSED_TIME_DELTA) / 1000) ELAPSED_TIME_MS,
      TO_CHAR(DECODE(SUM(HSQ.EXECUTIONS_DELTA), 0, 0, SUM(HSQ.ELAPSED_TIME_DELTA) / 
        SUM(HSQ.EXECUTIONS_DELTA) / 1000), 999999999990.99) ELAPSED_TIME_MS_PER_EXEC,
      ROUND(SUM(HSQ.CPU_TIME_DELTA) / 1000) CPU_TIME_MS,
      TO_CHAR(DECODE(SUM(HSQ.EXECUTIONS_DELTA), 0, 0, SUM(HSQ.CPU_TIME_DELTA) / 
        SUM(HSQ.EXECUTIONS_DELTA) / 1000), 999999999990.99) CPU_TIME_MS_PER_EXEC,
      'not avail.' AVG_PARSE,  
      HSQ.PLAN_HASH_VALUE,
      SUM(HSQ.PARSE_CALLS_DELTA) PARSE_CALLS, 
      ' ' MODULE
    FROM
      BASIS_INFO BI,
      DBA_HIST_SQLSTAT HSQ, 
      V$INSTANCE I,
      SNAPSHOTS SS
    WHERE
      HSQ.SNAP_ID BETWEEN SS.BEGIN_SNAP_ID AND SS.END_SNAP_ID AND 
      I.INSTANCE_NUMBER = HSQ.INSTANCE_NUMBER AND 
      HSQ.SQL_ID = BI.SQL_ID
    GROUP BY
      HSQ.PLAN_HASH_VALUE
    ORDER BY
      HSQ.PLAN_HASH_VALUE
  )
)
UNION ALL
( SELECT
    RPAD(BEGIN_TIME, 19) || 
    LPAD(PLAN_HASH_VALUE, 11) || 
    LPAD(EXECUTIONS, 11) || 
    LPAD(ELAPSED_TIME_MS, 12) || 
    LPAD(ELAPSED_TIME_MS_PER_EXEC, 16) ||
    LPAD(CPU_TIME_MS, 12) || 
    LPAD(RECORDS, 12) ||
    LPAD(RECORDS_PER_EXEC, 12) || 
    LPAD(DISK_READS, 11) || 
    LPAD(DISK_READS_PER_EXEC, 15) || 
    LPAD(BUFFER_GETS, 12) || 
    LPAD(BUFFER_GETS_PER_EXEC, 16) || 
    LPAD(BUFFER_GETS_PER_RECORD, 16) ||
    LPAD(AVG_PARSE, 12) ||
    LPAD(PARSE_CALLS, 7) || 
    RPAD(' ' || MODULE, 41) LINE
  FROM
  ( SELECT
      TO_CHAR(HSS.BEGIN_INTERVAL_TIME, 'YYYY-MM-DD HH24:MI:SS') BEGIN_TIME,
      NVL(HSQ.EXECUTIONS_DELTA, 0) EXECUTIONS,
      NVL(HSQ.ROWS_PROCESSED_DELTA, 0) RECORDS,
      TO_CHAR(DECODE(NVL(HSQ.EXECUTIONS_DELTA, 0), 0, 0, NVL(HSQ.ROWS_PROCESSED_DELTA, 0) /
        HSQ.EXECUTIONS_DELTA), 99999990.99) RECORDS_PER_EXEC,
      NVL(HSQ.DISK_READS_DELTA, 0) DISK_READS,
      TO_CHAR(DECODE(NVL(HSQ.EXECUTIONS_DELTA, 0), 0, 0, NVL(HSQ.DISK_READS_DELTA, 0) /
        HSQ.EXECUTIONS_DELTA), 99999999990.99) DISK_READS_PER_EXEC,
      NVL(HSQ.BUFFER_GETS_DELTA, 0) BUFFER_GETS,
      TO_CHAR(DECODE(NVL(HSQ.EXECUTIONS_DELTA, 0), 0, 0, NVL(HSQ.BUFFER_GETS_DELTA, 0) /
        HSQ.EXECUTIONS_DELTA), 999999999990.99) BUFFER_GETS_PER_EXEC,
      TO_CHAR(DECODE(NVL(HSQ.ROWS_PROCESSED_DELTA, 0), 0, 0, NVL(HSQ.BUFFER_GETS_DELTA, 0) /
        HSQ.ROWS_PROCESSED_DELTA), 999999999990.99) BUFFER_GETS_PER_RECORD,
      ROUND(NVL(HSQ.ELAPSED_TIME_DELTA, 0) / 1000) ELAPSED_TIME_MS,
      TO_CHAR(DECODE(NVL(HSQ.EXECUTIONS_DELTA, 0), 0, 0, NVL(HSQ.ELAPSED_TIME_DELTA, 0) /
        HSQ.EXECUTIONS_DELTA / 1000), 999999999990.99) ELAPSED_TIME_MS_PER_EXEC,
      ROUND(NVL(HSQ.CPU_TIME_DELTA, 0) / 1000) CPU_TIME_MS,
      TO_CHAR(DECODE(NVL(HSQ.EXECUTIONS_DELTA, 0), 0, 0, NVL(HSQ.CPU_TIME_DELTA, 0) /
        HSQ.EXECUTIONS_DELTA / 1000), 999999999990.99) CPU_TIME_MS_PER_EXEC,
      'not avail.' AVG_PARSE,
      NVL(HSQ.PARSE_CALLS_DELTA, 0) PARSE_CALLS,
      NVL(HSQ.PLAN_HASH_VALUE, 0) PLAN_HASH_VALUE,
      HSQ.MODULE MODULE
    FROM
      BASIS_INFO BI,
      DBA_HIST_SQLSTAT HSQ,
      DBA_HIST_SNAPSHOT HSS,
      SNAPSHOTS SS,
      V$INSTANCE I
    WHERE
      I.INSTANCE_NUMBER = HSQ.INSTANCE_NUMBER AND
      I.INSTANCE_NUMBER = HSS.INSTANCE_NUMBER AND
      HSQ.SNAP_ID BETWEEN SS.BEGIN_SNAP_ID AND SS.END_SNAP_ID AND 
      HSQ.SNAP_ID = HSS.SNAP_ID AND
      HSQ.SQL_ID = BI.SQL_ID
    ORDER BY
      HSQ.SNAP_ID DESC
  )
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    RPAD('SOURCE', 18) || 
    LPAD('PLAN_HASH', 11) || 
    LPAD('CPU_%', 6) || 
    LPAD('USER_IO_%', 10) || 
    LPAD('APPLICATION_%', 14) ||
    LPAD('CONCURRENCY_%', 14) || 
    LPAD('OTHER_%', 8) || 
    LPAD('CLUSTER_%', 10) || 
    LPAD('PLSQL_%', 8) ||
    LPAD('JAVA_%', 7) || 
    LPAD('FETCHES_PER_EXEC', 17) || 
    LPAD('END_OF_FETCH_%', 15) ||
    LPAD('BUFFER_QUALITY_%', 17) || 
    LPAD('DISK_READ_TIME_MS', 18) ||
    LPAD('SHARABLE_MEM_KB', 16) LINE
  FROM DUAL
)
UNION ALL ( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    RPAD('V$SQLSTATS', 18) || 
    LPAD(PLAN_HASH_VALUE, 11) || 
    LPAD("CPU_%", 6) || 
    LPAD("USER_IO_%", 10) || 
    LPAD("APPLICATION_%", 14) ||
    LPAD("CONCURRENCY_%", 14) || 
    LPAD("OTHER_%", 8) || 
    LPAD("CLUSTER_%", 10) || 
    LPAD("PLSQL_%", 8) ||
    LPAD("JAVA_%", 7) || 
    LPAD("FETCHES_PER_EXEC", 17) || 
    LPAD("END_OF_FETCH_%", 15) ||
    LPAD("BUFFER_QUALITY_%", 17) || 
    LPAD("DISK_READ_TIME_MS", 18) ||
    LPAD(TO_CHAR(SHARABLE_MEM / 1024, 999999990.99), 16) LINE
  FROM
  ( SELECT
      ROUND(CPU_TIME / ELAPSED_TIME * 100) "CPU_%",
      ROUND(USER_IO_WAIT_TIME / ELAPSED_TIME * 100) "USER_IO_%",
      ROUND(APPLICATION_WAIT_TIME / ELAPSED_TIME * 100) "APPLICATION_%",
      ROUND(CONCURRENCY_WAIT_TIME / ELAPSED_TIME * 100) "CONCURRENCY_%",
      ROUND((ELAPSED_TIME - CPU_TIME - USER_IO_WAIT_TIME -
        APPLICATION_WAIT_TIME - CONCURRENCY_WAIT_TIME -
        CLUSTER_WAIT_TIME - PLSQL_EXEC_TIME -
        JAVA_EXEC_TIME) / ELAPSED_TIME * 100) "OTHER_%",
      ROUND(CLUSTER_WAIT_TIME / ELAPSED_TIME * 100) "CLUSTER_%",
      ROUND(PLSQL_EXEC_TIME / ELAPSED_TIME * 100) "PLSQL_%",
      ROUND(JAVA_EXEC_TIME / ELAPSED_TIME * 100) "JAVA_%",
      TO_CHAR(DECODE(EXECUTIONS, 0, 0, FETCHES / EXECUTIONS), 9999999999990.99) "FETCHES_PER_EXEC",
      TO_CHAR(DECODE(EXECUTIONS, 0, 0, END_OF_FETCH_COUNT / EXECUTIONS * 100), 9999999990.99) "END_OF_FETCH_%",
      TO_CHAR(DECODE(BUFFER_GETS, 0, 0, (BUFFER_GETS - DISK_READS) / BUFFER_GETS * 100), 
        999999999990.99) "BUFFER_QUALITY_%",
      TO_CHAR(DECODE(DISK_READS, 0, 0, USER_IO_WAIT_TIME / DISK_READS / 1000),
        9999999999990.99) "DISK_READ_TIME_MS",
      SHARABLE_MEM,
      PLAN_HASH_VALUE
    FROM
      BASIS_INFO BI,
      V$SQLSTATS SS
    WHERE 
      SS.SQL_ID = BI.SQL_ID AND 
      ELAPSED_TIME > 0
  )
)
UNION ALL
( SELECT
    RPAD('DBA_HIST_SQLSTAT', 18) || 
    LPAD(PLAN_HASH_VALUE, 11) || 
    LPAD("CPU_%", 6) || 
    LPAD("USER_IO_%", 10) || 
    LPAD("APPLICATION_%", 14) ||
    LPAD("CONCURRENCY_%", 14) || 
    LPAD("OTHER_%", 8) || 
    LPAD("CLUSTER_%", 10) || 
    LPAD("PLSQL_%", 8) ||
    LPAD("JAVA_%", 7) || 
    LPAD("FETCHES_PER_EXEC", 17) || 
    LPAD("END_OF_FETCH_%", 15) ||
    LPAD("BUFFER_QUALITY_%", 17) || 
    LPAD("DISK_READ_TIME_MS", 18) ||
    LPAD(TO_CHAR(SHARABLE_MEM / 1024, 999999990.99), 16) LINE
  FROM
  ( SELECT
      ROUND(CPU_TIME_MS / ELAPSED_TIME_MS * 100) "CPU_%",
      ROUND(USER_IO_TIME_MS / ELAPSED_TIME_MS * 100) "USER_IO_%",
      ROUND(APPLICATION_TIME_MS / ELAPSED_TIME_MS * 100) "APPLICATION_%",
      ROUND(CONCURRENCY_TIME_MS / ELAPSED_TIME_MS * 100) "CONCURRENCY_%",
      ROUND((ELAPSED_TIME_MS - CPU_TIME_MS - USER_IO_TIME_MS -
        APPLICATION_TIME_MS - CONCURRENCY_TIME_MS -
        CLUSTER_TIME_MS - PLSQL_TIME_MS - 
        JAVA_TIME_MS) / ELAPSED_TIME_MS * 100) "OTHER_%",
      ROUND(CLUSTER_TIME_MS / ELAPSED_TIME_MS * 100) "CLUSTER_%",
      ROUND(PLSQL_TIME_MS / ELAPSED_TIME_MS * 100) "PLSQL_%",
      ROUND(JAVA_TIME_MS / ELAPSED_TIME_MS * 100) "JAVA_%",
      TO_CHAR(DECODE(EXECUTIONS, 0, 0, FETCHES / EXECUTIONS), 9999999999990.99) "FETCHES_PER_EXEC",
      TO_CHAR(DECODE(EXECUTIONS, 0, 0, END_OF_FETCH_COUNT / EXECUTIONS * 100), 9999999990.99) "END_OF_FETCH_%",
      TO_CHAR(DECODE(BUFFER_GETS, 0, 0, (BUFFER_GETS - DISK_READS) / BUFFER_GETS * 100), 
        999999999990.99) "BUFFER_QUALITY_%",
      TO_CHAR(DECODE(DISK_READS, 0, 0, USER_IO_TIME_MS / DISK_READS), 
        9999999999990.99) "DISK_READ_TIME_MS",
      SHARABLE_MEM,
      PLAN_HASH_VALUE
    FROM
    ( SELECT
        ROUND(SUM(HSQ.ELAPSED_TIME_DELTA) / 1000) ELAPSED_TIME_MS,
        ROUND(SUM(HSQ.CPU_TIME_DELTA) / 1000) CPU_TIME_MS,
        ROUND(SUM(HSQ.IOWAIT_DELTA) / 1000) USER_IO_TIME_MS,
        ROUND(SUM(HSQ.APWAIT_DELTA) / 1000) APPLICATION_TIME_MS,
        ROUND(SUM(HSQ.CCWAIT_DELTA) / 1000) CONCURRENCY_TIME_MS,
        ROUND(SUM(HSQ.CLWAIT_DELTA) / 1000) CLUSTER_TIME_MS,
        ROUND(SUM(HSQ.PLSEXEC_TIME_DELTA) / 1000) PLSQL_TIME_MS,
        ROUND(SUM(JAVEXEC_TIME_DELTA) / 1000) JAVA_TIME_MS,
        SUM(BUFFER_GETS_DELTA) BUFFER_GETS,
        SUM(DISK_READS_DELTA) DISK_READS,
        SUM(FETCHES_DELTA) FETCHES,
        SUM(END_OF_FETCH_COUNT_DELTA) END_OF_FETCH_COUNT,
        SUM(EXECUTIONS_DELTA) EXECUTIONS,
        MAX(SHARABLE_MEM) SHARABLE_MEM,
        HSQ.PLAN_HASH_VALUE
      FROM
        BASIS_INFO BI,
        DBA_HIST_SQLSTAT HSQ,
        SNAPSHOTS SS,
        V$INSTANCE I
      WHERE
        I.INSTANCE_NUMBER = HSQ.INSTANCE_NUMBER AND
        HSQ.SNAP_ID BETWEEN SS.BEGIN_SNAP_ID AND SS.END_SNAP_ID AND
        HSQ.SQL_ID = BI.SQL_ID
      GROUP BY
        HSQ.PLAN_HASH_VALUE
      ORDER BY
        HSQ.PLAN_HASH_VALUE
    )
    WHERE
      ELAPSED_TIME_MS > 0
  )
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    RPAD('CHILD_CURSOR_REASON', 30) ||
    RPAD('CURSORS_AFFECTED', 16) LINE
  FROM
    DUAL
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    RPAD(NAME, 30) ||
    LPAD(CURSORS_AFFECTED, 16) LINE
  FROM
  ( SELECT 'UNBOUND_CURSOR' NAME, UNBOUND_CURSOR CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'SQL_TYPE_MISMATCH' NAME, SQL_TYPE_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'OPTIMIZER_MISMATCH' NAME, OPTIMIZER_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'OUTLINE_MISMATCH' NAME, OUTLINE_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'STATS_ROW_MISMATCH' NAME, STATS_ROW_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'LITERAL_MISMATCH' NAME, LITERAL_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'SEC_DEPTH_MISMATCH' NAME, SEC_DEPTH_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'EXPLAIN_PLAN_CURSOR' NAME, EXPLAIN_PLAN_CURSOR CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'BUFFERED_DML_MISMATCH' NAME, BUFFERED_DML_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'PDML_ENV_MISMATCH' NAME, PDML_ENV_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'INST_DRTLD_MISMATCH' NAME, INST_DRTLD_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'SLAVE_QC_MISMATCH' NAME, SLAVE_QC_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'TYPECHECK_MISMATCH' NAME, TYPECHECK_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'AUTH_CHECK_MISMATCH' NAME, AUTH_CHECK_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'BIND_MISMATCH' NAME, BIND_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'DESCRIBE_MISMATCH' NAME, DESCRIBE_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'LANGUAGE_MISMATCH' NAME, LANGUAGE_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'TRANSLATION_MISMATCH' NAME, TRANSLATION_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'ROW_LEVEL_SEC_MISMATCH' NAME, ROW_LEVEL_SEC_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR    
    UNION ALL 
    SELECT 'INSUFF_PRIVS' NAME, INSUFF_PRIVS CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'INSUFF_PRIVS_REM' NAME, INSUFF_PRIVS_REM CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'REMOTE_TRANS_MISMATCH' NAME, REMOTE_TRANS_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'LOGMINER_SESSION_MISMATCH' NAME, LOGMINER_SESSION_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'INCOMP_LTRL_MISMATCH' NAME, INCOMP_LTRL_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'OVERLAP_TIME_MISMATCH' NAME, OVERLAP_TIME_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'SQL_REDIRECT_MISMATCH' NAME, SQL_REDIRECT_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'MV_QUERY_GEN_MISMATCH' NAME, MV_QUERY_GEN_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'USER_BIND_PEEK_MISMATCH' NAME, USER_BIND_PEEK_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'TYPCHK_DEP_MISMATCH' NAME, TYPCHK_DEP_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'NO_TRIGGER_MISMATCH' NAME, NO_TRIGGER_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'FLASHBACK_CURSOR' NAME, FLASHBACK_CURSOR CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'ANYDATA_TRANSFORMATION' NAME, ANYDATA_TRANSFORMATION CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'INCOMPLETE_CURSOR' NAME, INCOMPLETE_CURSOR CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'TOP_LEVEL_RPI_CURSOR' NAME, TOP_LEVEL_RPI_CURSOR CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'DIFFERENT_LONG_LENGTH' NAME, DIFFERENT_LONG_LENGTH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'LOGICAL_STANDBY_APPLY' NAME, LOGICAL_STANDBY_APPLY CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'DIFF_CALL_DURN' NAME, DIFF_CALL_DURN CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'BIND_UACS_DIFF' NAME, BIND_UACS_DIFF CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'PLSQL_CMP_SWITCHS_DIFF' NAME, PLSQL_CMP_SWITCHS_DIFF CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'CURSOR_PARTS_MISMATCH' NAME, CURSOR_PARTS_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'STB_OBJECT_MISMATCH' NAME, STB_OBJECT_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'ROW_SHIP_MISMATCH' NAME, ROW_SHIP_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'PQ_SLAVE_MISMATCH' NAME, PQ_SLAVE_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'TOP_LEVEL_DDL_MISMATCH' NAME, TOP_LEVEL_DDL_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'MULTI_PX_MISMATCH' NAME, MULTI_PX_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'BIND_PEEKED_PQ_MISMATCH' NAME, BIND_PEEKED_PQ_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'MV_REWRITE_MISMATCH' NAME, MV_REWRITE_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'ROLL_INVALID_MISMATCH' NAME, ROLL_INVALID_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'OPTIMIZER_MODE_MISMATCH' NAME, OPTIMIZER_MODE_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'PX_MISMATCH' NAME, PX_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'MV_STALEOBJ_MISMATCH' NAME, MV_STALEOBJ_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'FLASHBACK_TABLE_MISMATCH' NAME, FLASHBACK_TABLE_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
    UNION ALL 
    SELECT 'LITREP_COMP_MISMATCH' NAME, LITREP_COMP_MISMATCH CURSORS_AFFECTED FROM SQL_SHARED_CURSOR
  )
  WHERE 
    CURSORS_AFFECTED > 0
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    '### Debugging info ### Elapsed time: ' || ROUND(L.CTIME - STS.SECONDS) ||
    ' s, logical reads: ' || TO_CHAR(SES1.VALUE - STS.BUFFER_GETS) || 
    ', physical reads: ' || TO_CHAR(SES2.VALUE - STS.DISK_READS) LINE
  FROM
    BASIS_INFO BI,
    START_STATE STS,
    V$SYSSTAT SYS1,
    V$SYSSTAT SYS2,
    V$MYSTAT SES1,
    V$MYSTAT SES2,
    ( SELECT CTIME FROM V$LOCK WHERE TYPE = 'MR' AND ROWNUM = 1) L
  WHERE
    BI.DEBUGGING_INFO = 'X' AND
    SYS1.NAME = 'session logical reads' AND 
    SYS1.STATISTIC# = SES1.STATISTIC# AND
    SYS2.NAME = 'physical reads' AND 
    SYS2.STATISTIC# = SES2.STATISTIC#
)
UNION ALL
( SELECT LPAD('*', 240, '*') FROM DUAL )
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    'VIEW DEFINITIONS (V$SQL, V$OBJECT_DEPENDENCY, ' ||
      'DBA_OBJECTS, DBMS_METADATA.GET_DDL), NO SYS* VIEWS, ' ||
      'truncated to 4000 characters:' FROM DUAL
)
UNION ALL
( SELECT '(only available if statement is in V$SQL)' FROM DUAL
)
UNION ALL
( SELECT
    LINE
  FROM
  ( SELECT 
      DECODE(I, 1, ' ',
                2, VIEW_NAME || ':',
                3, ' ',
                TRANSLATE(TRANSLATE(SUBSTR(VIEW_DEFINITION, 1 + (I - 4) * 80,
                  80), CHR(10), ' '), CHR(9), ' ')) LINE
    FROM
    ( SELECT DISTINCT
        OD.TO_NAME VIEW_NAME,
        TO_CHAR(SUBSTR(DBMS_METADATA.GET_DDL('VIEW', OD.TO_NAME, OD.TO_OWNER), 1, 4000))
          VIEW_DEFINITION
      FROM
        V$SQL S, 
        V$OBJECT_DEPENDENCY OD, 
        DBA_OBJECTS O,
        BASIS_INFO BI
      WHERE
        BI.VIEW_INFO = 'X' AND
        S.SQL_ID = BI.SQL_ID AND 
        S.ADDRESS = OD.FROM_ADDRESS AND
        S.HASH_VALUE = OD.FROM_HASH AND 
        OD.TO_OWNER = O.OWNER AND 
        OD.TO_NAME = O.OBJECT_NAME AND 
        O.OBJECT_TYPE = 'VIEW' AND
        OD.TO_OWNER NOT LIKE 'SYS%' ) V,
    ( SELECT ROWNUM I FROM DBA_HIST_SQLTEXT WHERE ROWNUM <= 52 ) C
    WHERE
      DBMS_LOB.GETLENGTH("VIEW_DEFINITION") > (I - 4) * 80
    ORDER BY
      VIEW_NAME,
      I
  )
) 
UNION ALL 
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    '### Debugging info ### Elapsed time: ' || ROUND(L.CTIME - STS.SECONDS) ||
    ' s, logical reads: ' || TO_CHAR(SES1.VALUE - STS.BUFFER_GETS) || 
    ', physical reads: ' || TO_CHAR(SES2.VALUE - STS.DISK_READS) LINE
  FROM
    BASIS_INFO BI,
    START_STATE STS,
    V$SYSSTAT SYS1,
    V$SYSSTAT SYS2,
    V$MYSTAT SES1,
    V$MYSTAT SES2,
    ( SELECT CTIME FROM V$LOCK WHERE TYPE = 'MR' AND ROWNUM = 1) L
  WHERE
    BI.DEBUGGING_INFO = 'X' AND
    SYS1.NAME = 'session logical reads' AND 
    SYS1.STATISTIC# = SES1.STATISTIC# AND
    SYS2.NAME = 'physical reads' AND 
    SYS2.STATISTIC# = SES2.STATISTIC#
)
UNION ALL
( SELECT LPAD('*', 240, '*') FROM DUAL )
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    'EXECUTION PLAN (V$SQL_PLAN, DBA_HIST_SQL_PLAN):' LINE
  FROM DUAL
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    LPAD(ID, 5) ||
    RPAD(' ' || SQL_PLAN_STEP, 230) LINE
  FROM
  ( SELECT
      LPAD(DECODE(L.NUM, 1, TO_CHAR(SP.ID), ' '), 4) ID,
      LPAD(' ', SP.DEPTH * 2) ||
        DECODE(L.CONTENT, 
          'ACTION',           ACTION_INFO || DECODE(SP.ID, 0, 
                              ' (Plan Hash: ' || SP.PLAN_HASH_VALUE || 
                              ', Child: ' || SP.CHILD_NUMBER || 
                              DECODE(OPTIMIZER, NULL, NULL, ', Optimizer: "' || 
                              OPTIMIZER || '"') || ')'),
          'COST',             '  ' || COST_INFO,
          'SEARCH COLUMNS',   '  ' || SEARCH_COLUMNS_INFO,
          'ACCESS PREDICATE', DECODE(PL.POS1, 1, '  ', '    ') || 
                              SUBSTR(PL.PREDICATE_INFO, PL.POS1 + 1, PL.POS2 - PL.POS1),
          'FILTER PREDICATE', DECODE(PL.POS1, 1, '  ', '    ') || 
                              SUBSTR(PL.PREDICATE_INFO, PL.POS1 + 1, PL.POS2 - PL.POS1),
          'SPACE',            '  ' || SPACE_INFO,
          'PARTITION',        '  ' || PARTITION_INFO,
          'PX',               '  ' || PX_INFO,
          'PLAN STATISTICS',  '  ' || PLAN_STATISTICS_INFO,
          'EMPTY',            ' ') SQL_PLAN_STEP
    FROM
      LINES L,
      SQL_PLANS SP,
      PRED_START_END_LINE_POSITIONS PL
    WHERE
      ( L.CONTENT = 'ACTION' AND PL.LINE = 1 OR
        L.CONTENT = 'COST' AND SP.COST_INFO IS NOT NULL AND PL.LINE = 1  OR
        L.CONTENT = 'SEARCH COLUMNS' AND SP.SEARCH_COLUMNS_INFO IS NOT NULL AND PL.LINE = 1 OR
        L.CONTENT = 'ACCESS PREDICATE' AND SP.ACCESS_PREDICATE_INFO IS NOT NULL AND 
          PL.PREDICATE_TYPE = 'ACCESS' AND PL.PLAN_HASH_VALUE = SP.PLAN_HASH_VALUE AND
          PL.CHILD_NUMBER = SP.CHILD_NUMBER AND PL.ID = SP.ID OR
        L.CONTENT = 'FILTER PREDICATE' AND SP.FILTER_PREDICATE_INFO IS NOT NULL AND 
          PL.PREDICATE_TYPE = 'FILTER' AND PL.PLAN_HASH_VALUE = SP.PLAN_HASH_VALUE AND
          PL.CHILD_NUMBER = SP.CHILD_NUMBER AND PL.ID = SP.ID OR
        L.CONTENT = 'SPACE'            AND SP.SPACE_INFO IS NOT NULL AND PL.LINE = 1 OR
        L.CONTENT = 'PARTITION'        AND SP.PARTITION_INFO IS NOT NULL AND PL.LINE = 1 OR
        L.CONTENT = 'PX'               AND SP.PX_INFO IS NOT NULL AND PL.LINE = 1 OR
        L.CONTENT = 'PLAN STATISTICS'  AND SP.PLAN_STATISTICS_INFO IS NOT NULL AND PL.LINE = 1 OR
        L.CONTENT = 'EMPTY' AND PL.LINE = 1
      )
    ORDER BY
      SP.PLAN_HASH_VALUE,
      SP.CHILD_NUMBER,
      SP.ID,
      L.NUM,
      PL.POS1
  )
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    '### Debugging info ### Elapsed time: ' || ROUND(L.CTIME - STS.SECONDS) ||
    ' s, logical reads: ' || TO_CHAR(SES1.VALUE - STS.BUFFER_GETS) || 
    ', physical reads: ' || TO_CHAR(SES2.VALUE - STS.DISK_READS) LINE
  FROM
    BASIS_INFO BI,
    START_STATE STS,
    V$SYSSTAT SYS1,
    V$SYSSTAT SYS2,
    V$MYSTAT SES1,
    V$MYSTAT SES2,
    ( SELECT CTIME FROM V$LOCK WHERE TYPE = 'MR' AND ROWNUM = 1) L
  WHERE
    BI.DEBUGGING_INFO = 'X' AND
    SYS1.NAME = 'session logical reads' AND 
    SYS1.STATISTIC# = SES1.STATISTIC# AND
    SYS2.NAME = 'physical reads' AND 
    SYS2.STATISTIC# = SES2.STATISTIC#
)
UNION ALL
( SELECT LPAD('*', 240, '*') FROM DUAL )
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    'SQL WORKAREAS (V$SQL_WORKAREA):' LINE
  FROM 
    DUAL
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    LPAD('OPERATION_ID ', 13) ||
    RPAD('OPERATION_TYPE', 40) ||
    LPAD('LAST_MEMORY_USED', 17) ||
    LPAD('LAST_TEMPSEG_SIZE', 18) ||
    LPAD('MAX_TEMPSEG_SIZE', 17) ||
    LPAD('OPTIMAL_EXECUTIONS', 19) ||
    LPAD('ONEPASS_EXECUTIONS', 19) ||
    LPAD('MULTIPASSES_EXECUTIONS', 23) LINE
  FROM  
    DUAL
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    LINE
  FROM
  ( SELECT
      LPAD(OPERATION_ID || ' ', 13) ||
      RPAD(OPERATION_TYPE, 40) ||
      LPAD(LAST_MEMORY_USED, 17) ||
      LPAD(NVL(TO_CHAR(LAST_TEMPSEG_SIZE), ' '), 18) ||
      LPAD(NVL(TO_CHAR(MAX_TEMPSEG_SIZE), ' '), 17) ||
      LPAD(OPTIMAL_EXECUTIONS, 19) ||
      LPAD(ONEPASS_EXECUTIONS, 19) ||
      LPAD(MULTIPASSES_EXECUTIONS, 23) LINE
    FROM
      BASIS_INFO BI,
      V$SQL_WORKAREA SWA
    WHERE
      SWA.SQL_ID = BI.SQL_ID 
    ORDER BY
      OPERATION_ID
  )
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    'ACTIVE SQL WORKAREAS (V$SQL_WORKAREA_ACTIVE):' LINE
  FROM DUAL
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    LPAD('OPERATION_ID ', 13) ||
    RPAD('OPERATION_TYPE', 40) ||
    LPAD('MAX_MEMORY_USED', 17) ||
    LPAD('TEMPSEG_SIZE', 18) ||
    LPAD('NUMBER_PASSES', 14) LINE
  FROM DUAL
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    LINE
  FROM
  ( SELECT
      LPAD(OPERATION_ID || ' ', 13) ||
      RPAD(OPERATION_TYPE, 40) ||
      LPAD(MAX_MEM_USED, 17) ||
      LPAD(NVL(TO_CHAR(TEMPSEG_SIZE), ' '), 18) ||
      LPAD(NUMBER_PASSES, 14) LINE
    FROM
      BASIS_INFO BI,
      V$SQL_WORKAREA_ACTIVE SWA
    WHERE
      SWA.SQL_ID = BI.SQL_ID 
    ORDER BY
      OPERATION_ID
  )
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    '### Debugging info ### Elapsed time: ' || ROUND(L.CTIME - STS.SECONDS) ||
    ' s, logical reads: ' || TO_CHAR(SES1.VALUE - STS.BUFFER_GETS) || 
    ', physical reads: ' || TO_CHAR(SES2.VALUE - STS.DISK_READS) LINE
  FROM
    BASIS_INFO BI,
    START_STATE STS,
    V$SYSSTAT SYS1,
    V$SYSSTAT SYS2,
    V$MYSTAT SES1,
    V$MYSTAT SES2,
    ( SELECT CTIME FROM V$LOCK WHERE TYPE = 'MR' AND ROWNUM = 1) L
  WHERE
    BI.DEBUGGING_INFO = 'X' AND
    SYS1.NAME = 'session logical reads' AND 
    SYS1.STATISTIC# = SES1.STATISTIC# AND
    SYS2.NAME = 'physical reads' AND 
    SYS2.STATISTIC# = SES2.STATISTIC#
)
UNION ALL
( SELECT LPAD('*', 240, '*') FROM DUAL )
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    'TEMPORARY SEGMENTS (V$TEMPSEG_USAGE):' LINE
  FROM 
    DUAL
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    RPAD('TABLESPACE_NAME', 32) ||
    RPAD('CONTENTS', 10) ||
    RPAD('SEGTYPE', 10) ||
    LPAD('SIZE_MB', 10) LINE
  FROM  
    DUAL
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    LINE
  FROM
  ( SELECT
      RPAD(TSU.TABLESPACE, 32) ||
      RPAD(TSU.CONTENTS, 10) ||
      RPAD(TSU.SEGTYPE, 10) ||
      TO_CHAR(SUM(TSU.BLOCKS * TS.BLOCK_SIZE) / 1024 / 1024, 999990.99) LINE
    FROM
      BASIS_INFO BI,
      V$TEMPSEG_USAGE TSU,
      DBA_TABLESPACES TS
    WHERE
      TSU.SQL_ID = BI.SQL_ID AND
      TSU.TABLESPACE = TS.TABLESPACE_NAME
    GROUP BY
      TSU.TABLESPACE,
      TSU.CONTENTS,
      TSU.SEGTYPE
    ORDER BY
      SUM(TSU.BLOCKS * TS.BLOCK_SIZE) DESC
  )
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    '### Debugging info ### Elapsed time: ' || ROUND(L.CTIME - STS.SECONDS) ||
    ' s, logical reads: ' || TO_CHAR(SES1.VALUE - STS.BUFFER_GETS) || 
    ', physical reads: ' || TO_CHAR(SES2.VALUE - STS.DISK_READS) LINE
  FROM
    BASIS_INFO BI,
    START_STATE STS,
    V$SYSSTAT SYS1,
    V$SYSSTAT SYS2,
    V$MYSTAT SES1,
    V$MYSTAT SES2,
    ( SELECT CTIME FROM V$LOCK WHERE TYPE = 'MR' AND ROWNUM = 1) L
  WHERE
    BI.DEBUGGING_INFO = 'X' AND
    SYS1.NAME = 'session logical reads' AND 
    SYS1.STATISTIC# = SES1.STATISTIC# AND
    SYS2.NAME = 'physical reads' AND 
    SYS2.STATISTIC# = SES2.STATISTIC#
)
UNION ALL
( SELECT LPAD('*', 240, '*') FROM DUAL )
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    'SQL INFO, TIMED EVENTS AND ACCESSED SEGMENTS (DBA_HIST_ACTIVE_SESS_HISTORY):' LINE
  FROM DUAL
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    LINE
  FROM
  ( SELECT
      RPAD('USER_NAME', 30) ||
      RPAD('SQL_TYPE', 30) ||
      RPAD('MODULE', 50) ||
      RPAD('MOD_ACTION', 30) LINE
    FROM DUAL
    UNION ALL
    ( SELECT  ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        RPAD(ASH.USER_NAME, 30) ||
        RPAD(A.NAME, 30) ||
        RPAD(ASH.MODULE, 50) ||
        RPAD(ASH.MOD_ACTION, 30) LINE
      FROM 
        ASH_DISTRIBUTION ASH, 
        AUDIT_ACTIONS A
      WHERE 
        ASH.SQL_OPCODE = A.ACTION AND 
        ROWNUM = 1
    )
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        LPAD('AVG_CONCURRENT_EXECUTIONS', 26) ||
        LPAD('MAX_CONCURRENT_EXECUTIONS', 26) LINE
      FROM
        DUAL
    )
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        LPAD(TO_CHAR(AVG(SUM(OCCURRENCES)), 999999990.99), 26) ||
        LPAD(TO_CHAR(MAX(SUM(OCCURRENCES)), 999999990), 26) LINE
      FROM
        ASH_DISTRIBUTION
      GROUP BY
        SAMPLE_TIME
    )
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        RPAD('PLAN_HASH', 11) ||
        RPAD('SEGMENT_NAME', 35) ||
        LPAD('SAMPLES', 12) ||
        LPAD('PLAN_PCT', 9) ||
        LPAD('TOTAL_PCT', 10) LINE
      FROM
        DUAL
    )
    UNION ALL
    ( SELECT  ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        LINE
      FROM
      ( SELECT
          RPAD(PLAN_HASH_VALUE, 11) ||
          RPAD(OBJECT_NAME, 35) ||
          LPAD(SUM(OCCURRENCES), 12) ||
          TO_CHAR(RATIO_TO_REPORT(SUM(OCCURRENCES)) OVER (PARTITION BY PLAN_HASH_VALUE) * 100, 99990.99) ||
          TO_CHAR(RATIO_TO_REPORT(SUM(OCCURRENCES)) OVER () * 100, 999990.99) LINE
        FROM
          ASH_DISTRIBUTION
        GROUP BY
          PLAN_HASH_VALUE,
          OBJECT_NAME
        ORDER BY
          PLAN_HASH_VALUE,
          SUM(OCCURRENCES) DESC
      )
    )
    UNION ALL
    ( SELECT  ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        RPAD('PLAN_HASH', 11) ||
        RPAD('EVENT', 50) ||
        LPAD('SAMPLES', 12) ||
        LPAD('PLAN_PCT', 9) ||
        LPAD('TOTAL_PCT', 10) LINE
      FROM DUAL
    )
    UNION ALL
    ( SELECT  ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        LINE
      FROM
      ( SELECT
          RPAD(PLAN_HASH_VALUE, 11) ||
          RPAD(EVENT, 50) ||
          LPAD(SUM(OCCURRENCES), 12) ||
          TO_CHAR(RATIO_TO_REPORT(SUM(OCCURRENCES)) OVER (PARTITION BY PLAN_HASH_VALUE) * 100, 99990.99) ||
          TO_CHAR(RATIO_TO_REPORT(SUM(OCCURRENCES)) OVER () * 100, 999990.99) LINE
        FROM
          ASH_DISTRIBUTION
        GROUP BY
          PLAN_HASH_VALUE,
          EVENT
        ORDER BY
          PLAN_HASH_VALUE,
          SUM(OCCURRENCES) DESC
      )
    )
    UNION ALL
    ( SELECT  ' ' FROM DUAL )
    UNION ALL  
    ( SELECT
        RPAD('PLAN_HASH', 11) ||
        RPAD('SEGMENT_NAME', 35) ||
        RPAD('EVENT', 50) ||
        LPAD('SAMPLES', 12) ||
        LPAD('PLAN_PCT', 9) ||
        LPAD('TOTAL_PCT', 10) ||
        LPAD('BLOCKS_PER_WAIT', 16) LINE
      FROM DUAL
    )
    UNION ALL
    ( SELECT  ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        LINE
      FROM
      ( SELECT
          RPAD(PLAN_HASH_VALUE, 11) ||
          RPAD(OBJECT_NAME, 35) ||
          RPAD(EVENT, 50) ||
          LPAD(SUM(OCCURRENCES), 12) ||
          TO_CHAR(RATIO_TO_REPORT(SUM(OCCURRENCES)) OVER (PARTITION BY PLAN_HASH_VALUE) * 100, 99990.99) ||
          TO_CHAR(RATIO_TO_REPORT(SUM(OCCURRENCES)) OVER () * 100, 999990.99) ||
          DECODE(WAIT_CLASS, 'User I/O', DECODE(EVENT, 'Data file init write', ' ',
            TO_CHAR(SUM(BLOCKS_ACCESSED) / SUM(OCCURRENCES), 999999999990.99)), ' ') LINE
        FROM
          ASH_DISTRIBUTION
        GROUP BY
          PLAN_HASH_VALUE,
          EVENT,
          WAIT_CLASS,
          OBJECT_NAME
        ORDER BY
          PLAN_HASH_VALUE,
          SUM(OCCURRENCES) DESC
      )
    )
  )
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT LPAD('*', 240, '*') FROM DUAL )
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    'TOP HOURS (DBA_HIST_ACTIVE_SESS_HISTORY):' LINE
  FROM DUAL
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    RPAD('PLAN_HASH', 11) ||
    RPAD('HOUR', 20) ||
    LPAD('PLAN_PCT', 9) ||
    LPAD('TOTAL_PCT', 10) LINE
  FROM DUAL
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    LINE
  FROM
  ( SELECT
      RPAD(PLAN_HASH_VALUE, 11) ||
      RPAD(HOUR || ':00:00', 20) ||
      TO_CHAR(PLAN_PCT, 99990.99) ||
      TO_CHAR(TOTAL_PCT, 999990.99) LINE
    FROM
    ( SELECT
        PLAN_HASH_VALUE,
        HOUR,
        RATIO_TO_REPORT(SUM(OCCURRENCES)) OVER (PARTITION BY PLAN_HASH_VALUE) * 100 PLAN_PCT,
        RATIO_TO_REPORT(SUM(OCCURRENCES)) OVER () * 100 TOTAL_PCT
      FROM
        ASH_DISTRIBUTION
      GROUP BY
        PLAN_HASH_VALUE,
        HOUR
    )
    WHERE
      TOTAL_PCT >= 2
    ORDER BY 
      PLAN_HASH_VALUE,
      PLAN_PCT DESC
  )
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    '### Debugging info ### Elapsed time: ' || ROUND(L.CTIME - STS.SECONDS) ||
    ' s, logical reads: ' || TO_CHAR(SES1.VALUE - STS.BUFFER_GETS) || 
    ', physical reads: ' || TO_CHAR(SES2.VALUE - STS.DISK_READS) LINE
  FROM
    BASIS_INFO BI,
    START_STATE STS,
    V$SYSSTAT SYS1,
    V$SYSSTAT SYS2,
    V$MYSTAT SES1,
    V$MYSTAT SES2,
    ( SELECT CTIME FROM V$LOCK WHERE TYPE = 'MR' AND ROWNUM = 1) L
  WHERE
    BI.DEBUGGING_INFO = 'X' AND
    SYS1.NAME = 'session logical reads' AND 
    SYS1.STATISTIC# = SES1.STATISTIC# AND
    SYS2.NAME = 'physical reads' AND 
    SYS2.STATISTIC# = SES2.STATISTIC#
)
UNION ALL
( SELECT LPAD('*', 240, '*') FROM DUAL )
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    LINE
  FROM
  ( ( SELECT
        'SEGMENT STATISTICS (V$SEGMENT_STATISTICS):' LINE
      FROM DUAL
    )
    UNION ALL
    ( SELECT  ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        RPAD('SEGMENT_NAME', 35) || LPAD('LOG_READS', 12) || LPAD('PHYS_READS', 12) ||
        LPAD('DIR_READS', 12) || LPAD('PHYS_WRITES', 12) || LPAD('DIR_WRITES', 12) ||
        LPAD('ITL_WAITS', 12) || LPAD('ROW_LOCKS', 12) || LPAD('BUFFER_BUSY', 12) ||
        LPAD('BLK_CHANGES', 12) || LPAD('SEGMENT_SCANS', 14) LINE
      FROM DUAL
    )
    UNION ALL
    ( SELECT  ' ' FROM DUAL )
    UNION ALL
    ( SELECT * FROM
      ( SELECT
          RPAD(O.OBJECT_NAME, 35) ||
          LPAD(SUM(DECODE(STATISTIC_NAME, 'logical reads', VALUE, 0)), 12) ||
          LPAD(SUM(DECODE(STATISTIC_NAME, 'physical reads', VALUE, 0)), 12) ||
          LPAD(SUM(DECODE(STATISTIC_NAME, 'physical reads direct', VALUE, 0)), 12) ||
          LPAD(SUM(DECODE(STATISTIC_NAME, 'physical writes', VALUE, 0)), 12) ||
          LPAD(SUM(DECODE(STATISTIC_NAME, 'physical writes direct', VALUE, 0)), 12) ||
          LPAD(SUM(DECODE(STATISTIC_NAME, 'ITL waits', VALUE, 0)), 12) ||
          LPAD(SUM(DECODE(STATISTIC_NAME, 'row lock waits', VALUE, 0)), 12) ||
          LPAD(SUM(DECODE(STATISTIC_NAME, 'buffer busy waits', VALUE, 0)), 12) ||
          LPAD(SUM(DECODE(STATISTIC_NAME, 'db block changes', VALUE, 0)), 12) ||
          LPAD(SUM(DECODE(STATISTIC_NAME, 'segment scans', VALUE, 0)), 14) LINE
        FROM V$SEGSTAT SS, DBA_OBJECTS O
        WHERE
          SS.OBJ# = O.OBJECT_ID AND
          ( O.OBJECT_TYPE IN ( 'TABLE', 'TABLE PARTITION' ) AND
            ( O.OWNER, O.OBJECT_NAME ) IN
            ( SELECT TABLE_OWNER, TABLE_NAME FROM TABLE_INFO
            ) OR
            O.OBJECT_TYPE IN ( 'INDEX', 'INDEX PARTITION' ) AND
            ( O.OWNER, O.OBJECT_NAME ) IN
            ( SELECT INDEX_OWNER, INDEX_NAME FROM INDEX_INFO
          ) )     
        GROUP BY O.OBJECT_NAME
        ORDER BY O.OBJECT_NAME
      )
    )
    UNION ALL
    ( SELECT  ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        'SEGMENT STATISTICS (DBA_HIST_SEG_STAT):' LINE
      FROM DUAL
    )
    UNION ALL
    ( SELECT  ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        RPAD('SEGMENT_NAME', 35) ||
        LPAD('LOG_READS', 12) ||
        LPAD('PHYS_READS', 12) ||
        LPAD('DIR_READS', 12) ||
        LPAD('PHYS_WRITES', 12) ||
        LPAD('DIR_WRITES', 12) ||
        LPAD('ITL_WAITS', 12) ||
        LPAD('ROW_LOCKS', 12) ||
        LPAD('BUFFER_BUSY', 12) ||
        LPAD('BLK_CHANGES', 12) ||
        LPAD('SEGMENT_SCANS', 14) LINE
      FROM
        DUAL
    )
    UNION ALL
    ( SELECT  ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        LINE
      FROM
      ( SELECT
          RPAD(SEGMENT_NAME, 35) || LPAD(LOGICAL_READS, 12) || LPAD(PHYSICAL_READS, 12) ||
          LPAD(PHYSICAL_READS_DIRECT, 12) || LPAD(PHYSICAL_WRITES, 12) ||
          LPAD(PHYSICAL_WRITES_DIRECT, 12) || LPAD(ITL_WAITS, 12) ||
          LPAD(ROW_LOCK_WAITS, 12) || LPAD(BUFFER_BUSY_WAITS, 12) ||
          LPAD(DB_BLOCK_CHANGES, 12) || LPAD(SEGMENT_SCANS, 14) LINE
        FROM
          SEGMENT_STATISTICS SS
        WHERE
          ( SS.SEG_TYPE IN ( 'TABLE', 'TABLE PARTITION' ) AND
            ( SS.OWNER, SS.SEGMENT_NAME ) IN
            ( SELECT TABLE_OWNER, TABLE_NAME
              FROM TABLE_INFO
            ) OR
            SS.SEG_TYPE IN ( 'INDEX', 'INDEX PARTITION' ) AND
            ( SS.OWNER, SS.SEGMENT_NAME ) IN
            ( SELECT INDEX_OWNER, INDEX_NAME
              FROM INDEX_INFO
            )
          )
        ORDER BY 
          SEGMENT_NAME
      )
    )
    UNION ALL ( SELECT  ' ' FROM DUAL )
UNION ALL
( SELECT
    '### Debugging info ### Elapsed time: ' || ROUND(L.CTIME - STS.SECONDS) ||
    ' s, logical reads: ' || TO_CHAR(SES1.VALUE - STS.BUFFER_GETS) || 
    ', physical reads: ' || TO_CHAR(SES2.VALUE - STS.DISK_READS) LINE
  FROM
    BASIS_INFO BI,
    START_STATE STS,
    V$SYSSTAT SYS1,
    V$SYSSTAT SYS2,
    V$MYSTAT SES1,
    V$MYSTAT SES2,
    ( SELECT CTIME FROM V$LOCK WHERE TYPE = 'MR' AND ROWNUM = 1) L
  WHERE
    BI.DEBUGGING_INFO = 'X' AND
    SYS1.NAME = 'session logical reads' AND 
    SYS1.STATISTIC# = SES1.STATISTIC# AND
    SYS2.NAME = 'physical reads' AND 
    SYS2.STATISTIC# = SES2.STATISTIC#
)
    UNION ALL ( SELECT LPAD('*', 240, '*') FROM DUAL )
    UNION ALL ( SELECT  ' ' FROM DUAL )
    UNION ALL ( SELECT 'INDEX COLUMNS (DBA_INDEXES):' FROM DUAL )
    UNION ALL ( SELECT  ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        RPAD('TABLE_NAME', 30) ||
        RPAD('INDEX_NAME', 35) ||
        RPAD('COLUMN_NAME', 30) ||
        LPAD('NUM_DISTINCT', 12) ||
        LPAD('AVG_COL_LEN', 12) ||
        LPAD('COLUMN_POSITION', 16) LINE
      FROM DUAL
    )
    UNION ALL
    ( SELECT  ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        RPAD(DECODE(TABLE_NAME, LAG(TABLE_NAME, 1) OVER
          (ORDER BY TABLE_NAME, INDEX_NAME, COLUMN_POSITION),
          ' ', TABLE_NAME), 30) ||
        RPAD(DECODE(INDEX_NAME, LAG(INDEX_NAME, 1) OVER
          (ORDER BY TABLE_NAME, INDEX_NAME, COLUMN_POSITION),
          ' ', INDEX_NAME), 35) ||
        RPAD(COLUMN_NAME, 30) ||
        LPAD(NVL(TO_CHAR(NUM_DISTINCT), ' '), 12) ||
        LPAD(NVL(TO_CHAR(AVG_COL_LEN), ' '), 12) ||
        LPAD(COLUMN_POSITION, 16) LINE
      FROM
      ( SELECT
          *
        FROM
        ( SELECT /*+ LEADING(AA) */ 
            I.TABLE_NAME,
            I.INDEX_NAME,
            I.COLUMN_NAME,
            I.COLUMN_POSITION,
            T.AVG_COL_LEN,
            T.NUM_DISTINCT,
            ROWNUM ROWNUMBER
          FROM
            TABLE_INFO TI,
            DBA_IND_COLUMNS I, 
            DBA_TAB_COLUMNS T,
            BASIS_INFO BI
          WHERE 
            BI.INDEX_COLUMNS = 'X' AND
            I.TABLE_OWNER = TI.TABLE_OWNER AND
            I.TABLE_NAME = TI.TABLE_NAME AND
            I.TABLE_OWNER = T.OWNER AND
            I.TABLE_NAME = T.TABLE_NAME AND
            I.COLUMN_NAME = T.COLUMN_NAME 
          UNION ALL
          ( SELECT /*+ LEADING(AA) */
              I.TABLE_NAME,
              I.INDEX_NAME,
              'Function' COLUMN_NAME,
              I.COLUMN_POSITION,
              NULL AVG_COL_LEN,
              NULL NUM_DISTINCT,
              ROWNUM ROWNUMBER
            FROM
              TABLE_INFO TI,
              DBA_IND_COLUMNS I, 
              DBA_IND_EXPRESSIONS IE,
              BASIS_INFO BI
            WHERE 
              BI.INDEX_COLUMNS = 'X' AND
              I.TABLE_OWNER = TI.TABLE_OWNER AND
              I.TABLE_NAME = TI.TABLE_NAME AND
              I.INDEX_OWNER = IE.INDEX_OWNER AND
              I.INDEX_NAME = IE.INDEX_NAME AND
              I.COLUMN_POSITION = IE.COLUMN_POSITION     
          )
        )
        ORDER BY
          TABLE_NAME,
          INDEX_NAME,
          COLUMN_POSITION
      )
    )
    UNION ALL
    ( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    '### Debugging info ### Elapsed time: ' || ROUND(L.CTIME - STS.SECONDS) ||
    ' s, logical reads: ' || TO_CHAR(SES1.VALUE - STS.BUFFER_GETS) || 
    ', physical reads: ' || TO_CHAR(SES2.VALUE - STS.DISK_READS) LINE
  FROM
    BASIS_INFO BI,
    START_STATE STS,
    V$SYSSTAT SYS1,
    V$SYSSTAT SYS2,
    V$MYSTAT SES1,
    V$MYSTAT SES2,
    ( SELECT CTIME FROM V$LOCK WHERE TYPE = 'MR' AND ROWNUM = 1) L
  WHERE
    BI.DEBUGGING_INFO = 'X' AND
    SYS1.NAME = 'session logical reads' AND 
    SYS1.STATISTIC# = SES1.STATISTIC# AND
    SYS2.NAME = 'physical reads' AND 
    SYS2.STATISTIC# = SES2.STATISTIC#
)
    UNION ALL
    ( SELECT LPAD('*', 240, '*') FROM DUAL
    )
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        'CBO STATISTICS (DBA_TAB_STATISTICS, DBA_INDEXES, DBA_TAB_COLUMNS, DBA_TAB_STATS_HISTORY, DBA_OPTSTAT_OPERATIONS):' LINE
      FROM DUAL 
    )
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        'TABLE STATISTICS:' LINE
      FROM DUAL
    )
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        RPAD('OWNER', 10) ||
        RPAD('TABLE_NAME', 35) ||
        RPAD('PARTITION_NAME', 30) ||
        LPAD('NUM_ROWS', 12) ||
        LPAD('BLOCKS', 10) ||
        LPAD('AVG_ROW_LEN', 12) ||
        LPAD('LAST_ANALYZED', 22) ||
        LPAD('SAMPLE_SIZE', 12) ||
        LPAD('CREATION_TIME', 22) ||
        LPAD('LAST_DDL_TIME', 22) ||
        LPAD('USER_STATS', 11) ||
        LPAD('INI_TRANS', 10) ||
        LPAD('PCT_FREE', 9) ||
        LPAD('DEGREE', 8) LINE
      FROM DUAL 
    )
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        LINE
      FROM
      ( SELECT
          LINE
        FROM
        ( SELECT /*+ LEADING(TS) */
            RPAD(T.OWNER, 10) ||
            RPAD(T.TABLE_NAME, 35) ||
            RPAD(NVL(T.PARTITION_NAME, ' '), 30) ||
            LPAD(NVL(TO_CHAR(T.NUM_ROWS), ' '), 12) ||
            LPAD(NVL(TO_CHAR(T.BLOCKS), ' '), 10) ||
            LPAD(NVL(TO_CHAR(T.AVG_ROW_LEN), ' '), 12) ||
            LPAD(DECODE(T.LAST_ANALYZED, NULL, ' ', TO_CHAR(T.LAST_ANALYZED, 'YYYY-MM-DD HH24:MI:SS')), 22) ||
            LPAD(NVL(TO_CHAR(T.SAMPLE_SIZE), '0'), 12) ||
            LPAD(DECODE(O.CREATED, NULL, ' ', TO_CHAR(O.CREATED,
              'YYYY-MM-DD HH24:MI:SS')), 22) ||
            LPAD(DECODE(O.LAST_DDL_TIME, NULL, ' ', TO_CHAR(O.LAST_DDL_TIME, 'YYYY-MM-DD HH24:MI:SS')), 22) ||
            LPAD(T.USER_STATS, 11) ||
            LPAD(DECODE(T.PARTITION_NAME, NULL, TO_CHAR(TS.INI_TRANS), ' '), 10) ||
            LPAD(DECODE(T.PARTITION_NAME, NULL, TO_CHAR(TS.PCT_FREE), ' '), 9) ||
            LPAD(TS.DEGREE , 8) LINE,
            T.OWNER,
            T.TABLE_NAME,
            NVL(T.PARTITION_POSITION, 0) PARTITION_POSITION
          FROM
            TABLE_STORAGE TS, 
            DBA_TAB_STATISTICS T, 
            DBA_OBJECTS O
          WHERE
            TS.TABLE_OWNER = T.OWNER AND
            TS.TABLE_NAME = T.TABLE_NAME AND
            NVL(TS.PARTITION_NAME, ' ') = NVL(T.PARTITION_NAME, ' ') AND
            T.OWNER = O.OWNER AND
            T.TABLE_NAME = O.OBJECT_NAME AND
            NVL(T.PARTITION_NAME, ' ') = NVL(O.SUBOBJECT_NAME, ' ') AND
            O.OBJECT_TYPE IN ('TABLE', 'TABLE PARTITION')
        )
        ORDER BY
          OWNER,
          TABLE_NAME,
          PARTITION_POSITION
      )
    )
UNION ALL
( SELECT
    '### Debugging info ### Elapsed time: ' || ROUND(L.CTIME - STS.SECONDS) ||
    ' s, logical reads: ' || TO_CHAR(SES1.VALUE - STS.BUFFER_GETS) || 
    ', physical reads: ' || TO_CHAR(SES2.VALUE - STS.DISK_READS) LINE
  FROM
    BASIS_INFO BI,
    START_STATE STS,
    V$SYSSTAT SYS1,
    V$SYSSTAT SYS2,
    V$MYSTAT SES1,
    V$MYSTAT SES2,
    ( SELECT CTIME FROM V$LOCK WHERE TYPE = 'MR' AND ROWNUM = 1) L
  WHERE
    BI.DEBUGGING_INFO = 'X' AND
    SYS1.NAME = 'session logical reads' AND 
    SYS1.STATISTIC# = SES1.STATISTIC# AND
    SYS2.NAME = 'physical reads' AND 
    SYS2.STATISTIC# = SES2.STATISTIC#
)
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        'INDEX STATISTICS (INDEX PARTITIONS ARE NOT CONSIDERED):' LINE
      FROM DUAL
    )
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        RPAD('INDEX_NAME', 30) ||
        LPAD('NUM_ROWS', 12) ||
        LPAD('LEAF_BLOCKS', 12) ||
        LPAD('DISTINCT_KEYS', 14) ||
        LPAD('CLUST_FACTOR', 13) ||
        LPAD('BLEVEL', 7) ||
        LPAD('LAST_ANALYZED', 22) ||
        LPAD('SAMPLE_SIZE', 12) ||
        RPAD(' INDEX_TYPE', 12) ||
        RPAD('UNIQUENESS', 11) ||
        LPAD('CREATION_TIME', 22) ||
        LPAD('LAST_DDL_TIME', 22) ||
        LPAD('USER_STATS', 11) ||
        LPAD('INI_TRANS', 10) ||
        LPAD('PCT_FREE', 9) ||
        LPAD('DEGREE', 8) ||
        RPAD(' COMPRESS', 10) LINE
      FROM
        DUAL
    )
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        LINE
      FROM
      ( SELECT 
          RPAD(I.INDEX_NAME, 30) ||
          LPAD(NVL(TO_CHAR(I.NUM_ROWS), ' '), 12) ||
          LPAD(NVL(TO_CHAR(I.LEAF_BLOCKS), ' '), 12) ||
          LPAD(NVL(TO_CHAR(I.DISTINCT_KEYS), ' '), 14) ||
          LPAD(NVL(TO_CHAR(I.CLUSTERING_FACTOR), ' '), 13) ||
          LPAD(NVL(TO_CHAR(I.BLEVEL), ' '), 7) ||
          LPAD(DECODE(I.LAST_ANALYZED, NULL, ' ', TO_CHAR(I.LAST_ANALYZED, 'YYYY-MM-DD HH24:MI:SS')), 22) ||
          LPAD(NVL(TO_CHAR(I.SAMPLE_SIZE), ' '), 12) ||
          RPAD(' ' || I.INDEX_TYPE, 12) ||
          RPAD(I.UNIQUENESS, 11) ||
          LPAD(TO_CHAR(O.CREATED, 'YYYY-MM-DD HH24:MI:SS'), 22) ||
          LPAD(TO_CHAR(O.LAST_DDL_TIME, 'YYYY-MM-DD HH24:MI:SS'), 22) ||
          LPAD(I.USER_STATS, 11) ||
          LPAD(I.INI_TRANS, 10) ||
          LPAD(I.PCT_FREE, 9) ||
          LPAD(I.DEGREE, 8) ||
          RPAD(' ' || DECODE(II.COMPRESSION, 'YES', II.COMPRESSION || 
            ' (' || II.PREFIX_LENGTH || ')', II.COMPRESSION), 10) LINE
        FROM
          DBA_INDEXES I, DBA_OBJECTS O, INDEX_INFO II
        WHERE
          I.INDEX_TYPE != 'LOB' AND
          I.OWNER = O.OWNER AND
          I.INDEX_NAME = O.OBJECT_NAME AND
          O.SUBOBJECT_NAME IS NULL AND
          I.OWNER = II.INDEX_OWNER AND
          I.INDEX_NAME = II.INDEX_NAME AND
          O.OBJECT_TYPE = 'INDEX'
        ORDER BY
          I.OWNER,
          I.TABLE_NAME,
          I.INDEX_NAME
      )
    )
UNION ALL
( SELECT
    '### Debugging info ### Elapsed time: ' || ROUND(L.CTIME - STS.SECONDS) ||
    ' s, logical reads: ' || TO_CHAR(SES1.VALUE - STS.BUFFER_GETS) || 
    ', physical reads: ' || TO_CHAR(SES2.VALUE - STS.DISK_READS) LINE
  FROM
    BASIS_INFO BI,
    START_STATE STS,
    V$SYSSTAT SYS1,
    V$SYSSTAT SYS2,
    V$MYSTAT SES1,
    V$MYSTAT SES2,
    ( SELECT CTIME FROM V$LOCK WHERE TYPE = 'MR' AND ROWNUM = 1) L
  WHERE
    BI.DEBUGGING_INFO = 'X' AND
    SYS1.NAME = 'session logical reads' AND 
    SYS1.STATISTIC# = SES1.STATISTIC# AND
    SYS2.NAME = 'physical reads' AND 
    SYS2.STATISTIC# = SES2.STATISTIC#
)
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        'COLUMN STATISTICS:' LINE
      FROM DUAL
    )
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        RPAD('TABLE_NAME', 30) ||
        RPAD('COLUMN_NAME', 25) ||
        LPAD('NUM_DISTINCT', 13) ||
        LPAD('DENSITY', 9) ||
        LPAD('NUM_BUCKETS', 12) ||
        LPAD('AVG_COL_LEN', 12) ||
        LPAD('DATA_LENGTH', 12) ||
        LPAD('NULLABLE', 9) ||
        LPAD('NUM_NULLS', 12) ||
        RPAD(' DATA_TYPE', 20) ||
        LPAD('LAST_ANALYZED', 22) ||
        LPAD('SAMPLE_SIZE', 12) ||
        LPAD('USER_STATS', 11) LINE
      FROM
        DUAL
    )
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        LINE
      FROM
      ( SELECT
          RPAD(DECODE(TCS.TABLE_NAME, LAG(TCS.TABLE_NAME, 1) OVER 
            (ORDER BY TCS.OWNER, TCS.TABLE_NAME, TCS.COLUMN_NAME),
            ' ', TCS.TABLE_NAME), 30) ||
          RPAD(TCS.COLUMN_NAME, 25) ||
          LPAD(NVL(TO_CHAR(TCS.NUM_DISTINCT), ' '), 13) ||
          LPAD(DECODE(TCS.DENSITY, NULL, ' ', TO_CHAR(TCS.DENSITY, 90.999999)), 9) ||
          LPAD(NVL(TO_CHAR(TCS.NUM_BUCKETS), ' '), 12) ||
          LPAD(NVL(TO_CHAR(TCS.AVG_COL_LEN), ' '), 12) ||
          LPAD(NVL(TO_CHAR(TCS.DATA_LENGTH), ' '), 12) ||
          LPAD(NVL(TCS.NULLABLE, ' '), 9) ||
          LPAD(NVL(TO_CHAR(TCS.NUM_NULLS), ' '), 12) ||
          RPAD(' ' || TCS.DATA_TYPE, 20) ||
          LPAD(DECODE(TCS.LAST_ANALYZED, NULL, ' ', TO_CHAR(TCS.LAST_ANALYZED, 
            'YYYY-MM-DD HH24:MI:SS')), 22) ||
          LPAD(NVL(TO_CHAR(TCS.SAMPLE_SIZE), ' '), 12) ||
          LPAD(TCS.USER_STATS, 11) LINE
        FROM
          DBA_TAB_COLUMNS TCS, TABLE_INFO TI
        WHERE
          TCS.OWNER = TI.TABLE_OWNER AND
          TCS.TABLE_NAME = TI.TABLE_NAME
        ORDER BY
          TCS.OWNER,
          TCS.TABLE_NAME,
          TCS.COLUMN_NAME
      )
    )
UNION ALL
( SELECT
    '### Debugging info ### Elapsed time: ' || ROUND(L.CTIME - STS.SECONDS) ||
    ' s, logical reads: ' || TO_CHAR(SES1.VALUE - STS.BUFFER_GETS) || 
    ', physical reads: ' || TO_CHAR(SES2.VALUE - STS.DISK_READS) LINE
  FROM
    BASIS_INFO BI,
    START_STATE STS,
    V$SYSSTAT SYS1,
    V$SYSSTAT SYS2,
    V$MYSTAT SES1,
    V$MYSTAT SES2,
    ( SELECT CTIME FROM V$LOCK WHERE TYPE = 'MR' AND ROWNUM = 1) L
  WHERE
    BI.DEBUGGING_INFO = 'X' AND
    SYS1.NAME = 'session logical reads' AND 
    SYS1.STATISTIC# = SES1.STATISTIC# AND
    SYS2.NAME = 'physical reads' AND 
    SYS2.STATISTIC# = SES2.STATISTIC#
)
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        'TABLE STATISTICS HISTORY:'
      FROM DUAL
    )
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT 
        RPAD('OWNER', 10) ||
        RPAD('TABLE_NAME', 35) ||
        RPAD('PARTITION_NAME', 30) ||
        LPAD('STATS_UPDATE_TIME', 22) 
      FROM DUAL
    )
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        RPAD(DECODE(ROW_NUM, 1, OWNER, ' '), 10) ||
        RPAD(DECODE(ROW_NUM, 1, TABLE_NAME, ' '), 35) ||
        RPAD(DECODE(ROW_NUM, 1, NVL(PARTITION_NAME, ' '), ' '), 30) ||
        LPAD(TO_CHAR(STATS_UPDATE_TIME, 'YYYY-MM-DD HH24:MI:SS'), 22) LINE
      FROM
      ( SELECT
          TSH.OWNER,
          TSH.TABLE_NAME,
          TSH.PARTITION_NAME,
          TSH.STATS_UPDATE_TIME,
          ROW_NUMBER () OVER (PARTITION BY TSH.OWNER, TSH.TABLE_NAME, TS.PARTITION_POSITION
            ORDER BY TSH.STATS_UPDATE_TIME DESC) ROW_NUM
        FROM
          TABLE_STORAGE TS,
          DBA_TAB_STATS_HISTORY TSH
        WHERE
          TS.TABLE_OWNER = TSH.OWNER AND
          TS.TABLE_NAME = TSH.TABLE_NAME AND
          NVL(TS.PARTITION_NAME, ' ') = NVL(TSH.PARTITION_NAME, ' ')
        ORDER BY
          TSH.OWNER,
          TSH.TABLE_NAME,
          TS.PARTITION_POSITION,
          TSH.STATS_UPDATE_TIME DESC
      )
    )
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        'COLLECTION OF SPECIAL STATISTICS:'
      FROM DUAL
    )
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        RPAD('OPERATION', 30) ||
        LPAD('START_TIME', 22) ||
        LPAD('END_TIME', 22) 
      FROM DUAL
    )
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        *
      FROM
      ( SELECT
          RPAD(OPERATION, 30) ||
          LPAD(TO_CHAR(START_TIME, 'YYYY-MM-DD HH24:MI:SS'), 22) ||
          LPAD(TO_CHAR(END_TIME, 'YYYY-MM-DD HH24:MI:SS'), 22) 
        FROM
          DBA_OPTSTAT_OPERATIONS
        WHERE 
          SUBSTR(UPPER(OPERATION), 1, 6) = 'GATHER' AND
          OPERATION != 'gather_table_stats'
        ORDER BY
          START_TIME DESC
      )
    )
    UNION ALL
    ( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    '### Debugging info ### Elapsed time: ' || ROUND(L.CTIME - STS.SECONDS) ||
    ' s, logical reads: ' || TO_CHAR(SES1.VALUE - STS.BUFFER_GETS) || 
    ', physical reads: ' || TO_CHAR(SES2.VALUE - STS.DISK_READS) LINE
  FROM
    BASIS_INFO BI,
    START_STATE STS,
    V$SYSSTAT SYS1,
    V$SYSSTAT SYS2,
    V$MYSTAT SES1,
    V$MYSTAT SES2,
    ( SELECT CTIME FROM V$LOCK WHERE TYPE = 'MR' AND ROWNUM = 1) L
  WHERE
    BI.DEBUGGING_INFO = 'X' AND
    SYS1.NAME = 'session logical reads' AND 
    SYS1.STATISTIC# = SES1.STATISTIC# AND
    SYS2.NAME = 'physical reads' AND 
    SYS2.STATISTIC# = SES2.STATISTIC#
)
    UNION ALL
    ( SELECT LPAD('*', 240, '*') FROM DUAL )
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        'TABLE MODIFICATIONS (DBA_TAB_MODIFICATIONS):' LINE
      FROM DUAL 
    )
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        RPAD('OWNER', 10) || 
        RPAD('TABLE_NAME', 35) || 
        RPAD('PARTITION_NAME', 30) ||
        LPAD('INSERTS', 10) || 
        LPAD('UPDATES', 10) || 
        LPAD('DELETES', 10) || 
        LPAD('TRUNCATED', 10) || 
        LPAD('DROP_SEGMENTS', 14) LINE
      FROM
        DUAL
    )
    UNION ALL ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        LINE
      FROM
      ( SELECT
          RPAD(DTM.TABLE_OWNER, 10) ||
          RPAD(DTM.TABLE_NAME, 35) ||
          RPAD(NVL(DTM.PARTITION_NAME, ' '), 30) ||
          LPAD(DTM.INSERTS, 10) ||
          LPAD(DTM.UPDATES, 10) ||
          LPAD(DTM.DELETES, 10) ||
          LPAD(DTM.TRUNCATED, 10) ||
          LPAD(DTM.DROP_SEGMENTS, 14) LINE
        FROM
          TABLE_INFO TI,
          SYS.DBA_TAB_MODIFICATIONS DTM
        WHERE
          TI.TABLE_OWNER = DTM.TABLE_OWNER AND
          TI.TABLE_NAME = DTM.TABLE_NAME
        ORDER BY
          DTM.TABLE_OWNER,
          DTM.TABLE_NAME
      )
    )
    UNION ALL
    ( SELECT  ' ' FROM DUAL )
UNION ALL
( SELECT
    '### Debugging info ### Elapsed time: ' || ROUND(L.CTIME - STS.SECONDS) ||
    ' s, logical reads: ' || TO_CHAR(SES1.VALUE - STS.BUFFER_GETS) || 
    ', physical reads: ' || TO_CHAR(SES2.VALUE - STS.DISK_READS) LINE
  FROM
    BASIS_INFO BI,
    START_STATE STS,
    V$SYSSTAT SYS1,
    V$SYSSTAT SYS2,
    V$MYSTAT SES1,
    V$MYSTAT SES2,
    ( SELECT CTIME FROM V$LOCK WHERE TYPE = 'MR' AND ROWNUM = 1) L
  WHERE
    BI.DEBUGGING_INFO = 'X' AND
    SYS1.NAME = 'session logical reads' AND 
    SYS1.STATISTIC# = SES1.STATISTIC# AND
    SYS2.NAME = 'physical reads' AND 
    SYS2.STATISTIC# = SES2.STATISTIC#
)
    UNION ALL
    ( SELECT LPAD('*', 240, '*') FROM DUAL )
    UNION ALL
    ( SELECT  ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        'FRAGMENTATION INFORMATION (BASED ON CBO STATISTICS):' LINE
      FROM DUAL 
    )
    UNION ALL
    ( SELECT  ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        RPAD('SEGMENT_NAME', 30) ||
        RPAD('PARTITION_NAME', 30) ||
        LPAD('UNUSED_MB', 11) ||
        LPAD('QUALITY_%', 10) ||
        LPAD('SEG_GROSS_MB', 13) ||
        LPAD('SEG_NET_MB', 11) ||
        LPAD('DATA_GROSS_MB', 14) ||
        LPAD('DATA_NET_MB', 12) ||
        RPAD(' RESTRICTIONS', 120) LINE
      FROM DUAL
    )
    UNION ALL
    ( SELECT  ' ' FROM DUAL )
    UNION ALL
    ( SELECT 
        RPAD(DECODE(SEGMENT_NAME, LAG(SEGMENT_NAME, 1) OVER (ORDER BY 1), ' ', SEGMENT_NAME), 30) ||
        RPAD(NVL(PARTITION_NAME, ' '), 30) ||
        LPAD(NVL(TO_CHAR(UNUSED_MB, 999990.99), ' '), 11) ||
        LPAD(NVL(TO_CHAR(QUALITY, 99990.99), ' '), 10) ||
        LPAD(NVL(TO_CHAR(SEG_GROSS_MB, 99999990.99), ' '), 13) ||
        LPAD(NVL(TO_CHAR(SEG_NET_MB, 9999990.99), ' '), 11) ||
        LPAD(NVL(TO_CHAR(DATA_GROSS_MB, 999999990.99), ' '), 14) ||
        LPAD(NVL(TO_CHAR(DATA_NET_MB, 9999990.99), ' '), 12) ||
        RPAD(' ' || RESTRICTIONS, 120) LINE
      FROM
      ( SELECT
          SEGMENT_NAME,
          PARTITION_NAME,
          SEG_GROSS_MB,
          SEG_NET_MB,
          DATA_GROSS_MB,
          DATA_NET_MB,
          UNUSED_MB,
          DECODE(UNUSED_MB + DATA_NET_MB, 0, 0, DATA_NET_MB / (UNUSED_MB + DATA_NET_MB) * 100) QUALITY,
          RESTRICTIONS,
          PARTITION_POSITION
        FROM
        ( SELECT 
            SEGMENT_NAME,
            PARTITION_NAME,
            DECODE(CLUSTER_TABLE, 'YES', DATA_GROSS_MB * 1.1, SEG_GROSS_MB) SEG_GROSS_MB,
            DECODE(CLUSTER_TABLE, 'YES', DATA_GROSS_MB, SEG_NET_MB) SEG_NET_MB,
            DATA_GROSS_MB + GREATEST(0, CHANGE_MB) DATA_GROSS_MB,
            GREATEST(0, DATA_NET_MB + CHANGE_MB) DATA_NET_MB,
            LEAST(SEG_GROSS_MB, GREATEST(DATA_GROSS_MB + GREATEST(0, CHANGE_MB), SEG_NET_MB)) - 
              DATA_NET_MB - CHANGE_MB UNUSED_MB,
            DECODE(USER_STATS,        'YES', 'STATISTICS MODIFIED   ') ||
              DECODE(LONG_RAW,        'YES', 'LONG RAW   ') ||
              DECODE(LOB,             'YES', 'LOB   ') ||
              DECODE(STATTYPE_LOCKED, 'ALL', 'STATISTICS LOCKED   ') ||
              DECODE(STALE_STATS,     'YES', 'STATISTICS STALE   ') ||
              DECODE(RECREATED,       'YES', 'STATISTICS OLDER THAN SEGMENT   ') ||
              DECODE(AVG_ROW_LEN,     0,     'ROW LENGTH = 0   ') ||
              DECODE(SIGN(SEG_GROSS_MB - 5),    -1, 'SMALL TABLE   ') ||
              DECODE(CLUSTER_TABLE,   'YES', 'CLUSTER TABLE   ')
              RESTRICTIONS,
            TABLE_NAME,
            BYTES,
            PARTITION_POSITION,
            INDEX_NAME
          FROM
          ( SELECT
              TS.TABLE_OWNER,
              TS.TABLE_NAME SEGMENT_NAME,
              NVL(TS.PARTITION_NAME, ' ') PARTITION_NAME,
              DECODE(CLUSTER_TABLE, 'YES', DTS.BLOCKS * (8000 - 23 * TS.INI_TRANS) * 
                (1 - TS.PCT_FREE / 100) / 1024 / 1024 * 1.1, S.BYTES / 1024 / 1024) SEG_GROSS_MB,
              DECODE(CLUSTER_TABLE, 'YES', DTS.BLOCKS * (8000 - 23 * TS.INI_TRANS) * 
                (1 - TS.PCT_FREE / 100) / 1024 / 1024, (S.BYTES / 1024 / 1024) * (8000 - 23 * 
                TS.INI_TRANS) * (1 - TS.PCT_FREE / 100) / 8192) SEG_NET_MB,
              DTS.BLOCKS * (8000 - 23 * TS.INI_TRANS) * (1 - TS.PCT_FREE / 100) / 1024 / 1024 DATA_GROSS_MB,
              (DTS.AVG_ROW_LEN + 2) * DTS.NUM_ROWS / 1024 / 1024 DATA_NET_MB,
              DTS.NUM_ROWS,
              DTS.AVG_ROW_LEN,
              DTS.BLOCKS,
              DTS.USER_STATS,
              DTC.LONG_RAW,
              DTC.LOB,
              DECODE(SIGN(NVL(DTS.LAST_ANALYZED, SYSDATE) - S.CREATED), -1, 'YES', 'NO') RECREATED,
              DTS.STATTYPE_LOCKED,
              DTS.STALE_STATS,
              DTS.AVG_ROW_LEN * (TM.INSERTS - TM.DELETES) / 1024 / 1024 CHANGE_MB,
              TS.TABLE_NAME,
              S.BYTES,
              TS.CLUSTER_TABLE,
              TS.PARTITION_POSITION,
              ' ' INDEX_NAME
            FROM 
              TABLE_STORAGE TS,
              TABLE_MODIFICATIONS TM,
              DBA_TAB_STATISTICS DTS,
              TABLE_COLUMNS DTC,
              SEGMENTS S,
              BASIS_INFO BI
            WHERE
              TS.TABLE_OWNER = DTS.OWNER AND
              TS.TABLE_NAME = DTS.TABLE_NAME AND
              NVL(TS.PARTITION_NAME, ' ') = NVL(DTS.PARTITION_NAME, ' ') AND
              DTS.OWNER = S.OWNER (+) AND
              DTS.TABLE_NAME = S.SEGMENT_NAME (+) AND 
              NVL(DTS.PARTITION_NAME, ' ') = NVL(S.PARTITION_NAME (+), ' ') AND
              DTS.OWNER = TM.TABLE_OWNER AND
              DTS.TABLE_NAME = TM.TABLE_NAME AND
              NVL(DTS.PARTITION_NAME, ' ') = NVL(TM.PARTITION_NAME, ' ') AND
              DTS.OWNER = DTC.TABLE_OWNER AND
              DTS.TABLE_NAME = DTC.TABLE_NAME AND
              DTS.NUM_ROWS IS NOT NULL AND
              (TS.IOT_TYPE != 'IOT' OR TS.IOT_TYPE IS NULL) AND
              BI.SEGMENT_INFO = 'X'
          )
          UNION ALL
          ( SELECT
              SEGMENT_NAME,
              PARTITION_NAME,
              SEG_GROSS_MB,
              SEG_NET_MB,
              DATA_GROSS_MB + GREATEST(0, CHANGE_MB) DATA_GROSS_MB,
              GREATEST(0, DATA_NET_MB + CHANGE_MB) DATA_NET_MB,
              LEAST(SEG_GROSS_MB, GREATEST(DATA_GROSS_MB + GREATEST(0, CHANGE_MB), SEG_NET_MB)) - 
                DATA_NET_MB - CHANGE_MB UNUSED_MB,
              DECODE(  USER_STATS,             'YES',    'STATISTICS MODIFIED   ') ||
                DECODE(STATTYPE_LOCKED,        'ALL',    'STATISTICS LOCKED   ') ||
                DECODE(STALE_STATS,            'YES',    'STATISTICS STALE   ') ||
                DECODE(SIGN(SEG_GROSS_MB - 5), -1,       'SMALL INDEX   ') ||
                DECODE(SIGN(COL_LEN_NULL),     1,        'MISSING COLUMN STATISTICS   ') ||
                DECODE(RECREATED,              'YES',    'STATISTICS OLDER THAN SEGMENT   ') ||
                DECODE(INDEX_TYPE,             'BITMAP', 'BITMAP INDEX   ') ||
                DECODE(IND_ROW_LEN,            0,        'ROW LENGTH = 0   ') ||
                DECODE(LEAF_BLOCKS,            0,        'WRONG VALUE LEAF_BLOCKS = 0   ') ||
                DECODE(COMPRESSION,            'YES',    'COMPRESSED INDEX   ') RESTRICTIONS,
              TABLE_NAME,
              BYTES,
              PARTITION_POSITION,
              INDEX_NAME
            FROM
            ( SELECT 
                DIS.OWNER,
                DIS.INDEX_NAME SEGMENT_NAME,
                NVL(DIS.PARTITION_NAME, ' ') PARTITION_NAME,
                S.BYTES / 1024 / 1024 SEG_GROSS_MB,
                (S.BYTES / 1024 / 1024) * (8079 - 23 * IST.INI_TRANS) * (1 - IST.PCT_FREE / 100) / 8192 SEG_NET_MB,
                DIS.LEAF_BLOCKS * (8079 - 23 * IST.INI_TRANS) * (1 - IST.PCT_FREE / 100) / 1024 / 1024 * 1.05 DATA_GROSS_MB,
                DECODE (SUBSTR(IST.INDEX_TYPE, 1, 6),
                  'NORMAL', (IR.IND_ROW_LEN * DIS.NUM_ROWS - DECODE(IST.COMPRESSION, 'NO', 0, IR.COMP_ROW_LEN * 
                    GREATEST(0, NUM_ROWS - DECODE(IST.PREFIX_LENGTH, 1, FIRST_NUM_DIST, DISTINCT_KEYS)))) / 1024 / 1024,
                  'BITMAP', (NUM_ROWS * (DECODE(DISTINCT_KEYS, 1, 0.18, 1) + DECODE(DISTINCT_KEYS, 
                    0, 0, LOG(35, DISTINCT_KEYS))) + DISTINCT_KEYS * 50) / 1024 / 1024
                  ) * 1.05 DATA_NET_MB,
                DIS.NUM_ROWS,
                DIS.LEAF_BLOCKS LEAF_BLOCKS,
                DIS.USER_STATS,
                DIS.STATTYPE_LOCKED,
                DIS.STALE_STATS,
                DECODE(SIGN(NVL(DIS.LAST_ANALYZED, SYSDATE) - S.CREATED), -1, 'YES', 'NO') RECREATED,
                IR.COL_LEN_NULL,
                IR.IND_ROW_LEN,
                IR.IND_ROW_LEN * (TM.INSERTS - TM.DELETES) / 1024 / 1024 CHANGE_MB,
                DIS.TABLE_NAME,
                S.BYTES,
                IST.PARTITION_POSITION,
                DIS.INDEX_NAME,
                IST.INDEX_TYPE,
                IST.COMPRESSION
              FROM 
                INDEX_STORAGE IST,
                TABLE_MODIFICATIONS TM,
                INDEX_STATISTICS DIS,
                INDEX_ROWS IR,
                SEGMENTS S,
                BASIS_INFO BI
              WHERE 
                DIS.OWNER = IST.INDEX_OWNER AND
                DIS.INDEX_NAME = IST.INDEX_NAME AND
                NVL(DIS.PARTITION_NAME, ' ') = NVL(IST.PARTITION_NAME, ' ') AND
                DIS.OWNER = S.OWNER (+) AND
                DIS.INDEX_NAME = S.SEGMENT_NAME (+) AND
                NVL(DIS.PARTITION_NAME, ' ') = NVL(S.PARTITION_NAME (+), ' ') AND
                DIS.OWNER = TM.TABLE_OWNER AND
                DIS.TABLE_OWNER = TM.TABLE_OWNER AND
                DIS.TABLE_NAME = TM.TABLE_NAME AND
                NVL(DIS.PARTITION_NAME, ' ') = NVL(TM.PARTITION_NAME, ' ') AND
                IST.INDEX_NAME = IR.INDEX_NAME AND
                IST.INDEX_OWNER = IR.INDEX_OWNER AND
                IST.INDEX_TYPE IN ( 'NORMAL', 'NORMAL/REV', 'BITMAP' ) AND
                BI.SEGMENT_INFO = 'X'
            )
          ) 
        ) 
        ORDER BY
          RPAD(TABLE_NAME, 50) || LPAD(INDEX_NAME, 50) || LPAD(PARTITION_POSITION, 10)
      ) F,
        BASIS_INFO BI
      WHERE
        BI.FRAGMENTATION_INFO = 'X'
    )
    UNION ALL
    ( SELECT  ' ' FROM DUAL )
    UNION ALL
    ( SELECT 'SEGMENT ADVISOR INFORMATION (DBA_ADVISOR_TASKS, DBA_ADVISOR_FINDINGS, DBA_ADVISOR_OBJECTS):' FROM DUAL )
    UNION ALL
    ( SELECT  ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        RPAD('ANALYSIS_TIME', 20) || RPAD('SEGMENT_NAME', 35) ||
        RPAD('PARTITION_NAME', 30) || RPAD('MESSAGE', 300) LINE
      FROM DUAL
    )
    UNION ALL ( SELECT  ' ' FROM DUAL )
    UNION ALL
    ( SELECT * FROM
      ( SELECT
          RPAD(TO_CHAR(ANALYSIS_TIME, 'YYYY-MM-DD HH24:MI:SS'), 20) ||
          RPAD(SEGMENT_NAME, 35) ||
          RPAD(NVL(PARTITION_NAME, ' '), 30) ||
          RPAD(MESSAGE, 300)
        FROM
        ( SELECT
            DAT.EXECUTION_START ANALYSIS_TIME,
            DAO.ATTR2 SEGMENT_NAME,
            DAO.ATTR3 PARTITION_NAME,
            DAF.MESSAGE MESSAGE,
            ROW_NUMBER () OVER (PARTITION BY DAO.ATTR2 ORDER BY DAT.EXECUTION_START DESC) ROW_NUM
          FROM
            DBA_ADVISOR_TASKS DAT,
            DBA_ADVISOR_FINDINGS DAF,
            DBA_ADVISOR_OBJECTS DAO
          WHERE
            DAT.OWNER = DAF.OWNER AND
            DAT.TASK_ID = DAF.TASK_ID AND
            DAF.TASK_ID = DAO.TASK_ID AND
            DAF.OBJECT_ID = DAO.OBJECT_ID AND
            DAT.ADVISOR_NAME = 'Segment Advisor' AND
            (DAO.ATTR1, DAO.ATTR2 ) IN
            ( SELECT TABLE_OWNER, TABLE_NAME FROM TABLE_INFO UNION ALL
              SELECT INDEX_OWNER, INDEX_NAME FROM INDEX_INFO )
        )
        WHERE 
          ROW_NUM = 1
        ORDER BY
          ANALYSIS_TIME DESC,
          SEGMENT_NAME
      )
    )
    UNION ALL
    ( SELECT  ' ' FROM DUAL )
UNION ALL
( SELECT
    '### Debugging info ### Elapsed time: ' || ROUND(L.CTIME - STS.SECONDS) ||
    ' s, logical reads: ' || TO_CHAR(SES1.VALUE - STS.BUFFER_GETS) || 
    ', physical reads: ' || TO_CHAR(SES2.VALUE - STS.DISK_READS) LINE
  FROM
    BASIS_INFO BI,
    START_STATE STS,
    V$SYSSTAT SYS1,
    V$SYSSTAT SYS2,
    V$MYSTAT SES1,
    V$MYSTAT SES2,
    ( SELECT CTIME FROM V$LOCK WHERE TYPE = 'MR' AND ROWNUM = 1) L
  WHERE
    BI.DEBUGGING_INFO = 'X' AND
    SYS1.NAME = 'session logical reads' AND 
    SYS1.STATISTIC# = SES1.STATISTIC# AND
    SYS2.NAME = 'physical reads' AND 
    SYS2.STATISTIC# = SES2.STATISTIC#
)
    UNION ALL
    ( SELECT LPAD('*', 240, '*') FROM DUAL )
    UNION ALL
    ( SELECT  ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        'SEGMENT INFORMATION (DBA_SEGMENTS, DBA_LOBS, DBA_TABLESPACES):' LINE
      FROM DUAL
    )
    UNION ALL
    ( SELECT  ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        RPAD('OWNER', 10) || 
        RPAD('SEGMENT_NAME', 35) || 
        RPAD('PARTITION_NAME', 30) ||
        RPAD('SEGMENT_TYPE', 18) || 
        RPAD('TABLESPACE_NAME', 18) || 
        RPAD('TABLESPACE_TYPE', 20) ||
        RPAD('BUFFER_POOL', 12) || 
        LPAD('SIZE_MB', 15) || 
        LPAD('EXTENTS', 8) ||
        LPAD('INITIAL', 11) || 
        LPAD('NEXT', 9) || 
        LPAD('MIN_EXT', 8) || 
        LPAD('MAX_EXT', 11) ||
        LPAD('FREELISTS', 10) || 
        LPAD('FL_GROUPS', 10) LINE
      FROM DUAL
    )
    UNION ALL ( SELECT  ' ' FROM DUAL )
    UNION ALL
    ( SELECT LINE
      FROM
      ( SELECT LINE
        FROM
        ( SELECT DISTINCT
            RPAD(S.OWNER, 10) ||
            RPAD(DECODE(SUBSTR(S.SEGMENT_TYPE, 1, 3), 'LOB',
              S.LOB_TABLE_NAME || '.' || S.LOB_COLUMN_NAME, S.SEGMENT_NAME), 35) ||
            RPAD(NVL(S.PARTITION_NAME, ' '), 30) ||
            RPAD(S.SEGMENT_TYPE, 18) ||
            RPAD(NVL(S.TABLESPACE_NAME, '-'), 18) ||
            RPAD(S.TABLESPACE_TYPE, 20) ||
            RPAD(S.BUFFER_POOL, 12) ||
            TO_CHAR(NVL(S.BYTES, 0) / 1024 / 1024, 99999999990.99) ||
            LPAD(NVL(S.EXTENTS, 0), 8) ||
            LPAD(NVL(S.INITIAL_EXTENT, 0), 11) ||
            LPAD(NVL(S.NEXT_EXTENT, 0), 9) ||
            LPAD(NVL(S.MIN_EXTENTS, 0), 8) ||
            LPAD(NVL(S.MAX_EXTENTS, 0), 11) ||
            LPAD(NVL(S.FREELISTS, 0), 10) ||
            LPAD(NVL(S.FREELIST_GROUPS, 0), 10) LINE,
            S.OWNER OWNER,
            DECODE(SUBSTR(S.SEGMENT_TYPE, 1, 3), 'LOB', S.LOB_TABLE_NAME,
              S.SEGMENT_NAME) SEGMENT_NAME,
            S.PARTITION_NAME PARTITION_NAME,
            S.SEGMENT_TYPE SEGMENT_TYPE
          FROM
            SEGMENTS S
          ) 
        ORDER BY
          OWNER,
          SEGMENT_NAME,
          PARTITION_NAME,
          SEGMENT_TYPE DESC
      )
    )
    UNION ALL ( SELECT  ' ' FROM DUAL )
UNION ALL
( SELECT
    '### Debugging info ### Elapsed time: ' || ROUND(L.CTIME - STS.SECONDS) ||
    ' s, logical reads: ' || TO_CHAR(SES1.VALUE - STS.BUFFER_GETS) || 
    ', physical reads: ' || TO_CHAR(SES2.VALUE - STS.DISK_READS) LINE
  FROM
    BASIS_INFO BI,
    START_STATE STS,
    V$SYSSTAT SYS1,
    V$SYSSTAT SYS2,
    V$MYSTAT SES1,
    V$MYSTAT SES2,
    ( SELECT CTIME FROM V$LOCK WHERE TYPE = 'MR' AND ROWNUM = 1) L
  WHERE
    BI.DEBUGGING_INFO = 'X' AND
    SYS1.NAME = 'session logical reads' AND 
    SYS1.STATISTIC# = SES1.STATISTIC# AND
    SYS2.NAME = 'physical reads' AND 
    SYS2.STATISTIC# = SES2.STATISTIC#
)
UNION ALL 
( SELECT LPAD('*', 240, '*') FROM DUAL )
UNION ALL 
( SELECT  ' ' FROM DUAL )
UNION ALL 
( SELECT 'LOB INFORMATION (DBA_LOBS):' FROM DUAL )
UNION ALL 
( SELECT  ' ' FROM DUAL )
UNION ALL
( SELECT
    RPAD('OWNER', 10) || 
    RPAD('TABLE_NAME', 32) || 
    RPAD('COLUMN_NAME', 32) ||
    RPAD('LOB_NAME', 32) || 
    LPAD('PCTVERSION', 11) || 
    LPAD('RETENTION', 10) ||
    LPAD('CACHE', 11) ||
    LPAD('IN_ROW', 7) ||
    RPAD(' LOGGING', 9) LINE
  FROM DUAL
)
UNION ALL 
( SELECT  ' ' FROM DUAL )
UNION ALL
( SELECT
    RPAD(DL.OWNER, 10) ||
    RPAD(DL.TABLE_NAME, 32) ||
    RPAD(DL.COLUMN_NAME, 32) ||
    RPAD(DL.SEGMENT_NAME, 32) ||
    LPAD(NVL(TO_CHAR(DL.PCTVERSION), ' '), 11) ||
    LPAD(NVL(TO_CHAR(DL.RETENTION), ' '), 10) ||
    LPAD(DL.CACHE, 11) ||
    LPAD(DL.IN_ROW, 7) ||
    RPAD(' ' || LOGGING, 9) LINE
  FROM
    TABLE_INFO TI,
    DBA_LOBS DL
  WHERE
    TI.TABLE_OWNER = DL.OWNER AND
    TI.TABLE_NAME = DL.TABLE_NAME
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL 
( SELECT LPAD('*', 240, '*') FROM DUAL )
UNION ALL 
( SELECT  ' ' FROM DUAL )
UNION ALL 
( SELECT 'PARTITION INFORMATION (DBA_PART_KEY_COLUMNS):' FROM DUAL )
UNION ALL 
( SELECT  ' ' FROM DUAL )
UNION ALL
( SELECT
    RPAD('OWNER', 10) || 
    RPAD('SEGMENT_NAME', 32) || 
    RPAD('SEGMENT_TYPE', 13) ||
    RPAD('COLUMN_NAME', 20) || 
    LPAD('COLUMN_POSITION', 15) ||
    LPAD('PARTITIONING_TYPE', 18) LINE
  FROM DUAL
)
UNION ALL ( SELECT  ' ' FROM DUAL )
UNION ALL
( SELECT
    LINE
  FROM
  ( SELECT
      RPAD(OWNER, 10) ||
      RPAD(SEGMENT_NAME, 32) ||
      RPAD(SEGMENT_TYPE, 13) ||
      RPAD(COLUMN_NAME, 20) ||
      LPAD(COLUMN_POSITION, 15) ||
      LPAD(PARTITIONING_TYPE, 18) LINE
    FROM
    ( SELECT 
        PKC.OWNER,
        PKC.NAME SEGMENT_NAME,
        PKC.OBJECT_TYPE SEGMENT_TYPE,
        PKC.COLUMN_NAME,
        PKC.COLUMN_POSITION,
        PT.PARTITIONING_TYPE
      FROM
        TABLE_INFO TI,
        DBA_PART_KEY_COLUMNS PKC,
        DBA_PART_TABLES PT
      WHERE
        TI.TABLE_OWNER = PKC.OWNER AND
        TI.TABLE_NAME = PKC.NAME AND
        PKC.OBJECT_TYPE = 'TABLE' AND
        PT.OWNER = PKC.OWNER AND
        PT.TABLE_NAME = PKC.NAME
      UNION ALL
      ( SELECT
          PKC.OWNER,
          PKC.NAME SEGMENT_NAME,
          PKC.OBJECT_TYPE SEGMENT_TYPE,
          PKC.COLUMN_NAME,
          PKC.COLUMN_POSITION,
          PI.PARTITIONING_TYPE
        FROM
          INDEX_INFO II,
          DBA_PART_KEY_COLUMNS PKC,
          DBA_PART_INDEXES PI
        WHERE
          II.INDEX_OWNER = PKC.OWNER AND
          II.INDEX_NAME = PKC.NAME AND
          PKC.OBJECT_TYPE = 'INDEX' AND
          PI.OWNER = PKC.OWNER AND
          PI.INDEX_NAME = PKC.NAME
      )
    )
    ORDER BY
      OWNER,
      SEGMENT_NAME,
      COLUMN_POSITION
  )
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    '### Debugging info ### Elapsed time: ' || ROUND(L.CTIME - STS.SECONDS) ||
    ' s, logical reads: ' || TO_CHAR(SES1.VALUE - STS.BUFFER_GETS) || 
    ', physical reads: ' || TO_CHAR(SES2.VALUE - STS.DISK_READS) LINE
  FROM
    BASIS_INFO BI,
    START_STATE STS,
    V$SYSSTAT SYS1,
    V$SYSSTAT SYS2,
    V$MYSTAT SES1,
    V$MYSTAT SES2,
    ( SELECT CTIME FROM V$LOCK WHERE TYPE = 'MR' AND ROWNUM = 1) L
  WHERE
    BI.DEBUGGING_INFO = 'X' AND
    SYS1.NAME = 'session logical reads' AND 
    SYS1.STATISTIC# = SES1.STATISTIC# AND
    SYS2.NAME = 'physical reads' AND 
    SYS2.STATISTIC# = SES2.STATISTIC#
)
    UNION ALL
    ( SELECT LPAD('*', 240, '*') FROM DUAL )
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        'BUFFER POOL OCCUPATION (V$BH):' LINE
      FROM
        DUAL
    )
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        RPAD('SEGMENT_NAME', 35) ||
        RPAD('PARTITION_NAME', 30) ||
        RPAD('SEGMENT_TYPE', 16) ||
        RPAD('POOL', 8) ||
        LPAD('BLKSIZE', 8) ||
        LPAD('POOL_GB', 8) ||
        LPAD('SEG_POOL_MB', 12) ||
        LPAD('POOL_%', 7) ||
        LPAD('SEG_DISK_MB', 12) ||
        LPAD('SEG_CACHED_%', 13) ||
        LPAD('DIRTY_%', 8) LINE
      FROM
        DUAL
    ) 
    UNION ALL
    ( SELECT ' ' FROM DUAL )
    UNION ALL
    ( SELECT
        RPAD(SEGMENT_NAME, 35) ||
        RPAD(PARTITION_NAME, 30) ||
        RPAD(SEGMENT_TYPE, 16) ||
        RPAD(POOL, 8) ||
        LPAD(BLKSIZE, 8) ||
        LPAD(POOL_GB, 8) ||
        LPAD(SEG_POOL_MB, 12) ||
        LPAD("POOL_%", 7) ||
        LPAD(SEG_DISK_MB, 12) ||
        LPAD("SEG_CACHED_%", 13) ||
        LPAD("DIRTY_%", 8) LINE
      FROM
      ( SELECT 
          OWNER,
          SEGMENT_NAME,
          NVL(PARTITION_NAME, ' ') PARTITION_NAME,
          SEGMENT_TYPE,
          BUFFER_POOL POOL,
          BLOCK_SIZE BLKSIZE,
          TO_CHAR(POOL_SIZE_MB / 1024, 990.99) POOL_GB,
          TO_CHAR(BLOCKS * BLOCK_SIZE / 1024 / 1024, 9999990.99) SEG_POOL_MB,
          TO_CHAR(DECODE(POOL_SIZE_MB, 0, 0, BLOCKS * BLOCK_SIZE / 1024 / 1024 / 
            POOL_SIZE_MB * 100), 990.99) "POOL_%",
          TO_CHAR(SEG_DISK_BYTE / 1024 / 1024, 9999990.99) SEG_DISK_MB,
          TO_CHAR(DECODE(SEG_DISK_BYTE, 0, 0, BLOCKS * BLOCK_SIZE / 
            SEG_DISK_BYTE * 100), 99999990.99) "SEG_CACHED_%",
          TO_CHAR(DECODE(BLOCKS, 0, 0, DIRTY_BLOCKS / BLOCKS * 100), 
            990.99) "DIRTY_%"
        FROM 
        ( SELECT 
            S.OWNER,
            S.SEGMENT_NAME,
            S.PARTITION_NAME,
            S.SEGMENT_TYPE,
            S.BYTES SEG_DISK_BYTE,
            COUNT(*) BLOCKS,
            SUM(DECODE(B.DIRTY, 'Y', 1, 0)) DIRTY_BLOCKS,
            C.POOL_SIZE_MB,
            C.BUFFER_POOL,
            C.BLOCK_SIZE,
            ROW_NUMBER() OVER (PARTITION BY O.DATA_OBJECT_ID 
              ORDER BY O.OBJECT_TYPE) CLUSTRN
          FROM 
            SEGMENTS S,
            DBA_OBJECTS O, 
            V$BH B,
            CACHES C
          WHERE 
            S.OWNER = O.OWNER AND
            S.SEGMENT_NAME = O.OBJECT_NAME AND
            NVL(S.PARTITION_NAME, ' ') = NVL(O.SUBOBJECT_NAME, ' ') AND
            O.DATA_OBJECT_ID = B.OBJD (+) AND
            C.BUFFER_POOL = S.BUFFER_POOL AND
            C.BLOCK_SIZE = S.BLOCK_SIZE AND
            C.POOL_SIZE_MB > 0
          GROUP BY
            S.OWNER,
            S.SEGMENT_NAME,
            S.PARTITION_NAME, 
            S.SEGMENT_TYPE,
            S.BYTES,
            C.POOL_SIZE_MB,
            C.BUFFER_POOL,
            C.BLOCK_SIZE,
            O.DATA_OBJECT_ID,
            O.OBJECT_TYPE
        )
        WHERE
          CLUSTRN = 1 
        ORDER BY 
          SEG_POOL_MB DESC
      )
      WHERE
        ROWNUM <= 20
    )
  )
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    '### Debugging info ### Elapsed time: ' || ROUND(L.CTIME - STS.SECONDS) ||
    ' s, logical reads: ' || TO_CHAR(SES1.VALUE - STS.BUFFER_GETS) || 
    ', physical reads: ' || TO_CHAR(SES2.VALUE - STS.DISK_READS) LINE
  FROM
    BASIS_INFO BI,
    START_STATE STS,
    V$SYSSTAT SYS1,
    V$SYSSTAT SYS2,
    V$MYSTAT SES1,
    V$MYSTAT SES2,
    ( SELECT CTIME FROM V$LOCK WHERE TYPE = 'MR' AND ROWNUM = 1) L
  WHERE
    BI.DEBUGGING_INFO = 'X' AND
    SYS1.NAME = 'session logical reads' AND 
    SYS1.STATISTIC# = SES1.STATISTIC# AND
    SYS2.NAME = 'physical reads' AND 
    SYS2.STATISTIC# = SES2.STATISTIC#
)
UNION ALL
( SELECT LPAD('*', 240, '*') FROM DUAL )
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    'UNDO STATISTICS (V$UNDOSTAT):' LINE
  FROM
    DUAL
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    RPAD('BEGIN_TIME', 19) ||
    LPAD('MAXQUERYLEN', 12) ||
    LPAD('TUNED_UNDORETENTION', 20)
  FROM
    DUAL
) 
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    *
  FROM
  ( SELECT
      RPAD(TO_CHAR(BEGIN_TIME, 'YYYY-MM-DD HH24:MI:SS'), 19) ||
      LPAD(MAXQUERYLEN, 12) ||
      LPAD(TUNED_UNDORETENTION, 20)
    FROM
      BASIS_INFO BI,
      V$UNDOSTAT UST
    WHERE
      UST.MAXQUERYID = BI.SQL_ID
    ORDER BY
      BEGIN_TIME DESC
  )
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    '### Debugging info ### Elapsed time: ' || ROUND(L.CTIME - STS.SECONDS) ||
    ' s, logical reads: ' || TO_CHAR(SES1.VALUE - STS.BUFFER_GETS) || 
    ', physical reads: ' || TO_CHAR(SES2.VALUE - STS.DISK_READS) LINE
  FROM
    BASIS_INFO BI,
    START_STATE STS,
    V$SYSSTAT SYS1,
    V$SYSSTAT SYS2,
    V$MYSTAT SES1,
    V$MYSTAT SES2,
    ( SELECT CTIME FROM V$LOCK WHERE TYPE = 'MR' AND ROWNUM = 1) L
  WHERE
    BI.DEBUGGING_INFO = 'X' AND
    SYS1.NAME = 'session logical reads' AND 
    SYS1.STATISTIC# = SES1.STATISTIC# AND
    SYS2.NAME = 'physical reads' AND 
    SYS2.STATISTIC# = SES2.STATISTIC#
)
UNION ALL
( SELECT LPAD('*', 240, '*') FROM DUAL )
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    'PARAMETER SETTINGS (V$PARAMETER2):' LINE
  FROM DUAL
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    RPAD('PARAMETER_NAME', 40) ||
    RPAD('IS_DEFAULT', 11) ||
    RPAD(' VALUE', 189) LINE
  FROM DUAL
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT * FROM
  ( SELECT RPAD(NAME, 40) || RPAD(ISDEFAULT, 11) || RPAD(' ' || VALUE, 189) LINE
    FROM V$PARAMETER2
    WHERE
      NAME LIKE '\_%' ESCAPE '\' OR UPPER(NAME) LIKE 'OPTIMIZER%' OR
      UPPER(NAME) IN ('EVENT', 'DB_FILE_MULTIBLOCK_READ_COUNT',
        'PGA_AGGREGATE_TARGET', 'WORKAREA_SIZE_POLICY', 'DB_CACHE_SIZE',
        'SGA_TARGET', 'STAR_TRANSFORMATION_ENABLED')
    ORDER BY 
      UPPER(NAME), 
      VALUE
  )
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT 'PARAMETER CHANGES (DBA_HIST_PARAMETER):' LINE FROM DUAL
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    RPAD('BEGIN_TIME', 19) || 
    RPAD(' PARAMETER_NAME', 40) ||
    RPAD('VALUE', 60) || 
    RPAD('IS_DEFAULT', 11) ||
    RPAD('VALUE_BEFORE', 60) || 
    RPAD('WAS_DEFAULT', 12) LINE
  FROM DUAL
)
UNION ALL
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    RPAD(BEGIN_TIME, 19) || 
    RPAD(' ' || PARAMETER_NAME, 40) || 
    RPAD(NVL(VALUE, ' '), 60) ||
    RPAD(IS_DEFAULT, 11) || 
    RPAD(NVL(VALUE_BEFORE, ' '), 60) || 
    RPAD(WAS_DEFAULT, 12) LINE
  FROM
  ( SELECT
      DECODE(R.ID, 1, TO_CHAR(BEGIN_INTERVAL_TIME,
        'YYYY-MM-DD HH24:MI:SS'), ' ') BEGIN_TIME,
      DECODE(R.ID, 1, PARAMETER_NAME, ' ') PARAMETER_NAME,
      SUBSTR(VALUE, 1 + 59 * (R.ID - 1), 59) VALUE,
      DECODE(R.ID, 1, IS_DEFAULT, ' ') IS_DEFAULT,
      SUBSTR(VALUE_BEFORE, 1 + 59 * (R.ID - 1), 59) VALUE_BEFORE,
      DECODE(R.ID, 1, WAS_DEFAULT, ' ') WAS_DEFAULT
    FROM
    ( SELECT ROWNUM ID FROM V$SESSTAT WHERE ROWNUM <= 20 ) R,
    ( SELECT 
        HSS.BEGIN_INTERVAL_TIME, 
        HP2.PARAMETER_NAME PARAMETER_NAME, 
        HP2.VALUE VALUE,
        NVL(HP2.ISDEFAULT, 'UNKNOWN') IS_DEFAULT, 
        HP1.VALUE VALUE_BEFORE, 
        NVL(HP1.ISDEFAULT, 'UNKNOWN') WAS_DEFAULT
      FROM
        V$INSTANCE I,
        DBA_HIST_PARAMETER HP1, 
        DBA_HIST_PARAMETER HP2, 
        DBA_HIST_SNAPSHOT HSS
      WHERE
        I.INSTANCE_NUMBER = HP1.INSTANCE_NUMBER AND
        I.INSTANCE_NUMBER = HP2.INSTANCE_NUMBER AND
        I.INSTANCE_NUMBER = HSS.INSTANCE_NUMBER AND
        HP2.SNAP_ID = HSS.SNAP_ID AND 
        HP1.SNAP_ID = HP2.SNAP_ID - 1 AND
        HP1.PARAMETER_NAME = HP2.PARAMETER_NAME AND 
        ( HP2.VALUE != HP1.VALUE OR HP2.ISDEFAULT != HP1.ISDEFAULT )
      UNION 
      ( SELECT 
          HSS.BEGIN_INTERVAL_TIME, 
          HP2.PARAMETER_NAME, HP2.VALUE,
          NVL(HP2.ISDEFAULT, 'UNKNOWN') IS_DEFAULT, 
          NULL VALUE_BEFORE, 
          'TRUE' WAS_DEFAULT
        FROM 
          V$INSTANCE I,
          DBA_HIST_PARAMETER HP2, 
          DBA_HIST_SNAPSHOT HSS
        WHERE
          I.INSTANCE_NUMBER = HP2.INSTANCE_NUMBER AND
          I.INSTANCE_NUMBER = HSS.INSTANCE_NUMBER AND
          HP2.SNAP_ID = HSS.SNAP_ID AND
          EXISTS
          ( SELECT 
              * 
            FROM 
              DBA_HIST_PARAMETER HP1
            WHERE 
              I.INSTANCE_NUMBER = HP1.INSTANCE_NUMBER AND
              HP1.SNAP_ID = HP2.SNAP_ID - 1 AND 
              HP1.PARAMETER_NAME = 'sessions'
          ) AND
          NOT EXISTS
          ( SELECT 
              * 
            FROM 
              DBA_HIST_PARAMETER HP1 
            WHERE 
              I.INSTANCE_NUMBER = HP1.INSTANCE_NUMBER AND
              HP1.SNAP_ID = HP2.SNAP_ID - 1 AND 
              HP1.PARAMETER_NAME = HP2.PARAMETER_NAME
          )
      )
      UNION 
      ( SELECT 
          HSS.BEGIN_INTERVAL_TIME, 
          HP1.PARAMETER_NAME, 
          NULL VALUE,
          'TRUE' IS_DEFAULT, 
          HP1.VALUE VALUE_BEFORE, 
          NVL(HP1.ISDEFAULT, 'UNKNOWN') WAS_DEFAULT
        FROM 
          V$INSTANCE I,
          DBA_HIST_PARAMETER HP1, 
          DBA_HIST_SNAPSHOT HSS
        WHERE
          I.INSTANCE_NUMBER = HP1.INSTANCE_NUMBER AND
          I.INSTANCE_NUMBER = HSS.INSTANCE_NUMBER AND
          HP1.SNAP_ID = HSS.SNAP_ID AND
          EXISTS
          ( SELECT 
              *
            FROM 
              DBA_HIST_PARAMETER HP2 
            WHERE 
              I.INSTANCE_NUMBER = HP2.INSTANCE_NUMBER AND
              HP1.SNAP_ID = HP2.SNAP_ID - 1 AND 
              HP2.PARAMETER_NAME = 'sessions'
          ) AND
          NOT EXISTS
          ( SELECT
              *
            FROM 
              DBA_HIST_PARAMETER HP2
            WHERE 
              I.INSTANCE_NUMBER = HP2.INSTANCE_NUMBER AND
              HP1.SNAP_ID = HP2.SNAP_ID - 1 AND 
              HP1.PARAMETER_NAME = HP2.PARAMETER_NAME
          )
      )
    ) P
    WHERE 
      R.ID <= TRUNC(LENGTH(P.VALUE) - 1) / 59 + 1 OR 
      R.ID <= TRUNC(LENGTH(P.VALUE_BEFORE) - 1) / 59 + 1 OR 
      R.ID <= 1
    ORDER BY 
      P.BEGIN_INTERVAL_TIME DESC, 
      P.PARAMETER_NAME, 
      R.ID
  )
)
UNION ALL ( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    '### Debugging info ### Elapsed time: ' || ROUND(L.CTIME - STS.SECONDS) ||
    ' s, logical reads: ' || TO_CHAR(SES1.VALUE - STS.BUFFER_GETS) || 
    ', physical reads: ' || TO_CHAR(SES2.VALUE - STS.DISK_READS) LINE
  FROM
    BASIS_INFO BI,
    START_STATE STS,
    V$SYSSTAT SYS1,
    V$SYSSTAT SYS2,
    V$MYSTAT SES1,
    V$MYSTAT SES2,
    ( SELECT CTIME FROM V$LOCK WHERE TYPE = 'MR' AND ROWNUM = 1) L
  WHERE
    BI.DEBUGGING_INFO = 'X' AND
    SYS1.NAME = 'session logical reads' AND 
    SYS1.STATISTIC# = SES1.STATISTIC# AND
    SYS2.NAME = 'physical reads' AND 
    SYS2.STATISTIC# = SES2.STATISTIC#
)
UNION ALL 
( SELECT LPAD('*', 240, '*') FROM DUAL )
UNION ALL 
( SELECT ' ' FROM DUAL )
UNION ALL 
( SELECT 
    'BIND VALUES (V$SQL_BIND_CAPTURE, DBA_HIST_SQLBIND):' 
  FROM
    DUAL 
)
UNION ALL 
( SELECT ' ' FROM DUAL )
UNION ALL 
( SELECT
    'SAMPLES: ' || COUNT(DISTINCT(CAPTURE_TIME)) LINE
  FROM
    BIND_CONTENTS
)
UNION ALL 
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT 
    LPAD('CAPTURE_TIME', 19) || 
    LPAD('NAME', 10) || 
    RPAD(' VALUE', 80) 
  FROM 
    DUAL 
)
UNION ALL 
( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT 
    * 
  FROM
  ( SELECT
      RPAD(CAPTURE_TIME, 19) || 
      LPAD(NAME, 10) || 
      RPAD(' ' || VALUE_STRING, 80)
    FROM
    ( SELECT 
        * 
      FROM
      ( SELECT 
          DECODE(ROWNUM, 1, 'CONSTANT', ' ') CAPTURE_TIME,
          NAME, 
          '''' || EXAMPLE_VALUE || '''' VALUE_STRING
        FROM 
          DISTINCT_LITERALS
        WHERE 
          NUM_DISTINCT = 1
        ORDER BY 
          POSITION
      )
      UNION ALL ( SELECT NULL, NULL, NULL FROM DUAL )
      UNION ALL
      ( SELECT 
          * 
        FROM
        ( SELECT
            DECODE(CAPTURE_TIME, LAG(CAPTURE_TIME, 1) OVER
              (ORDER BY CAPTURE_TIME DESC, BC.POSITION), 
              ' ', TO_CHAR(CAPTURE_TIME, 'YYYY-MM-DD HH24:MI:SS')) CAPTURE_TIME,
            BC.NAME NAME, 
            '''' || VALUE_STRING || '''' VALUE_STRING
          FROM 
            BIND_CONTENTS BC, 
            DISTINCT_LITERALS DL
          WHERE 
            BC.NAME = DL.NAME AND 
            DL.NUM_DISTINCT > 1
          ORDER BY 
            BC.CAPTURE_TIME DESC, 
            BC.POSITION
        )
      )
    )
  )
)
UNION ALL ( SELECT ' ' FROM DUAL )
UNION ALL
( SELECT
    '### Debugging info ### Elapsed time: ' || ROUND(L.CTIME - STS.SECONDS) ||
    ' s, logical reads: ' || TO_CHAR(SES1.VALUE - STS.BUFFER_GETS) || 
    ', physical reads: ' || TO_CHAR(SES2.VALUE - STS.DISK_READS) LINE
  FROM
    BASIS_INFO BI,
    START_STATE STS,
    V$SYSSTAT SYS1,
    V$SYSSTAT SYS2,
    V$MYSTAT SES1,
    V$MYSTAT SES2,
    ( SELECT CTIME FROM V$LOCK WHERE TYPE = 'MR' AND ROWNUM = 1) L
  WHERE
    BI.DEBUGGING_INFO = 'X' AND
    SYS1.NAME = 'session logical reads' AND 
    SYS1.STATISTIC# = SES1.STATISTIC# AND
    SYS2.NAME = 'physical reads' AND 
    SYS2.STATISTIC# = SES2.STATISTIC#
)
UNION ALL
( SELECT
    '### Debugging info ### My own SQL_ID: ' || S.SQL_ID LINE
  FROM
    BASIS_INFO BI,
    V$SESSION S
  WHERE
    BI.DEBUGGING_INFO = 'X' AND
    S.SID = ( SELECT SID FROM V$MYSTAT WHERE ROWNUM = 1 )
)
UNION ALL
( SELECT ' ' LINE FROM BASIS_INFO WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM START_STATE WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM SNAPSHOTS WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM SQL_TEXT_LOB WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM START_POSITIONS WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM START_END_POSITIONS WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM START_END_LINE_POSITIONS WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM ASH_DISTRIBUTION WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM TABLE_INFO WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM TABLE_STORAGE WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM TABLE_MODIFICATIONS WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM TABLE_COLUMNS WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM INDEX_INFO WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM INDEX_STORAGE WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM INDEX_ROWS_HELPER WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM INDEX_ROWS WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM INDEX_STATISTICS WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM SEGMENT_INFO WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM SEGMENTS WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM CACHES WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM BIND_CONTENTS WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM DISTINCT_LITERALS WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM SQL_SHARED_CURSOR WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM SQL_PLANS WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM PREDICATE_INFOS WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM PRED_START_POSITIONS WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM PRED_START_END_POSITIONS WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM PRED_START_END_LINE_POSITIONS WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM LINES WHERE 1 = 0 )
UNION ALL
( SELECT ' ' LINE FROM SEGMENT_STATISTICS WHERE 1 = 0 )
)
));
