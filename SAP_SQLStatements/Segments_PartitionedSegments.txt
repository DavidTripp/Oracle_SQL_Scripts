SELECT NULL SEGMENT_NAME, NULL PART_TYPE, NULL PARTS, NULL PART_COLUMNS, NULL SUBPART_TYPE,
  NULL SUBPARTS, NULL SUBPART_COLUMNS, NULL COMPRESSION, NULL BUFFER_POOL FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT NULL SEGMENT_NAME, NULL PART_TYPE, NULL PARTS, NULL PART_COLUMNS, NULL SUBPART_TYPE,
  NULL SUBPARTS, NULL SUBPART_COLUMNS, NULL COMPRESSION, NULL BUFFER_POOL FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT
    'SAP%' OWNER,
    '%' TABLE_NAME,
    'X' EXCLUDE_BW_TABLES
  FROM
    DUAL
),
PART_RELEVANT_TABLES_HELPER AS
( SELECT /*+ MATERIALIZE */
    *
  FROM
  ( SELECT
      OWNER,
      TABLE_NAME,
      PART_TYPE,
      PARTS,
      COLUMN_NAME || ' ' || 
        LEAD(COLUMN_NAME, 1) OVER (PARTITION BY OWNER, TABLE_NAME ORDER BY COLUMN_POSITION) || ' ' ||
        LEAD(COLUMN_NAME, 2) OVER (PARTITION BY OWNER, TABLE_NAME ORDER BY COLUMN_POSITION) || ' ' ||
        LEAD(COLUMN_NAME, 3) OVER (PARTITION BY OWNER, TABLE_NAME ORDER BY COLUMN_POSITION) || ' ' ||
        LEAD(COLUMN_NAME, 4) OVER (PARTITION BY OWNER, TABLE_NAME ORDER BY COLUMN_POSITION) PART_COLUMNS,
      DECODE(SUBPART_TYPE, 'NONE', NULL, SUBPART_TYPE) SUBPART_TYPE,
      DECODE(SUBPARTS, 0, NULL, SUBPARTS) SUBPARTS,
      COMPRESSION,
      BUFFER_POOL,
      COLUMN_POSITION
    FROM
    ( SELECT
        DPT.OWNER OWNER,
        DPT.TABLE_NAME TABLE_NAME,
        DPT.PARTITIONING_TYPE PART_TYPE,
        DPT.PARTITION_COUNT PARTS,
        DPT.SUBPARTITIONING_TYPE SUBPART_TYPE,
        DPT.DEF_SUBPARTITION_COUNT SUBPARTS,
        DPT.DEF_COMPRESSION COMPRESSION,
        DPT.DEF_BUFFER_POOL BUFFER_POOL,
        DPK.COLUMN_NAME, 
        DPK.COLUMN_POSITION    
      FROM
        BASIS_INFO BI,
        DBA_PART_TABLES DPT,
        DBA_PART_KEY_COLUMNS DPK
      WHERE
        DPT.OWNER LIKE BI.OWNER AND
        DPT.TABLE_NAME LIKE BI.TABLE_NAME AND
        ( BI.EXCLUDE_BW_TABLES = ' ' OR DPT.TABLE_NAME NOT LIKE '/BI%' ) AND
        DPT.OWNER = DPK.OWNER AND
        DPT.TABLE_NAME = DPK.NAME AND
        DPK.OBJECT_TYPE = 'TABLE'
      UNION
      ( SELECT
          I.TABLE_OWNER OWNER,
          I.TABLE_NAME,
          DPT.PARTITIONING_TYPE PART_TYPE,
          DPT.PARTITION_COUNT PARTS,
          DPT.SUBPARTITIONING_TYPE SUBPART_TYPE,
          DPT.DEF_SUBPARTITION_COUNT SUBPARTS,
          NVL(DPT.DEF_COMPRESSION, T.COMPRESSION) COMPRESSION,
          NVL(DPT.DEF_BUFFER_POOL, T.BUFFER_POOL) BUFFER_POOL,
          DPK.COLUMN_NAME, 
          NVL(DPK.COLUMN_POSITION, 1) COLUMN_POSITION    
        FROM
          BASIS_INFO BI,
          DBA_INDEXES I,
          DBA_PART_INDEXES PI,
          DBA_TABLES T,
          DBA_PART_TABLES DPT,
          DBA_PART_KEY_COLUMNS DPK
        WHERE
          I.TABLE_OWNER LIKE BI.OWNER AND
          I.TABLE_NAME LIKE BI.TABLE_NAME AND
          ( BI.EXCLUDE_BW_TABLES = ' ' OR I.TABLE_NAME NOT LIKE '/BI%' ) AND
          I.OWNER = PI.OWNER AND
          I.INDEX_NAME = PI.INDEX_NAME AND
          I.TABLE_OWNER = T.OWNER AND
          I.TABLE_NAME = T.TABLE_NAME AND
          I.TABLE_OWNER = DPK.OWNER (+) AND
          I.TABLE_NAME = DPK.NAME (+) AND
          I.TABLE_OWNER = DPT.OWNER (+) AND
          I.TABLE_NAME = DPT.TABLE_NAME (+) AND
          DPK.OBJECT_TYPE (+) = 'TABLE'
      )
    )
  )
  WHERE 
    COLUMN_POSITION = 1
),
PART_RELEVANT_TABLES AS
( SELECT
    * /*+ MATERIALIZE */
  FROM
  ( SELECT
      OWNER,
      TABLE_NAME,
      PART_TYPE,
      PARTS,
      PART_COLUMNS,
      SUBPART_TYPE,
      SUBPARTS,
      DECODE(COLUMN_NAME, NULL, NULL,
        COLUMN_NAME || ' ' || 
        LEAD(COLUMN_NAME, 1) OVER (PARTITION BY OWNER, TABLE_NAME ORDER BY COLUMN_POSITION) || ' ' ||
        LEAD(COLUMN_NAME, 2) OVER (PARTITION BY OWNER, TABLE_NAME ORDER BY COLUMN_POSITION) || ' ' ||
        LEAD(COLUMN_NAME, 3) OVER (PARTITION BY OWNER, TABLE_NAME ORDER BY COLUMN_POSITION) || ' ' ||
        LEAD(COLUMN_NAME, 4) OVER (PARTITION BY OWNER, TABLE_NAME ORDER BY COLUMN_POSITION)) SUBPART_COLUMNS,
      COMPRESSION,
      BUFFER_POOL,
      COLUMN_POSITION
    FROM
    ( SELECT
        DPT.OWNER OWNER,
        DPT.TABLE_NAME TABLE_NAME,
        PART_TYPE,
        PARTS,
        PART_COLUMNS,
        SUBPART_TYPE,
        SUBPARTS,
        COMPRESSION,
        BUFFER_POOL,
        COLUMN_NAME, 
        NVL(DPK.COLUMN_POSITION, 1) COLUMN_POSITION 
      FROM
        PART_RELEVANT_TABLES_HELPER DPT,
        DBA_SUBPART_KEY_COLUMNS DPK
      WHERE
        DPT.OWNER = DPK.OWNER (+) AND
        DPT.TABLE_NAME = DPK.NAME (+) AND
        DPK.OBJECT_TYPE (+) = 'TABLE'
    )
  )
  WHERE 
    COLUMN_POSITION = 1
),    
INDEXES_OF_PART_TABLES_HELPER AS
( SELECT /*+ MATERIALIZE */
    *
  FROM
  ( SELECT
      OWNER,
      TABLE_NAME,
      INDEX_NAME,
      PART_TYPE,
      PARTS,
      DECODE(COLUMN_NAME, NULL, NULL,
        COLUMN_NAME || ' ' || 
        LEAD(COLUMN_NAME, 1) OVER (PARTITION BY OWNER, TABLE_NAME, INDEX_NAME ORDER BY COLUMN_POSITION) || ' ' ||
        LEAD(COLUMN_NAME, 2) OVER (PARTITION BY OWNER, TABLE_NAME, INDEX_NAME ORDER BY COLUMN_POSITION) || ' ' ||
        LEAD(COLUMN_NAME, 3) OVER (PARTITION BY OWNER, TABLE_NAME, INDEX_NAME ORDER BY COLUMN_POSITION) || ' ' ||
        LEAD(COLUMN_NAME, 4) OVER (PARTITION BY OWNER, TABLE_NAME, INDEX_NAME ORDER BY COLUMN_POSITION)) PART_COLUMNS,
      DECODE(SUBPART_TYPE, 'NONE', NULL, SUBPART_TYPE) SUBPART_TYPE,
      DECODE(SUBPARTS, 0, NULL, SUBPARTS) SUBPARTS,
      NULL SUBPART_COLUMNS,
      COMPRESSION,
      BUFFER_POOL,
      COLUMN_POSITION    
    FROM
    ( SELECT 
        PT.OWNER OWNER,
        PT.TABLE_NAME TABLE_NAME,
        DI.INDEX_NAME INDEX_NAME,
        DPI.PARTITIONING_TYPE PART_TYPE,
        DPI.PARTITION_COUNT PARTS,
        DPI.SUBPARTITIONING_TYPE SUBPART_TYPE,
        DPI.DEF_SUBPARTITION_COUNT SUBPARTS,
        DECODE(DI.COMPRESSION, 'DISABLED', 'DISABLED', 
          DI.COMPRESSION || ' (' || NVL(PREFIX_LENGTH, 0) || ')') COMPRESSION,
        NVL(DPI.DEF_BUFFER_POOL, DI.BUFFER_POOL) BUFFER_POOL,
        COLUMN_NAME,
        NVL(DPK.COLUMN_POSITION, 1) COLUMN_POSITION    
      FROM
        PART_RELEVANT_TABLES PT,
        DBA_INDEXES DI,
        DBA_PART_INDEXES DPI,
        DBA_PART_KEY_COLUMNS DPK
      WHERE
        PT.OWNER = DI.TABLE_OWNER AND
        PT.TABLE_NAME = DI.TABLE_NAME AND
        DI.OWNER = DPI.OWNER (+) AND
        DI.INDEX_NAME = DPI.INDEX_NAME (+) AND
        DI.INDEX_TYPE != 'LOB' AND
        DPI.OWNER = DPK.OWNER (+) AND
        DPI.INDEX_NAME = DPK.NAME (+) AND
        DPK.OBJECT_TYPE (+) = 'INDEX'
    )
  )
  WHERE
    COLUMN_POSITION = 1
),
INDEXES_OF_PART_REL_TABLES AS
( SELECT /*+ MATERIALIZE */
    *
  FROM
  ( SELECT
      OWNER,
      TABLE_NAME,
      INDEX_NAME,
      PART_TYPE,
      PARTS,
      PART_COLUMNS,
      SUBPART_TYPE,
      SUBPARTS,
      DECODE(COLUMN_NAME, NULL, NULL,
        COLUMN_NAME || ' ' || 
        LEAD(COLUMN_NAME, 1) OVER (PARTITION BY OWNER, TABLE_NAME, INDEX_NAME ORDER BY COLUMN_POSITION) || ' ' ||
        LEAD(COLUMN_NAME, 2) OVER (PARTITION BY OWNER, TABLE_NAME, INDEX_NAME ORDER BY COLUMN_POSITION) || ' ' ||
        LEAD(COLUMN_NAME, 3) OVER (PARTITION BY OWNER, TABLE_NAME, INDEX_NAME ORDER BY COLUMN_POSITION) || ' ' ||
        LEAD(COLUMN_NAME, 4) OVER (PARTITION BY OWNER, TABLE_NAME, INDEX_NAME ORDER BY COLUMN_POSITION)) SUBPART_COLUMNS,
      COMPRESSION,
      BUFFER_POOL,
      COLUMN_POSITION    
    FROM
    ( SELECT 
        DPI.OWNER OWNER,
        DPI.TABLE_NAME TABLE_NAME,
        DPI.INDEX_NAME INDEX_NAME,
        PART_TYPE,
        PARTS,
        PART_COLUMNS,
        SUBPART_TYPE,
        SUBPARTS,
        SUBPART_COLUMNS,
        COMPRESSION,
        BUFFER_POOL,
        COLUMN_NAME,
        NVL(DPK.COLUMN_POSITION, 1) COLUMN_POSITION    
      FROM
        INDEXES_OF_PART_TABLES_HELPER DPI,
        DBA_SUBPART_KEY_COLUMNS DPK
      WHERE
        DPI.OWNER = DPK.OWNER (+) AND
        DPI.INDEX_NAME = DPK.NAME (+) AND
        DPK.OBJECT_TYPE (+) = 'INDEX'
    )
  )
  WHERE
    COLUMN_POSITION = 1
)
SELECT
  DECODE(INDEX_NAME, ' ', TABLE_NAME, '  ' || INDEX_NAME) SEGMENT_NAME,
  PART_TYPE,
  TO_CHAR(PARTS, 9999990) PARTS,
  PART_COLUMNS,
  SUBPART_TYPE,
  TO_CHAR(SUBPARTS, 9999990) SUBPARTS,
  SUBPART_COLUMNS, 
  COMPRESSION,
  BUFFER_POOL
FROM
( SELECT
    OWNER,
    TABLE_NAME,
    ' ' INDEX_NAME,
    PART_TYPE,
    PARTS,
    PART_COLUMNS,
    SUBPART_TYPE,
    SUBPARTS,
    SUBPART_COLUMNS,
    COMPRESSION,
    BUFFER_POOL
  FROM
    PART_RELEVANT_TABLES
  UNION ALL
  ( SELECT
      OWNER,
      TABLE_NAME,
      INDEX_NAME,
      PART_TYPE,
      PARTS,
      PART_COLUMNS,
      SUBPART_TYPE,
      SUBPARTS,
      SUBPART_COLUMNS,
      COMPRESSION,
      BUFFER_POOL
    FROM
      INDEXES_OF_PART_REL_TABLES
  )
)
ORDER BY
  TABLE_NAME,
  INDEX_NAME
));  
