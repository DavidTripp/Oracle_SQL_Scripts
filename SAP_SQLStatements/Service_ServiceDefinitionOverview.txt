SELECT NULL SERVICE_NAME, NULL SETUP_METHOD, NULL ACTIVE, NULL USED_BY_SAPAS, NULL TFA_CONFIG FROM DUAL WHERE 1=0
UNION ALL
(SELECT NULL SERVICE_NAME, NULL SETUP_METHOD, NULL ACTIVE, NULL USED_BY_SAPAS, NULL TFA_CONFIG FROM DUAL WHERE 1=0)
UNION ALL
SELECT * FROM (
WITH GVSP AS
(
SELECT
	UNIQUE VALUE, INST_ID
FROM
	GV$SPPARAMETER
WHERE
	NAME = 'service_names'
),
GVS AS
( SELECT UNIQUE SERVICE_NAME, PROGRAM, MACHINE FROM GV$SESSION WHERE 
	SERVICE_NAME NOT LIKE 'SYS%' AND USERNAME LIKE 'SAP%' AND PROGRAM NOT LIKE 'oracle%')
SELECT 
	DECODE(SERVICE_NAME_DEFINED, LAG(SERVICE_NAME_DEFINED,1) OVER
		(ORDER BY SERVICE_NAME_DEFINED),
		' ', SERVICE_NAME_DEFINED) SERVICE_NAME,
	SETUP_METHOD,
	ACTIVE,
	USED_BY_SAPAS,
	TFA_CONFIG
FROM
(
	SELECT
		DS.NAME SERVICE_NAME_DEFINED,
		DECODE(GVSP.INST_ID, NULL,'SRVCTL','SPFile (Instance '||GVSP.INST_ID||')') SETUP_METHOD, 
		DECODE(GVAS.INST_ID, NULL,'NO','Active on Instance '||GVAS.INST_ID) ACTIVE,
		DECODE(GVS.SERVICE_NAME, NULL, 'NO', GVS.PROGRAM||' ('||GVS.MACHINE||')') USED_BY_SAPAS,
		DECODE(DS.FAILOVER_METHOD,NULL,'Not Configured',DS.FAILOVER_METHOD||'/'||DS.FAILOVER_TYPE) TFA_CONFIG
	FROM
		DBA_SERVICES DS,
		GV$ACTIVE_SERVICES GVAS,
		GVSP,
		GVS
	WHERE
		DS.NAME = GVSP.VALUE (+) AND
		DS.NAME = GVAS.NAME (+)	AND
		DS.NAME = GVS.SERVICE_NAME (+) AND
		DS.NAME NOT LIKE 'SYS%'
	ORDER BY
		DS.NAME,
		GVSP.INST_ID,
		GVAS.INST_ID
));
