SELECT NULL OWNER, NULL TABLE_NAME, NULL PART_NAME, NULL TOTAL_ROWS,
  NULL CHAINED_ROWS, NULL "CHAIN_%" FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT NULL OWNER, NULL TABLE_NAME, NULL PART_NAME, NULL TOTAL_ROWS,
  NULL CHAINED_ROWS, NULL "CHAIN_%" FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS /* Wrong data due to bug 13621258, fixed in SBP 01/2013 */
( SELECT
    OWNER,
    BEGIN_DATE,
    END_DATE,
    TO_TIMESTAMP(TO_CHAR(BEGIN_DATE, 'dd.mm.yyyy hh24:mi:ss'), 
      'dd.mm.yyyy hh24:mi:ss') BEGIN_TIME,
    TO_TIMESTAMP(TO_CHAR(END_DATE, 'dd.mm.yyyy hh24:mi:ss'), 
      'dd.mm.yyyy hh24:mi:ss') END_TIME,
    MIN_CHAINED_ROW_THRESHOLD
  FROM
  ( SELECT
      'SAP%' OWNER,
      TO_DATE('01.01.1000 14:27:44', 'dd.mm.yyyy hh24:mi:ss') BEGIN_DATE,
      TO_DATE('31.12.9999 14:37:26', 'dd.mm.yyyy hh24:mi:ss') END_DATE,
      -1 MIN_CHAINED_ROW_THRESHOLD
    FROM
      DUAL
  )
),
SNAPSHOTS AS
( SELECT 
    MIN(HSS.SNAP_ID) BEGIN_SNAP_ID,
    MAX(HSS.SNAP_ID) END_SNAP_ID
  FROM 
    BASIS_INFO BI,
    DBA_HIST_SNAPSHOT HSS
  WHERE
    HSS.END_INTERVAL_TIME >= BI.BEGIN_TIME AND
    HSS.BEGIN_INTERVAL_TIME <= BI.END_TIME
)
SELECT
  OWNER,
  TABLE_NAME,
  PART_NAME,
  TO_CHAR(TOTAL_ROWS, 9999999999999990) TOTAL_ROWS,
  TO_CHAR(CHAINED_ROWS, 999999999999999999990) CHAINED_ROWS,
  TO_CHAR(DECODE(TOTAL_ROWS, 0, 0, CHAINED_ROWS / TOTAL_ROWS * 100), 990.99) "CHAIN_%"
FROM
( SELECT
    SSO.OWNER,
    SSO.OBJECT_NAME TABLE_NAME,
    SSO.SUBOBJECT_NAME PART_NAME,
    NVL(T.NUM_ROWS, 0) TOTAL_ROWS,
    MAX(HSS.CHAIN_ROW_EXCESS_TOTAL) CHAINED_ROWS,
    BI.MIN_CHAINED_ROW_THRESHOLD
  FROM
    BASIS_INFO BI,
    SNAPSHOTS SS,
    DBA_HIST_SEG_STAT HSS,
    DBA_HIST_SEG_STAT_OBJ SSO,
    DBA_TABLES T
  WHERE
    HSS.SNAP_ID BETWEEN SS.BEGIN_SNAP_ID AND SS.END_SNAP_ID AND
    SSO.OWNER LIKE BI.OWNER AND
    HSS.OBJ# = SSO.OBJ# AND
    HSS.DATAOBJ# = SSO.DATAOBJ# AND
    SSO.OWNER = T.OWNER AND
    SSO.OBJECT_NAME = T.TABLE_NAME 
  GROUP BY
    SSO.OWNER,
    SSO.OBJECT_NAME,
    SSO.SUBOBJECT_NAME,
    T.NUM_ROWS,
    BI.MIN_CHAINED_ROW_THRESHOLD
)
WHERE
  ( MIN_CHAINED_ROW_THRESHOLD = -1 AND CHAINED_ROWS > 0 OR
    MIN_CHAINED_ROW_THRESHOLD >= 0 AND CHAINED_ROWS >= MIN_CHAINED_ROW_THRESHOLD )
ORDER BY
  CHAINED_ROWS DESC
));

    
