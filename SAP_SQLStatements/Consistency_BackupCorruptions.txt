SELECT NULL INST, NULL CORR_TIME, NULL FILE_ID, NULL BLOCK_ID, NULL BLOCKS,
  NULL CORR_SCN, NULL MARKED_CORR, NULL CORR_TYPE FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT NULL INST, NULL CORR_TIME, NULL FILE_ID, NULL BLOCK_ID, NULL BLOCKS,
  NULL CORR_SCN, NULL MARKED_CORR, NULL CORR_TYPE FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT /*+ MATERIALIZE */
    DECODE(INSTANCE_NUMBER, -1, USERENV('INSTANCE'), INSTANCE_NUMBER) INSTANCE_NUMBER,
    IGNORE_OLD_CORRUPTIONS
  FROM
  ( SELECT
      -1 INSTANCE_NUMBER,          /* -1 for current instance, -2 for all instances */
      ' ' IGNORE_OLD_CORRUPTIONS
    FROM
      DUAL
  )
),
MIN_BACKUP_SET_TIME AS
( SELECT
    MIN(BS.START_TIME) MIN_BACKUP_SET_TIME
  FROM
    BASIS_INFO BI,
    GV$BACKUP_SET BS
  WHERE
    BI.INSTANCE_NUMBER = -2 OR BS.INST_ID = BI.INSTANCE_NUMBER 
)    
SELECT
  TO_CHAR(BC.INST_ID, 990) INST,
  DECODE(BS.START_TIME, NULL, 'N/A (older than ' || TO_CHAR(MT.MIN_BACKUP_SET_TIME, 'dd.mm.yyyy') || '?)', 
    TO_CHAR(BS.START_TIME, 'dd.mm.yyyy hh24:mi:ss')) CORR_TIME,
  TO_CHAR(BC.FILE#, 999990) FILE_ID,
  TO_CHAR(BC.BLOCK#, 9999990) BLOCK_ID,
  TO_CHAR(BC.BLOCKS, 99990) BLOCKS,
  BC.CORRUPTION_CHANGE#  CORR_SCN,
  BC.MARKED_CORRUPT MARKED_CORR,
  BC.CORRUPTION_TYPE CORR_TYPE
FROM
  BASIS_INFO BI,
  GV$BACKUP_CORRUPTION BC,
  GV$BACKUP_SET BS,
  MIN_BACKUP_SET_TIME MT
WHERE
  ( BI.INSTANCE_NUMBER = -2 OR BC.INST_ID = BI.INSTANCE_NUMBER ) AND
  BS.INST_ID (+) = BC.INST_ID AND
  BS.SET_STAMP (+) = BC.SET_STAMP AND
  ( BI.IGNORE_OLD_CORRUPTIONS = ' ' OR BS.START_TIME IS NOT NULL )
));
