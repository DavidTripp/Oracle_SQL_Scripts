SELECT NULL BEGIN_DATE, NULL MAXQUERY_S, NULL SQL_ID, NULL MAX_CONCURRENT, NULL UNCOMMITTED_MB,
  NULL UNEXPIRED_MB, NULL EXPIRED_MB, NULL EXP_RELOC_MB, NULL TUNED_RETENTION FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT NULL BEGIN_DATE, NULL MAXQUERY_S, NULL SQL_ID, NULL MAX_CONCURRENT, NULL UNCOMMITTED_MB,
  NULL UNEXPIRED_MB, NULL EXPIRED_MB, NULL EXP_RELOC_MB, NULL TUNED_RETENTION FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT 
    DECODE(INSTANCE_NUMBER, -1, USERENV('INSTANCE'), INSTANCE_NUMBER) INSTANCE_NUMBER,
    BEGIN_DATE,
    END_DATE,
    TO_TIMESTAMP(TO_CHAR(BEGIN_DATE, 'dd.mm.yyyy hh24:mi:ss'), 
      'dd.mm.yyyy hh24:mi:ss') BEGIN_TIME,
    TO_TIMESTAMP(TO_CHAR(END_DATE, 'dd.mm.yyyy hh24:mi:ss'), 
      'dd.mm.yyyy hh24:mi:ss') END_TIME,
    UNDO_BLOCK_SIZE_BYTE,
    DATA_SOURCE
  FROM
  ( SELECT
      1 INSTANCE_NUMBER,        
      TO_DATE('01.01.1000 01:00:00', 'dd.mm.yyyy hh24:mi:ss') BEGIN_DATE,
      TO_DATE('31.12.9999 22:05:00', 'dd.mm.yyyy hh24:mi:ss') END_DATE,
      8192 UNDO_BLOCK_SIZE_BYTE,
      'AWR' DATA_SOURCE       /* AWR, CURRENT */
    FROM
      DUAL
  )
),
UNDO_STATISTICS AS
( SELECT
    U.BEGIN_TIME,
    U.MAXQUERYLEN,
    U.MAXQUERYID,
    U.MAXCONCURRENCY,
    U.ACTIVEBLKS,
    U.UNEXPIREDBLKS,
    U.EXPIREDBLKS,
    U.EXPBLKRELCNT,
    U.TUNED_UNDORETENTION
  FROM
    BASIS_INFO BI,
    GV$UNDOSTAT U
  WHERE
    BI.INSTANCE_NUMBER = U.INST_ID AND
    U.BEGIN_TIME >= BI.BEGIN_DATE AND
    U.END_TIME <= BI.END_DATE AND
    BI.DATA_SOURCE = 'CURRENT'
  UNION ALL
  ( SELECT
      U.BEGIN_TIME,
      U.MAXQUERYLEN,
      U.MAXQUERYSQLID MAXQUERYID,
      U.MAXCONCURRENCY,
      U.ACTIVEBLKS,
      U.UNEXPIREDBLKS,
      U.EXPIREDBLKS,
      U.EXPBLKRELCNT,
      U.TUNED_UNDORETENTION
    FROM
      BASIS_INFO BI,
      DBA_HIST_UNDOSTAT U
    WHERE
      BI.INSTANCE_NUMBER = U.INSTANCE_NUMBER AND
      U.BEGIN_TIME >= BI.BEGIN_DATE AND
      U.END_TIME <= BI.END_DATE AND
      BI.DATA_SOURCE = 'AWR'
  )
)
SELECT
  TO_CHAR(U.BEGIN_TIME, 'dd.mm.yyyy hh24:mi:ss') BEGIN_DATE,
  TO_CHAR(U.MAXQUERYLEN, 999999990) MAXQUERY_S,
  U.MAXQUERYID SQL_ID,
  TO_CHAR(U.MAXCONCURRENCY, 9999999999990) MAX_CONCURRENT,
  TO_CHAR(U.ACTIVEBLKS * BI.UNDO_BLOCK_SIZE_BYTE / 1024 / 1024, 9999999990.99) UNCOMMITTED_MB,
  TO_CHAR(U.UNEXPIREDBLKS * BI.UNDO_BLOCK_SIZE_BYTE / 1024 / 1024, 99999990.99) UNEXPIRED_MB,
  TO_CHAR(U.EXPIREDBLKS * BI.UNDO_BLOCK_SIZE_BYTE / 1024 / 1024, 999990.99) EXPIRED_MB,
  TO_CHAR(U.EXPBLKRELCNT * BI.UNDO_BLOCK_SIZE_BYTE / 1024 / 1024, 99999990.99) EXP_RELOC_MB,
  TO_CHAR(U.TUNED_UNDORETENTION, 99999999999990) TUNED_RETENTION
FROM
  BASIS_INFO BI,
  UNDO_STATISTICS U
ORDER BY
  TO_CHAR(U.BEGIN_TIME, 'yyyy.mm.dd hh24:mi:ss') DESC
));

