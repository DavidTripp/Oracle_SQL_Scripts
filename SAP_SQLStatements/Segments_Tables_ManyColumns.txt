SELECT NULL OWNER, NULL TABLE_NAME, NULL BLOCKS, NULL NUM_COLUMNS FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT NULL OWNER, NULL TABLE_NAME, NULL BLOCKS, NULL NUM_COLUMNS FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT /*+ MATERIALIZE OPT_PARAM('OPTIMIZER_DYNAMIC_SAMPLING', 6) */
    'SAP%' OWNER,
    '%' TABLE_NAME,
    255 MIN_COLUMN_THRESHOLD,
    100 MIN_BLOCK_THRESHOLD
  FROM
    DUAL
),
TABLES AS
( SELECT /*+ MATERIALIZE */
    T.OWNER,
    T.TABLE_NAME,
    T.BLOCKS
  FROM
    BASIS_INFO BI,
    DBA_TABLES T
  WHERE
    T.OWNER LIKE BI.OWNER AND
    T.TABLE_NAME LIKE BI.TABLE_NAME AND
    ( BI.MIN_BLOCK_THRESHOLD = -1 OR T.BLOCKS > BI.MIN_BLOCK_THRESHOLD )
),
TABLE_COLUMNS AS
( SELECT /*+ MATERIALIZE */
    TC.OWNER,
    TC.TABLE_NAME,
    COUNT(*) NUM_COLUMNS
  FROM
    BASIS_INFO BI,
    DBA_TAB_COLUMNS TC
  WHERE
    TC.OWNER LIKE BI.OWNER AND
    TC.TABLE_NAME LIKE BI.TABLE_NAME
  GROUP BY
    TC.OWNER,
    TC.TABLE_NAME,
    BI.MIN_COLUMN_THRESHOLD
  HAVING
    COUNT(*) > BI.MIN_COLUMN_THRESHOLD
)    
SELECT
  T.OWNER,
  T.TABLE_NAME,
  TO_CHAR(T.BLOCKS, 99999990) BLOCKS,
  TO_CHAR(TC.NUM_COLUMNS, 9999999990) NUM_COLUMNS
FROM
  TABLES T,
  TABLE_COLUMNS TC
WHERE
  T.OWNER = TC.OWNER AND
  T.TABLE_NAME = TC.TABLE_NAME 
ORDER BY
  T.OWNER,
  T.TABLE_NAME
));
