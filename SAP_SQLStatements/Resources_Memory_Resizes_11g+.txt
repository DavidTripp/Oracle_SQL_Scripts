SELECT NULL INST, NULL START_TIME, NULL END_TIME, NULL OPERATION, NULL PARAMETER, NULL COMPONENT, 
  NULL OPER_MODE, NULL STATUS, NULL INITIAL_SIZE, NULL TARGET_SIZE, NULL FINAL_SIZE FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT NULL INST, NULL START_TIME, NULL END_TIME, NULL OPERATION, NULL PARAMETER, NULL COMPONENT, 
  NULL OPER_MODE, NULL STATUS, NULL INITIAL_SIZE, NULL TARGET_SIZE, NULL FINAL_SIZE FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT 
    DECODE(INSTANCE_NUMBER, -1, USERENV('INSTANCE'), INSTANCE_NUMBER) INSTANCE_NUMBER,
    BEGIN_DATE,
    END_DATE,
    TO_TIMESTAMP(TO_CHAR(BEGIN_DATE, 'dd.mm.yyyy hh24:mi:ss'), 
      'dd.mm.yyyy hh24:mi:ss') BEGIN_TIME,
    TO_TIMESTAMP(TO_CHAR(END_DATE, 'dd.mm.yyyy hh24:mi:ss'), 
      'dd.mm.yyyy hh24:mi:ss') END_TIME,
    PARAMETER,
    STATUS,
    OPERATION
  FROM
  ( SELECT
      -1 INSTANCE_NUMBER,
      TO_DATE('01.01.1000 12:57:00', 'dd.mm.yyyy hh24:mi:ss') BEGIN_DATE,
      TO_DATE('31.12.9999 00:05:00', 'dd.mm.yyyy hh24:mi:ss') END_DATE,
      '%' PARAMETER,          /* e.g. 'db_cache_size' */
      '%' STATUS,             /* e.g. 'CANCELLED' */
      '%' OPERATION           /* e.g. 'SHRINK', 'GROW' */
    FROM
      DUAL
  )
),
RESIZE_OPS AS
( SELECT
    INST_ID INSTANCE_NUMBER,
    START_TIME,
    END_TIME,
    OPER_TYPE,
    PARAMETER,
    COMPONENT,
    OPER_MODE,
    STATUS,
    INITIAL_SIZE,
    TARGET_SIZE,
    FINAL_SIZE
  FROM
    GV$MEMORY_RESIZE_OPS
  UNION
  ( SELECT
      INSTANCE_NUMBER,
      START_TIME,
      END_TIME,
      OPER_TYPE,
      PARAMETER,
      COMPONENT,
      OPER_MODE,
      STATUS,
      INITIAL_SIZE,
      TARGET_SIZE,
      FINAL_SIZE
    FROM
      DBA_HIST_MEMORY_RESIZE_OPS
  )
)  
SELECT
  TO_CHAR(R.INSTANCE_NUMBER, 990) INST,
  TO_CHAR(R.START_TIME, 'dd.mm.yyyy hh24:mi:ss') START_TIME,
  TO_CHAR(R.END_TIME, 'dd.mm.yyyy hh24:mi:ss') END_TIME,
  R.OPER_TYPE OPERATION,
  R.PARAMETER,
  R.COMPONENT,
  R.OPER_MODE,
  R.STATUS,
  TO_CHAR(R.INITIAL_SIZE, 999999999990) INITIAL_SIZE,
  TO_CHAR(R.TARGET_SIZE, 999999999990) TARGET_SIZE,
  TO_CHAR(R.FINAL_SIZE, 999999999990) FINAL_SIZE
FROM
  BASIS_INFO BI,
  RESIZE_OPS R
WHERE
  ( BI.INSTANCE_NUMBER = -2 OR BI.INSTANCE_NUMBER = R.INSTANCE_NUMBER ) AND
  BI.BEGIN_TIME <= R.START_TIME AND
  BI.END_TIME >= R.END_TIME AND
  R.PARAMETER LIKE BI.PARAMETER AND
  R.STATUS LIKE BI.STATUS AND
  R.OPER_TYPE LIKE BI. OPERATION
ORDER BY
  R.START_TIME DESC,
  R.OPER_TYPE,
  R.PARAMETER,
  R.COMPONENT
));


