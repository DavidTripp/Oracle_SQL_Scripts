SELECT NULL FILE_ID, NULL OWNER_1, NULL SEGMENT_1, NULL BLOCK_RANGE_1,
  NULL OWNER_2, NULL SEGMENT_2, NULL BLOCK_RANGE_2 FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT NULL FILE_ID, NULL OWNER_1, NULL SEGMENT_1, NULL BLOCK_RANGE_1,
  NULL OWNER_2, NULL SEGMENT_2, NULL BLOCK_RANGE_2 FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT
    '%' TABLESPACE_NAME,
    -1  FILE_ID
  FROM
    DUAL
),
SPACE_AREAS AS
( SELECT /*+ MATERIALIZE */
    E.OWNER,
    E.SEGMENT_NAME,
    E.FILE_ID,
    E.BLOCK_ID,
    E.BLOCKS
  FROM
    BASIS_INFO BI,
    DBA_EXTENTS E
  WHERE
    E.TABLESPACE_NAME LIKE BI.TABLESPACE_NAME AND
    ( BI.FILE_ID = -1 OR E.FILE_ID = BI.FILE_ID )
  UNION ALL
  ( SELECT /*+ MATERIALIZE */
      ' ' OWNER,
      'FREESPACE ' || ROWNUM SEGMENT_NAME,
      F.FILE_ID,
      F.BLOCK_ID,
      F.BLOCKS
    FROM
      BASIS_INFO BI,
      DBA_FREE_SPACE F
    WHERE
      F.TABLESPACE_NAME LIKE BI.TABLESPACE_NAME AND
      ( BI.FILE_ID = -1 OR F.FILE_ID = BI.FILE_ID )
  )
)
SELECT
  E1.FILE_ID,
  E1.OWNER OWNER_1,
  E1.SEGMENT_NAME SEGMENT_1,
  TO_CHAR(E1.BLOCK_ID) || '-' || TO_CHAR(E1.BLOCK_ID + E1.BLOCKS - 1) BLOCK_RANGE_1,
  E2.OWNER OWNER_2,
  E2.SEGMENT_NAME SEGMENT_2,
  TO_CHAR(E2.BLOCK_ID) || '-' || TO_CHAR(E2.BLOCK_ID + E2.BLOCKS - 1) BLOCK_RANGE_2
FROM
  SPACE_AREAS E1,
  SPACE_AREAS E2
WHERE
  E1.FILE_ID = E2.FILE_ID AND
  ( E1.OWNER != E2.OWNER OR
    E1.SEGMENT_NAME != E2.SEGMENT_NAME ) AND
  E1.BLOCK_ID <= E2.BLOCK_ID AND
  E1.BLOCK_ID + E1.BLOCKS - 1 >= E2.BLOCK_ID
ORDER BY
  E1.FILE_ID,
  E1.BLOCK_ID,
  E2.BLOCK_ID
));
