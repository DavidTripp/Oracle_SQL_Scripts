SELECT NULL START_DATE, NULL TYPE, NULL NAME, NULL DURATION, 
  NULL STATUS, NULL REPEAT_DETAILS FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT NULL START_DATE, NULL TYPE, NULL NAME, NULL DURATION, 
  NULL STATUS, NULL REPEAT_DETAILS FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT
    BEGIN_DATE,
    END_DATE,
    TO_TIMESTAMP(BEGIN_DATE) BEGIN_TIME,
    TO_TIMESTAMP(END_DATE) END_TIME,
    OPERATION_TYPE,
    OPERATION_NAME,
    ORDER_BY
  FROM
  ( SELECT
      TO_DATE('01.01.1000 00:05:00', 'dd.mm.yyyy hh24:mi:ss') BEGIN_DATE,
      TO_DATE('31.12.9999 23:05:00', 'dd.mm.yyyy hh24:mi:ss') END_DATE,
      '%' OPERATION_TYPE,    /* JOB, TASK, ALL */
      'SEGMENT_ADVISOR' OPERATION_NAME,      /* SEGMENT_ADVISOR, GATHER_STATS, TUNING_ADVISOR or name */
      'DATE' ORDER_BY          /* NAME, DATE */
    FROM
      DUAL
  )
)
SELECT
  START_DATE,
  TYPE,
  NAME,
  DURATION,
  STATUS,
  REPEAT_DETAILS
FROM
( SELECT
    TO_CHAR(JRD.ACTUAL_START_DATE, 'yyyy/mm/dd hh24:mi:ss') START_DATE,
    'JOB' TYPE,
    JRD.JOB_NAME NAME,
    JRD.RUN_DURATION DURATION,
    JRD.STATUS,
    SJ.REPEAT_INTERVAL REPEAT_DETAILS,
    BI.ORDER_BY
  FROM 
    BASIS_INFO BI,
    DBA_SCHEDULER_JOB_RUN_DETAILS JRD,
    DBA_SCHEDULER_JOBS SJ
  WHERE
    BI.OPERATION_TYPE IN ('%', 'ALL', 'JOB') AND
    ( JRD.JOB_NAME LIKE BI.OPERATION_NAME OR
      BI.OPERATION_NAME = 'SEGMENT_ADVISOR' AND JRD.JOB_NAME = 'AUTO_SPACE_ADVISOR_JOB' OR
      BI.OPERATION_NAME = 'GATHER_STATS' AND JRD.JOB_NAME = 'GATHER_STATS_JOB' ) AND
    JRD.ACTUAL_START_DATE BETWEEN BI.BEGIN_DATE AND BI.END_DATE AND
    JRD.OWNER = SJ.OWNER (+) AND
    JRD.JOB_NAME = SJ.JOB_NAME (+) AND
    NVL(JRD.JOB_SUBNAME, ' ') = NVL(SJ.JOB_SUBNAME, ' ')
  UNION ALL
  ( SELECT
      TO_CHAR(AJH.JOB_START_TIME, 'yyyy/mm/dd hh24:mi:ss') START_DATE,
      'TASK' TYPE,
      AJH.CLIENT_NAME NAME,
      AJH.JOB_DURATION DURATION,
      AJH.JOB_STATUS STATUS,
      AJH.WINDOW_NAME REPEAT_DETAILS,
      BI.ORDER_BY
    FROM
      BASIS_INFO BI,
      DBA_AUTOTASK_JOB_HISTORY AJH
    WHERE
      BI.OPERATION_TYPE IN ('%', 'ALL', 'TASK') AND
      ( AJH.CLIENT_NAME LIKE BI.OPERATION_NAME OR
        BI.OPERATION_NAME = 'SEGMENT_ADVISOR' AND 
         AJH.CLIENT_NAME = 'auto space advisor' OR
        BI.OPERATION_NAME = 'GATHER_STATS' AND 
          AJH.CLIENT_NAME = 'auto optimizer stats collection' OR
        BI.OPERATION_NAME = 'TUNING_ADVISOR' AND 
          AJH.CLIENT_NAME = 'sql tuning advisor' ) AND
      AJH.JOB_START_TIME BETWEEN BI.BEGIN_DATE AND BI.END_DATE 
  )
)
ORDER BY
  DECODE(ORDER_BY, 'NAME', NAME),
  START_DATE DESC
));
  
