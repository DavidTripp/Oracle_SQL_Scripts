SELECT NULL NAME, NULL VALUE, NULL COMMAND FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT NULL NAME, NULL VALUE, NULL COMMAND FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT /*+ MATERIALIZE */
    '%' TABLESPACE_NAME,
    'X' EXCLUDE_SYSTEM      /* SYSTEM tablespace should normally not be processed */
  FROM
    DUAL
)
SELECT
  DS.TABLESPACE_NAME NAME,
  TO_CHAR(COUNT(*), 999990) VALUE,
  'EXEC DBMS_SPACE_ADMIN.TABLESPACE_FIX_SEGMENT_EXTBLKS(' || CHR(39) || 
    DS.TABLESPACE_NAME || CHR(39) || ');' COMMAND
FROM
  BASIS_INFO BI,
  SYS.SYS_DBA_SEGS DS
WHERE
  BITAND(DS.SEGMENT_FLAGS, 131073) = 1 AND
  DS.SEGMENT_TYPE NOT IN ('ROLLBACK', 'TYPE2 UNDO') AND
  DS.TABLESPACE_NAME LIKE BI.TABLESPACE_NAME AND
  ( BI.EXCLUDE_SYSTEM != 'X' OR DS.TABLESPACE_NAME != 'SYSTEM' )
GROUP BY
  DS.TABLESPACE_NAME
ORDER BY
  COUNT(*) DESC
));
