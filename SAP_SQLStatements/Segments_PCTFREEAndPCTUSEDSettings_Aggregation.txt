SELECT NULL TABLESPACE_NAME, NULL TABART, NULL SEGMENT_TYPE, NULL PCTFREE_SEGMENT, 
  NULL PCTUSED_SEGMENT, NULL PCTFREE_TABART, NULL PCTUSED_TABART, 
  NULL NUM_SEGMENTS FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT NULL TABLESPACE_NAME, NULL TABART, NULL SEGMENT_TYPE, NULL PCTFREE_SEGMENT, 
  NULL PCTUSED_SEGMENT, NULL PCTFREE_TABART, NULL PCTUSED_TABART, 
  NULL NUM_SEGMENTS FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT
    'SAP%' OWNER,
    10 PCTFREE_TABLE_MIN,
    10 PCTFREE_TABLE_MAX,
    0 PCTFREE_INDEX_MIN,
    10 PCTFREE_INDEX_MAX,
    40 PCTUSED_TABLE_MIN,
    100 PCTUSED_TABLE_MAX
  FROM
    DUAL
),
SEGMENTS AS
( SELECT
    DT.OWNER,
    DT.TABLE_NAME SEGMENT_NAME,
    'TABLE' SEGMENT_TYPE,
    DT.TABLESPACE_NAME,
    DT.PCT_FREE,
    DT.PCT_USED
  FROM
    BASIS_INFO BI,
    DBA_TABLES DT
  WHERE
    DT.OWNER LIKE BI.OWNER AND
    DT.IOT_TYPE IS NULL AND
    DT.COMPRESSION != 'ENABLED' AND
    DT.BUFFER_POOL IS NOT NULL AND
    ( TO_NUMBER(DT.PCT_FREE) < BI.PCTFREE_TABLE_MIN OR
      TO_NUMBER(DT.PCT_FREE) > BI.PCTFREE_TABLE_MAX OR
      TO_NUMBER(DT.PCT_USED) < BI.PCTUSED_TABLE_MIN OR
      TO_NUMBER(DT.PCT_USED) > BI.PCTUSED_TABLE_MAX
    )
  UNION ALL
  ( SELECT
      DI.OWNER,
      DI.INDEX_NAME SEGMENT_NAME,
      'INDEX' SEGMENT_TYPE,
      DI.TABLESPACE_NAME,
      DI.PCT_FREE,
      NULL PCT_USED
    FROM
      BASIS_INFO BI,
      DBA_INDEXES DI
    WHERE
      DI.OWNER LIKE BI.OWNER AND
      DI.BUFFER_POOL IS NOT NULL AND
      ( TO_NUMBER(DI.PCT_FREE) < BI.PCTFREE_INDEX_MIN OR
        TO_NUMBER(DI.PCT_FREE) > BI.PCTFREE_INDEX_MAX
      )
  )
)
SELECT
  TABLESPACE_NAME,
  TABART,
  SEGMENT_TYPE,
  TO_CHAR(PCTFREE_SEGMENT, 99999999999990) PCTFREE_SEGMENT,
  TO_CHAR(PCTUSED_SEGMENT, 99999999999990) PCTUSED_SEGMENT,
  TO_CHAR(PCTFREE_TABART, 9999999999990) PCTFREE_TABART,
  TO_CHAR(PCTUSED_TABART, 9999999999990) PCTUSED_TABART,
  TO_CHAR(NUM_SEGMENTS, 99999999990) NUM_SEGMENTS
FROM
( SELECT
    S.TABLESPACE_NAME,
    T.TABART,
    'TABLE' SEGMENT_TYPE,
    S.PCT_FREE PCTFREE_SEGMENT,
    S.PCT_USED PCTUSED_SEGMENT,
    T.OPCTFREE PCTFREE_TABART,
    T.OPCTUSED PCTUSED_TABART,
    COUNT(*) NUM_SEGMENTS
  FROM
    SEGMENTS S,
    TAORA T
  WHERE
    S.SEGMENT_TYPE = 'TABLE' AND
    S.TABLESPACE_NAME = T.TABSPACE (+)
  GROUP BY
    S.TABLESPACE_NAME,
    T.TABART,
    S.PCT_FREE,
    S.PCT_USED,
    T.OPCTFREE,
    T.OPCTUSED
  UNION
  ( SELECT
      S.TABLESPACE_NAME,
      I.TABART,
      'INDEX' SEGMENT_TYPE,
      S.PCT_FREE PCTFREE_SEGMENT,
      NULL PCTUSED_SEGMENT,
      I.OPCTFREE PCTFREE_TABART,
      NULL PCTUSED_TABART,
      COUNT(*) NUM_SEGMENTS
    FROM
      SEGMENTS S,
      IAORA I
    WHERE
      S.SEGMENT_TYPE = 'INDEX' AND
      S.TABLESPACE_NAME = I.TABSPACE (+)
    GROUP BY
      S.TABLESPACE_NAME,
      I.TABART,
      S.PCT_FREE,
      S.PCT_USED,
      I.OPCTFREE
  )
)
ORDER BY
  TABLESPACE_NAME,
  SEGMENT_TYPE
)); 