SELECT NULL OWNER, NULL SEGMENT_NAME, NULL SEGMENT_TYPE, 
  NULL INITRANS, NULL OVERHEAD_MB FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT NULL OWNER, NULL SEGMENT_NAME, NULL SEGMENT_TYPE, 
  NULL INITRANS, NULL OVERHEAD_MB FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT
    'SAP%' OWNER,
    'ALL' SEGMENT_TYPE,     /* ALL, INDEX, TABLE */
    1 INITRANS_LIMIT_TABLE,
    2 INITRANS_LIMIT_INDEX,
    1 MIN_OVERHEAD_MB,
    'SEGMENT' AGGREGATE_BY, /* SEGMENT, SEGMENT_TYPE, ALL */
    'OVERHEAD' ORDER_BY,     /* SEGMENT, OVERHEAD */
    -1 NUM_RECORDS
  FROM
    DUAL
)
SELECT
  OWNER,
  SEGMENT_NAME,
  SEGMENT_TYPE,
  INITRANS,
  OVERHEAD_MB
FROM
( SELECT
    OWNER,
    SEGMENT_NAME,
    SEGMENT_TYPE,
    DECODE(SEGMENT_TYPE, 'any', INI_TRANS, LPAD(INI_TRANS, 8)) INITRANS,
    TO_CHAR(SUM(SPACE_OVERHEAD_BYTE / 1024 / 1024), 9999990.99) OVERHEAD_MB,
    NUM_RECORDS
  FROM
  ( SELECT
      T.OWNER,
      DECODE(BI.AGGREGATE_BY, 'SEGMENT', T.TABLE_NAME, 'any') SEGMENT_NAME,
      DECODE(BI.AGGREGATE_BY, 'ALL', 'any', 'TABLE') SEGMENT_TYPE,
      DECODE(BI.AGGREGATE_BY, 'SEGMENT', TO_CHAR(T.INI_TRANS), 'SEGMENT_TYPE', '> ' || BI.INITRANS_LIMIT_TABLE,
        'ALL', '> ' || BI.INITRANS_LIMIT_TABLE || ' (TABLES), > ' || BI.INITRANS_LIMIT_INDEX || ' (INDEXES)') INI_TRANS,
      T.BLOCKS * (T.INI_TRANS - 1) * 23 SPACE_OVERHEAD_BYTE,
      BI.ORDER_BY,
      BI.NUM_RECORDS
    FROM 
      BASIS_INFO BI,
      DBA_TABLES T
    WHERE
      T.OWNER LIKE BI.OWNER AND
      BI.SEGMENT_TYPE IN ('ALL', 'TABLE') AND
      T.INI_TRANS > BI.INITRANS_LIMIT_TABLE AND
      ( BI.MIN_OVERHEAD_MB = -1 OR T.BLOCKS * (T.INI_TRANS - 1) * 23 / 1024 / 1024 > BI.MIN_OVERHEAD_MB )
    UNION ALL
    ( SELECT
        I.OWNER,
        DECODE(BI.AGGREGATE_BY, 'SEGMENT', I.INDEX_NAME, 'any') SEGMENT_NAME,
        DECODE(BI.AGGREGATE_BY, 'ALL', 'any', 'INDEX') SEGMENT_TYPE,
        DECODE(BI.AGGREGATE_BY, 'SEGMENT', TO_CHAR(I.INI_TRANS), 'SEGMENT_TYPE', '> ' || BI.INITRANS_LIMIT_INDEX,
          'ALL', '> ' || BI.INITRANS_LIMIT_TABLE || ' (TABLES), > ' || BI.INITRANS_LIMIT_INDEX || ' (INDEXES)') INI_TRANS,
        I.LEAF_BLOCKS * 1.02 * (I.INI_TRANS - 2) * 23 SPACE_OVERHEAD_BYTE,
        BI.ORDER_BY,
        BI.NUM_RECORDS
      FROM 
        BASIS_INFO BI,
        DBA_INDEXES I
      WHERE
        I.OWNER LIKE BI.OWNER AND
        BI.SEGMENT_TYPE IN ('ALL', 'INDEX') AND
        I.INDEX_TYPE != 'LOB' AND
        I.INI_TRANS > BI.INITRANS_LIMIT_INDEX AND
        ( BI.MIN_OVERHEAD_MB = -1 OR I.LEAF_BLOCKS * 1.02 * (I.INI_TRANS - 2) * 23 / 1024 / 1024 > BI.MIN_OVERHEAD_MB )
    )  
  )
  GROUP BY
    OWNER,
    SEGMENT_NAME,
    SEGMENT_TYPE,
    INI_TRANS,
    ORDER_BY,
    NUM_RECORDS
  ORDER BY
    DECODE(ORDER_BY, 'OVERHEAD', SUM(SPACE_OVERHEAD_BYTE), 1) DESC,
    SEGMENT_TYPE,
    OWNER,
    SEGMENT_NAME
)
WHERE
  NUM_RECORDS = -1 OR ROWNUM <= NUM_RECORDS
));
