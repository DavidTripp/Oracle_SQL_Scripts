SELECT NULL TABLESPACE_NAME, NULL FILE_NAME, NULL FREESPACE_AREAS_AT_END,
  NULL FREESPACE_AT_END_MB, NULL RESIZE_COMMAND FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT NULL TABLESPACE_NAME, NULL FILE_NAME, NULL FREESPACE_AREAS_AT_END,
  NULL FREESPACE_AT_END_MB, NULL RESIZE_COMMAND FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT
    '%' TABLESPACE_NAME,
    '%' DATAFILE_NAME,
    1 MIN_FREESPACE_MB,
    'FREESPACE' ORDER_BY    /* FREESPACE, FILENAME, TABLESPACE */
  FROM
    DUAL
)
SELECT
  TABLESPACE_NAME,
  FILE_NAME,
  TO_CHAR(FREESPACE_AREAS_AT_END, 999999999999999999990) FREESPACE_AREAS_AT_END,
  TO_CHAR(FREESPACE_AT_END_MB, 999999999999990.99) FREESPACE_AT_END_MB,
  'ALTER DATABASE DATAFILE ' || FILE_ID || ' RESIZE ' || MIN_RESIZE_BYTE || ';' RESIZE_COMMAND
FROM
( SELECT
    TABLESPACE_NAME,
    FILE_NAME,
    FILE_ID,
    COUNT(*) FREESPACE_AREAS_AT_END,
    (MAX(END_OF_FRAGMENT) - MIN(START_OF_FRAGMENT)) / 1024 / 1024 FREESPACE_AT_END_MB,
    MIN(START_OF_FRAGMENT) MIN_RESIZE_BYTE,
    ORDER_BY,
    MIN_FREESPACE_MB
  FROM
  ( SELECT
      TS.TABLESPACE_NAME,
      DF.FILE_NAME,
      DF.FILE_ID,
      TS.BLOCK_SIZE * FS.BLOCK_ID START_OF_FRAGMENT,
      TS.BLOCK_SIZE * (FS.BLOCK_ID + FS.BLOCKS) END_OF_FRAGMENT,
      BI.ORDER_BY,
      BI.MIN_FREESPACE_MB
    FROM
      BASIS_INFO BI,
      DBA_FREE_SPACE FS,
      DBA_DATA_FILES DF,
      DBA_TABLESPACES TS
    WHERE
      FS.TABLESPACE_NAME LIKE BI.TABLESPACE_NAME AND
      DF.FILE_NAME LIKE BI.DATAFILE_NAME AND
      DF.FILE_ID = FS.FILE_ID AND
      DF.TABLESPACE_NAME = TS.TABLESPACE_NAME
    CONNECT BY 
      PRIOR FS.BLOCK_ID = FS.BLOCK_ID + FS.BLOCKS AND
      PRIOR FS.FILE_ID = FS.FILE_ID
      START WITH
        (FS.BLOCK_ID + FS.BLOCKS - 1) * TS.BLOCK_SIZE = DF.BYTES 
  )
  GROUP BY
    MIN_FREESPACE_MB,
    ORDER_BY,
    TABLESPACE_NAME,
    FILE_NAME,
    FILE_ID
)
WHERE
  FREESPACE_AT_END_MB >= MIN_FREESPACE_MB
ORDER BY
  DECODE(ORDER_BY, 'FREESPACE', FREESPACE_AT_END_MB, 1) DESC,
  DECODE(ORDER_BY, 'FILENAME', FILE_NAME, 'TABLESPACE', TABLESPACE_NAME)
));