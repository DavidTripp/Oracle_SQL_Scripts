SELECT 
  /* Lists tables that are excluded from BRSPACE compression due to technical limitations, "-MCC <columns>",
     "-SCT" or _reorg_excl_tab (SAP Note 1431296) */
  NULL OWNER, NULL TABLE_NAME, NULL SIZE_MB, NULL EXCLUDED_VIA, NULL REASON, NULL C FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT NULL OWNER, NULL TABLE_NAME, NULL SIZE_MB, NULL EXCLUDED_VIA, NULL REASON, NULL C FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT /*+ OPT_PARAM('OPTIMIZER_DYNAMIC_SAMPLING', 6) */
    TABLE_NAME,
    MIN_SEGMENT_SIZE_MB,
    DECODE(MIN_COLUMN_THRESHOLD, -1, 256, MIN_COLUMN_THRESHOLD) MIN_COLUMN_THRESHOLD,
    ONLY_COMPRESSED,
    ORDER_BY
  FROM
  ( SELECT
      '%' TABLE_NAME,
      -1 MIN_SEGMENT_SIZE_MB,
      230 MIN_COLUMN_THRESHOLD,
      ' ' ONLY_COMPRESSED,            /* 'X' -> show only compressed exception tables */
      'SIZE' ORDER_BY       /* SIZE, NAME */
    FROM
      DUAL
  )
),
SKIPPED_TABLES AS
( SELECT /*+ MATERIALIZE */
    OWNER,
    TABLE_NAME,
    EXCLUDED_VIA,
    REASON,
    COMPRESSED 
  FROM
  ( SELECT
      DTC.OWNER,
      DTC.TABLE_NAME,
      DECODE(SIGN(COUNT(*) - 256), -1, '-MCC ' || BI.MIN_COLUMN_THRESHOLD, 
        'technical restriction') EXCLUDED_VIA,
      DECODE(SIGN(COUNT(*) - 256), -1, 'close to 255 columns', '> 255 columns') REASON,
      DECODE(T.COMPRESSION, 'ENABLED', 'X', ' ') COMPRESSED
    FROM
      BASIS_INFO BI,
      DBA_TAB_COLUMNS DTC,
      DBA_TABLES T
    WHERE
      DTC.TABLE_NAME LIKE BI.TABLE_NAME AND
      T.OWNER = DTC.OWNER AND
      T.TABLE_NAME = DTC.TABLE_NAME
    GROUP BY
      DTC.OWNER,
      DTC.TABLE_NAME,
      BI.MIN_COLUMN_THRESHOLD,
      T.COMPRESSION
    HAVING
      COUNT(*) > BI.MIN_COLUMN_THRESHOLD
    UNION 
    ( SELECT
        DTC.OWNER,
        DTC.TABLE_NAME,
        '-SCT' EXCLUDED_VIA,
        'INDX table' REASON,
        DECODE(T.COMPRESSION, 'ENABLED', 'X', ' ') COMPRESSED
      FROM
        BASIS_INFO BI,
        DBA_TAB_COLUMNS DTC,
        DBA_TABLES T
      WHERE
        DTC.TABLE_NAME LIKE BI.TABLE_NAME AND
        DTC.TABLE_NAME LIKE BI.TABLE_NAME AND
        DTC.COLUMN_NAME IN ('RELID', 'SRTF2', 'CLUSTR', 'CLUSTD') AND
        T.TABLE_NAME = DTC.TABLE_NAME
      GROUP BY
        DTC.OWNER,
        DTC.TABLE_NAME,
        T.COMPRESSION
      HAVING
        COUNT(*) = 4
    )
    UNION
    ( SELECT
        T.OWNER,
        T.TABLE_NAME,
        '-SCT' EXCLUDED_VIA,
        'ABAP table' REASON,
        DECODE(T.COMPRESSION, 'ENABLED', 'X', ' ') COMPRESSED
      FROM
        BASIS_INFO BI,
        DBA_TABLES T
      WHERE    
        T.TABLE_NAME LIKE BI.TABLE_NAME AND
        T.TABLE_NAME IN ('REPOSRC', 'REPOLOAD')
    )
    UNION
    ( SELECT
        T.OWNER,
        T.TABLE_NAME,
        '-SCT' EXCLUDED_VIA,
        'Update table' REASON,
        DECODE(T.COMPRESSION, 'ENABLED', 'X', ' ') COMPRESSED
      FROM
        BASIS_INFO BI,
        DBA_TABLES T
      WHERE    
        T.TABLE_NAME LIKE BI.TABLE_NAME AND
        T.TABLE_NAME IN ('VBHDR', 'VBDATA', 'VBMOD', 'VBERROR')
    )
    UNION
    ( SELECT
        T.OWNER,
        T.TABLE_NAME,
        '_reorg_excl_tab' EXCLUDED_VIA,
        'RFC table' REASON,
        DECODE(T.COMPRESSION, 'ENABLED', 'X', ' ') COMPRESSED
      FROM
        BASIS_INFO BI,
        DBA_TABLES T
      WHERE    
        T.TABLE_NAME LIKE BI.TABLE_NAME AND
        T.TABLE_NAME IN ('ARFCSSTATE', 'ARFCSDATA', 'ARFCRSTATE', 'TRFCQDATA',
         'TRFCQIN', 'TRFCQOUT', 'TRFCQSTATE', 'QRFCTRACE', 'QRFCLOG')
    )
    UNION
    ( SELECT
        T.OWNER,
        T.TABLE_NAME,
        '_reorg_excl_tab' EXCLUDED_VIA,
        'Number range table' REASON,
        DECODE(T.COMPRESSION, 'ENABLED', 'X', ' ') COMPRESSED
      FROM
        BASIS_INFO BI,
        DBA_TABLES T
      WHERE    
        T.TABLE_NAME LIKE BI.TABLE_NAME AND
        T.TABLE_NAME IN ('NRIV')
    )
	UNION
	(  SELECT
	     T.OWNER,
		 T.TABLE_NAME,
        '_reorg_excl_tab' EXCLUDED_VIA,
        'SLT table' REASON,
        DECODE(T.COMPRESSION, 'ENABLED', 'X', ' ') COMPRESSED
      FROM
        BASIS_INFO BI,
        DBA_TABLES T
      WHERE    
        T.TABLE_NAME LIKE BI.TABLE_NAME AND
        T.TABLE_NAME LIKE '/1CADMC/%'
	)
  )
)
SELECT
  ST.OWNER,
  ST.TABLE_NAME,
  TO_CHAR(SUM(NVL(S.BYTES, 0)) / 1024 / 1024, 99999990.99) SIZE_MB,
  ST.EXCLUDED_VIA,
  ST.REASON,
  ST.COMPRESSED C
FROM
  BASIS_INFO BI,
  SKIPPED_TABLES ST,
  DBA_SEGMENTS S
WHERE
  ST.OWNER = S.OWNER (+) AND
  ST.TABLE_NAME = S.SEGMENT_NAME (+) AND
  ( BI.ONLY_COMPRESSED = ' ' OR ST.COMPRESSED = 'X' ) AND
  NVL(S.BYTES, 0) / 1024 / 1024 >= BI.MIN_SEGMENT_SIZE_MB
GROUP BY
  ST.OWNER,
  ST.TABLE_NAME,
  ST.EXCLUDED_VIA,
  ST.REASON,
  ST.COMPRESSED,
  BI.ORDER_BY
ORDER BY
  DECODE(BI.ORDER_BY, 'SIZE', SUM(NVL(S.BYTES, 0)), 1) DESC,
  DECODE(BI.ORDER_BY, 'NAME', ST.OWNER || ST.TABLE_NAME, ' ')
));
