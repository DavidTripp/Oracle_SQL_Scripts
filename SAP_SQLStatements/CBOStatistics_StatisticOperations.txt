SELECT NULL BEGIN_DATE, NULL DURATION, NULL OPERATION, NULL TARGET FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT NULL BEGIN_DATE, NULL DURATION, NULL OPERATION, NULL TARGET FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT
    BEGIN_DATE,
    END_DATE,
    TO_TIMESTAMP(TO_CHAR(BEGIN_DATE, 'dd.mm.yyyy hh24:mi:ss'), 
      'dd.mm.yyyy hh24:mi:ss') BEGIN_TIME,
    TO_TIMESTAMP(TO_CHAR(END_DATE, 'dd.mm.yyyy hh24:mi:ss'), 
      'dd.mm.yyyy hh24:mi:ss') END_TIME,
    OPERATION,
    EXCLUDE_GATHER_TABLE_STATS,
    MIN_DURATION_S,
    NUM_RECORDS,
    TARGET,
    ORDER_BY
  FROM
  ( SELECT
      TO_DATE('01.01.1000 00:05:00', 'dd.mm.yyyy hh24:mi:ss') BEGIN_DATE,
      TO_DATE('31.12.9999 23:05:00', 'dd.mm.yyyy hh24:mi:ss') END_DATE,
      '%' OPERATION,       /* DBMS_STATS procedure calls like:
                              GATHER_TABLE_STATS, GATHER_SYSTEM_STATS, COPY_TABLE_STATS, EXPORT_TABLE_STATS,
                              IMPORT_TABLE_STATS, UNLOCK_TABLE_STATS, DELETE_TABLE_STATS, SET_TABLE_STATS,
                              GATHER_DICTIONARY_STATS, GET_SYSTEM_STATS, LOCK_TABLE_STATS, GATHER_FIXED_OBJECTS_STATS */
      'X' EXCLUDE_GATHER_TABLE_STATS,
      60 MIN_DURATION_S,
      100 NUM_RECORDS,
      '%' TARGET,           /* owner.table_name.partition_name */
      'DATE' ORDER_BY   /* DURATION, DATE, OPERATION, TARGET */
    FROM
      DUAL
  )
)
SELECT
  BEGIN_DATE,
  LPAD(TRUNC(DURATION_S / 3600), 2, '0') || ':' || LPAD(TRUNC(MOD(DURATION_S, 3600) / 60), 2, '0') || ':' ||
    LPAD(MOD(DURATION_S, 60), 2, '0') DURATION,
  OPERATION,
  TARGET
FROM
( SELECT
    BEGIN_DATE,
    DURATION_S,
    OPERATION,
    TARGET,
    NUM_RECORDS
  FROM
  ( SELECT
      OO.START_TIME BEGIN_DATE,
      TO_CHAR(OO.END_TIME, 'SSSSS') - TO_CHAR(OO.START_TIME, 'SSSSS') +
        86400 * (TO_CHAR(OO.END_TIME, 'J') - TO_CHAR(OO.START_TIME, 'J')) DURATION_S,
      UPPER(OO.OPERATION) OPERATION,
      OO.TARGET,
      BI.MIN_DURATION_S,
      BI.ORDER_BY,
      BI.NUM_RECORDS
    FROM
      BASIS_INFO BI,
      DBA_OPTSTAT_OPERATIONS OO
    WHERE
      OO.START_TIME >= BI.BEGIN_TIME AND
      OO.END_TIME <= BI.END_TIME AND
      UPPER(OO.OPERATION) LIKE BI.OPERATION AND
      ( BI.EXCLUDE_GATHER_TABLE_STATS = ' ' OR UPPER(OO.OPERATION) != 'GATHER_TABLE_STATS' ) AND
      ( OO.TARGET LIKE BI.TARGET OR OO.TARGET IS NULL AND BI.TARGET = '%' )
  )
  WHERE
    ( MIN_DURATION_S = -1 OR DURATION_S >= MIN_DURATION_S )
  ORDER BY
    DECODE(ORDER_BY, 'DURATION', DURATION_S, 1) DESC,
    DECODE(ORDER_BY, 'OPERATION', OPERATION, 'TARGET', TARGET, ' '),
    DECODE(ORDER_BY, 'DATE', BEGIN_DATE, SYSDATE) DESC
)
WHERE
  ( NUM_RECORDS = -1 OR ROWNUM <= NUM_RECORDS )
));

