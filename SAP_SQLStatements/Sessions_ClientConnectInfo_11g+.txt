SELECT NULL SID, NULL INST_ID, NULL PROGRAM, NULL SERVER_CHARSET, 
  NULL CLIENT_CHARSET, NULL OSUSER FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT NULL SID, NULL INST_ID, NULL PROGRAM, NULL SERVER_CHARSET, 
  NULL CLIENT_CHARSET, NULL OSUSER FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT
    DECODE(INSTANCE_NUMBER, -1, USERENV('INSTANCE'), INSTANCE_NUMBER) INSTANCE_NUMBER,
    OS_USER,
    ONLY_DIFF_CLIENT_CHARSET,
    EXCLUDE_ADMINISTRATIVE
  FROM
  ( SELECT
      -1 INSTANCE_NUMBER,            /* -1 for current instance, -2 for all instances */ 
      '%' OS_USER,
      'X' ONLY_DIFF_CLIENT_CHARSET,
      'X' EXCLUDE_ADMINISTRATIVE
    FROM
      DUAL
  )
)
SELECT DISTINCT
  S.SID,
  S.INST_ID,
  S.PROGRAM,
  NP.VALUE SERVER_CHARSET,
  SCI.CLIENT_CHARSET,
  SCI.OSUSER OS_USER
FROM
  BASIS_INFO BI,
  GV$SESSION S,
  GV$SESSION_CONNECT_INFO SCI,
  GV$NLS_PARAMETERS NP
WHERE
  ( BI.INSTANCE_NUMBER = -2 OR
    BI.INSTANCE_NUMBER = S.INST_ID ) AND
  S.INST_ID = SCI.INST_ID AND
  S.SID = SCI.SID AND
  SCI.INST_ID = NP.INST_ID AND
  NP.PARAMETER = 'NLS_CHARACTERSET' AND
  ( BI.ONLY_DIFF_CLIENT_CHARSET = ' ' OR
    ( SCI.CLIENT_CHARSET NOT IN ( 'Unknown', NP.VALUE ) AND
      ( SCI.CLIENT_CHARSET != 'UTF16' OR NP.VALUE != 'UTF8' )
    )
  ) AND
  ( BI.OS_USER = ' ' OR
    SCI.OSUSER LIKE BI.OS_USER
  ) AND
  ( BI.EXCLUDE_ADMINISTRATIVE = ' ' OR
    S.PROGRAM IS NULL OR
    ( S.PROGRAM NOT LIKE 'emagent%' AND
      S.PROGRAM NOT LIKE 'oraagent%'
    )
  )
));
