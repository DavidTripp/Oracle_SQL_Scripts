SELECT NULL OWNER, NULL TABLE_NAME, NULL NUM_ROWS, NULL BLOCKS, NULL NO_UNIQUE_INDEX, 
  NULL NULLABLE_INDEX_COLUMNS, NULL ENCRYPTED_INDEX_COLUMNS,
  NULL DISABLED_PK_CONSTRAINT FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT NULL OWNER, NULL TABLE_NAME, NULL NUM_ROWS, NULL BLOCKS, NULL NO_UNIQUE_INDEX, 
  NULL NULLABLE_INDEX_COLUMNS, NULL ENCRYPTED_INDEX_COLUMNS,
  NULL DISABLED_PK_CONSTRAINT FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT /*+ OPT_PARAM('OPTIMIZER_DYNAMIC_SAMPLING', 6) */
    'SAP%' OWNER,
    1 MIN_ROWS_THRESHOLD,
    -1 MIN_BLOCKS_THRESHOLD,
    ' ' EXCLUDE_FACT_TABLES
  FROM
    DUAL
),
TABLES AS
( SELECT /*+ MATERIALIZE */
    T.OWNER,
    T.TABLE_NAME,
    T.NUM_ROWS,
    T.BLOCKS
  FROM
    BASIS_INFO BI,
    DBA_TABLES T
  WHERE 
    T.OWNER LIKE BI.OWNER AND
    T.TEMPORARY = 'N'
),
UNIQUE_INDEXES AS
( SELECT /*+ MATERIALIZE */
    T.OWNER,
    T.TABLE_NAME,
    I.INDEX_NAME
  FROM
    TABLES T,
    DBA_INDEXES I
  WHERE
    T.OWNER = I.TABLE_OWNER AND
    T.TABLE_NAME = I.TABLE_NAME AND
    I.UNIQUENESS = 'UNIQUE' AND
    I.INDEX_TYPE != 'LOB'
),
INDEX_COLUMNS AS
( SELECT /*+ MATERIALIZE */
    UI.OWNER,
    UI.TABLE_NAME,
    UI.INDEX_NAME,
    IC.COLUMN_NAME
  FROM
    UNIQUE_INDEXES UI,
    DBA_IND_COLUMNS IC
  WHERE
    UI.OWNER = IC.TABLE_OWNER AND
    UI.TABLE_NAME = IC.TABLE_NAME AND
    UI.INDEX_NAME = IC.INDEX_NAME
),
NULLABLE_INDEX_COLUMNS AS
( SELECT /*+ MATERIALIZE */
    IC.OWNER,
    IC.TABLE_NAME,
    IC.INDEX_NAME,
    IC.COLUMN_NAME
  FROM
    INDEX_COLUMNS IC,
    DBA_TAB_COLUMNS TC
  WHERE
    IC.OWNER = TC.OWNER AND
    IC.TABLE_NAME = TC.TABLE_NAME AND
    IC.COLUMN_NAME = TC.COLUMN_NAME AND
    TC.NULLABLE = 'Y'
),
ENCRYPTED_INDEX_COLUMNS AS
( SELECT /*+ MATERIALIZE */
    IC.OWNER,
    IC.TABLE_NAME,
    IC.INDEX_NAME,
    IC.COLUMN_NAME
  FROM
    INDEX_COLUMNS IC,
    DBA_ENCRYPTED_COLUMNS EC
  WHERE
    IC.OWNER = EC.OWNER AND
    IC.TABLE_NAME = EC.TABLE_NAME AND
    IC.COLUMN_NAME = EC.COLUMN_NAME
),
DISABLED_PK_CONSTRAINTS AS
( SELECT /*+ MATERIALIZE */
    C.OWNER,
    C.TABLE_NAME
  FROM
    DBA_CONSTRAINTS C
  WHERE
    C.STATUS = 'DISABLED'
)
SELECT
  OWNER,
  TABLE_NAME,
  TO_CHAR(NUM_ROwS, 99999999990) NUM_ROWS,
  TO_CHAR(BLOCKS, 9999999990) BLOCKS,
  LPAD(NO_UNIQUE_INDEX, 15) NO_UNIQUE_INDEX,
  LPAD(NULLABLE_INDEX_COLUMNS, 22) NULLABLE_INDEX_COLUMNS,
  LPAD(ENCRYPTED_INDEX_COLUMNS, 23) ENCRYPTED_INDEX_COLUMNS,
  LPAD(DISABLED_PK_CONSTRAINT, 22) DISABLED_PK_CONSTRAINT
FROM
( SELECT
    OWNER,
    TABLE_NAME,
    NUM_ROWS,
    BLOCKS,
    DECODE(SUM(UNIQUE_INDEX), 0, 'X', ' ') NO_UNIQUE_INDEX,
    DECODE(MIN(NULLABLE_INDEX_COLUMNS), 0, ' ', 'X') NULLABLE_INDEX_COLUMNS,
    DECODE(MIN(ENCRYPTED_INDEX_COLUMNS), 0, ' ', 'X') ENCRYPTED_INDEX_COLUMNS,
    DECODE(MIN(DISABLED_PK_CONSTRAINT), 0, ' ', 'X') DISABLED_PK_CONSTRAINT,
    MIN_ROWS_THRESHOLD,
    MIN_BLOCKS_THRESHOLD,
    EXCLUDE_FACT_TABLES
  FROM
  ( SELECT
      T.OWNER,
      T.TABLE_NAME,
      T.NUM_ROWS,
      T.BLOCKS,
      DECODE(UI.INDEX_NAME, NULL, 0, 1) UNIQUE_INDEX,
      SUM(DECODE(NIC.COLUMN_NAME, NULL, 0, 1)) NULLABLE_INDEX_COLUMNS,
      SUM(DECODE(EIC.COLUMN_NAME, NULL, 0, 1)) ENCRYPTED_INDEX_COLUMNS,
      SUM(DECODE(DPC.TABLE_NAME, NULL, 0, 1)) DISABLED_PK_CONSTRAINT,
      BI.MIN_ROWS_THRESHOLD,
      BI.MIN_BLOCKS_THRESHOLD,
      BI.EXCLUDE_FACT_TABLES
    FROM
      BASIS_INFO BI,
      TABLES T,
      UNIQUE_INDEXES UI,
      NULLABLE_INDEX_COLUMNS NIC,
      ENCRYPTED_INDEX_COLUMNS EIC,
      DISABLED_PK_CONSTRAINTS DPC
    WHERE
      T.OWNER = UI.OWNER (+) AND
      T.TABLE_NAME = UI.TABLE_NAME (+) AND
      UI.OWNER = NIC.OWNER (+) AND
      UI.TABLE_NAME = NIC.TABLE_NAME (+) AND
      UI.INDEX_NAME = NIC.INDEX_NAME (+) AND
      UI.OWNER = EIC.OWNER (+) AND
      UI.TABLE_NAME = EIC.TABLE_NAME (+) AND
      UI.INDEX_NAME = EIC.INDEX_NAME (+) AND
      T.OWNER = DPC.OWNER (+) AND
      T.TABLE_NAME = DPC.TABLE_NAME (+)
    GROUP BY
      T.OWNER,
      T.TABLE_NAME,
      T.NUM_ROWS,
      T.BLOCKS,
      UI.INDEX_NAME,
      BI.MIN_ROWS_THRESHOLD,
      BI.MIN_BLOCKS_THRESHOLD,
      BI.EXCLUDE_FACT_TABLES
  )
  GROUP BY
    OWNER,
    TABLE_NAME,
    NUM_ROWS,
    BLOCKS,
    MIN_ROWS_THRESHOLD,
    MIN_BLOCKS_THRESHOLD,
    EXCLUDE_FACT_TABLES
)
WHERE
  ( NO_UNIQUE_INDEX = 'X' OR
    NULLABLE_INDEX_COLUMNS = 'X' OR
    ENCRYPTED_INDEX_COLUMNS = 'X' ) AND
  ( MIN_ROWS_THRESHOLD = -1 OR NUM_ROWS >= MIN_ROWS_THRESHOLD ) AND
  ( MIN_BLOCKS_THRESHOLD = -1 OR BLOCKS >= MIN_BLOCKS_THRESHOLD ) AND
  ( EXCLUDE_FACT_TABLES = ' ' OR 
    ( TABLE_NAME NOT LIKE '/BI_/E%' AND
      TABLE_NAME NOT LIKE '/BI_/F%' )
  )
ORDER BY
  NUM_ROWS DESC
));

