SELECT 
  NULL BEGIN_TIME, NULL AVG_CR_LATENCY_MS, NULL AVG_CR_BUILD_MS, NULL AVG_CR_FLUSH_MS, 
  NULL AVG_CR_SEND_MS, NULL AVG_CR_LMS_MS, NULL AVG_CUR_LATENCY_MS, NULL AVG_CUR_PIN_MS, 
  NULL AVG_CUR_FLUSH_MS, NULL AVG_CUR_SEND_MS, NULL AVG_CUR_LMS_MS 
FROM DUAL WHERE 1 = 0 
UNION ALL (
SELECT 
  NULL BEGIN_TIME, NULL AVG_CR_LATENCY_MS, NULL AVG_CR_BUILD_MS, NULL AVG_CR_FLUSH_MS, 
  NULL AVG_CR_SEND_MS, NULL AVG_CR_LMS_MS, NULL AVG_CUR_LATENCY_MS, NULL AVG_CUR_PIN_MS, 
  NULL AVG_CUR_FLUSH_MS, NULL AVG_CUR_SEND_MS, NULL AVG_CUR_LMS_MS 
FROM DUAL WHERE 1 = 0 
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT 
    DECODE(DBID, -1, OWN_DBID, DBID) DBID,
    DECODE(INSTANCE_NUMBER, -1, USERENV('INSTANCE'), INSTANCE_NUMBER) INSTANCE_NUMBER,
    BEGIN_DATE,
    END_DATE,
    TO_TIMESTAMP(TO_CHAR(BEGIN_DATE, 'dd.mm.yyyy hh24:mi:ss'), 
      'dd.mm.yyyy hh24:mi:ss') BEGIN_TIME,
    TO_TIMESTAMP(TO_CHAR(END_DATE, 'dd.mm.yyyy hh24:mi:ss'), 
      'dd.mm.yyyy hh24:mi:ss') END_TIME,
    AGGREGATE_BY,
    SORT_ORDER,
    EXCLUDE_WEEKENDS
  FROM
  ( SELECT
      -1 DBID,
      -2 INSTANCE_NUMBER,        /* -1 for current instance, -2 for all instances */
      TO_DATE('01.01.1000 12:57:00', 'dd.mm.yyyy hh24:mi:ss') BEGIN_DATE,
      TO_DATE('31.12.9999 00:05:00', 'dd.mm.yyyy hh24:mi:ss') END_DATE,
      'SNAPSHOT' AGGREGATE_BY,  /* SNAPSHOT, DAY, HOUR_OF_DAY, INSTANCE, SS_INST, DAY_INST, HOD_INST */
      'DESC' SORT_ORDER,     /* ASC, DESC */
      ' ' EXCLUDE_WEEKENDS
    FROM
      DUAL
  ),
  ( SELECT DBID OWN_DBID FROM V$DATABASE )
),
SNAPSHOTS AS
( SELECT /*+ MATERIALIZE */ 
    DBID,
    INSTANCE_NUMBER,
    SNAP_ID,
    PREV_SNAP_ID,
    MIN_SNAP_ID,
    BEGIN_INTERVAL_TIME,
    END_INTERVAL_TIME,
    INTERVAL_SECONDS,
    SUM(INTERVAL_SECONDS) OVER () TOTAL_SECONDS,
    RESTART
  FROM
  ( SELECT
      HSS2.DBID,
      HSS2.INSTANCE_NUMBER,
      HSS2.SNAP_ID,
      HSS1.SNAP_ID PREV_SNAP_ID,
      MIN(HSS2.SNAP_ID) OVER (PARTITION BY HSS2.INSTANCE_NUMBER) MIN_SNAP_ID,
      HSS2.BEGIN_INTERVAL_TIME,
      HSS2.END_INTERVAL_TIME,
      TO_CHAR(HSS2.END_INTERVAL_TIME, 'SSSSS') -
        TO_CHAR(HSS2.BEGIN_INTERVAL_TIME, 'SSSSS') +
        86400 * (TO_CHAR(HSS2.END_INTERVAL_TIME, 'J') - 
                 TO_CHAR(HSS2.BEGIN_INTERVAL_TIME, 'J'))
        INTERVAL_SECONDS,
      DECODE(HSS2.STARTUP_TIME, HSS1.STARTUP_TIME, 'NO', 'YES') RESTART
    FROM 
      BASIS_INFO BI,
      DBA_HIST_SNAPSHOT HSS1, 
      DBA_HIST_SNAPSHOT HSS2
    WHERE
      HSS2.DBID = BI.DBID AND
      HSS1.DBID (+) = HSS2.DBID AND
      ( BI.INSTANCE_NUMBER = -2 OR 
        HSS2.INSTANCE_NUMBER = BI.INSTANCE_NUMBER ) AND
      HSS1.INSTANCE_NUMBER (+) = HSS2.INSTANCE_NUMBER AND
      HSS2.END_INTERVAL_TIME BETWEEN BI.BEGIN_TIME AND BI.END_TIME AND
      HSS1.SNAP_ID (+) = HSS2.SNAP_ID - 1
    ORDER BY
      HSS2.SNAP_ID
  )
),
BLKTIME_PER_INTERVAL AS
( SELECT
    SNAP_ID,
    MIN(BEGIN_INTERVAL_TIME) OVER (PARTITION BY SNAP_ID) BEGIN_INTERVAL_TIME,
    PREV_SNAP_ID,
    INSTANCE_NUMBER,
    SECONDS,
    CR_BLK_RECEIVE_TIME,
    CR_BLK_RECEIVED,
    CR_BLK_BUILD_TIME,
    CR_BLK_FLUSH_TIME,
    CR_BLK_SEND_TIME,
    CR_BLK_SERVED,
	CUR_BLK_RECEIVE_TIME,
    CUR_BLK_RECEIVED,
    CUR_BLK_PIN_TIME,
    CUR_BLK_FLUSH_TIME,
    CUR_BLK_SEND_TIME,
    CUR_BLK_SERVED	
  FROM
  ( SELECT
      SS.INSTANCE_NUMBER,
      SS.SNAP_ID,
      SS.BEGIN_INTERVAL_TIME,
      SS.INTERVAL_SECONDS SECONDS,
      DECODE(SS.RESTART, 'YES', HSY1.VALUE, HSY1.VALUE - 
        LAG(HSY1.VALUE, 1) OVER (PARTITION BY SS.INSTANCE_NUMBER ORDER BY SS.SNAP_ID)) CR_BLK_RECEIVE_TIME,
      DECODE(SS.RESTART, 'YES', HSY2.VALUE, HSY2.VALUE - 
        LAG(HSY2.VALUE, 1) OVER (PARTITION BY SS.INSTANCE_NUMBER ORDER BY SS.SNAP_ID)) CR_BLK_RECEIVED,
      DECODE(SS.RESTART, 'YES', HSY3.VALUE, HSY3.VALUE - 
        LAG(HSY3.VALUE, 1) OVER (PARTITION BY SS.INSTANCE_NUMBER ORDER BY SS.SNAP_ID)) CR_BLK_BUILD_TIME,
      DECODE(SS.RESTART, 'YES', HSY4.VALUE, HSY4.VALUE - 
        LAG(HSY4.VALUE, 1) OVER (PARTITION BY SS.INSTANCE_NUMBER ORDER BY SS.SNAP_ID)) CR_BLK_FLUSH_TIME,
      DECODE(SS.RESTART, 'YES', HSY5.VALUE, HSY5.VALUE - 
        LAG(HSY5.VALUE, 1) OVER (PARTITION BY SS.INSTANCE_NUMBER ORDER BY SS.SNAP_ID)) CR_BLK_SEND_TIME,
      DECODE(SS.RESTART, 'YES', HSY6.VALUE, HSY6.VALUE - 
        LAG(HSY6.VALUE, 1) OVER (PARTITION BY SS.INSTANCE_NUMBER ORDER BY SS.SNAP_ID)) CR_BLK_SERVED,
	  DECODE(SS.RESTART, 'YES', HSY7.VALUE, HSY7.VALUE - 
        LAG(HSY7.VALUE, 1) OVER (PARTITION BY SS.INSTANCE_NUMBER ORDER BY SS.SNAP_ID)) CUR_BLK_RECEIVE_TIME,
      DECODE(SS.RESTART, 'YES', HSY8.VALUE, HSY8.VALUE - 
        LAG(HSY8.VALUE, 1) OVER (PARTITION BY SS.INSTANCE_NUMBER ORDER BY SS.SNAP_ID)) CUR_BLK_RECEIVED,
      DECODE(SS.RESTART, 'YES', HSY9.VALUE, HSY9.VALUE - 
        LAG(HSY9.VALUE, 1) OVER (PARTITION BY SS.INSTANCE_NUMBER ORDER BY SS.SNAP_ID)) CUR_BLK_PIN_TIME,
      DECODE(SS.RESTART, 'YES', HSY10.VALUE, HSY10.VALUE - 
        LAG(HSY10.VALUE, 1) OVER (PARTITION BY SS.INSTANCE_NUMBER ORDER BY SS.SNAP_ID)) CUR_BLK_FLUSH_TIME,
      DECODE(SS.RESTART, 'YES', HSY11.VALUE, HSY11.VALUE - 
        LAG(HSY11.VALUE, 1) OVER (PARTITION BY SS.INSTANCE_NUMBER ORDER BY SS.SNAP_ID)) CUR_BLK_SEND_TIME,
      DECODE(SS.RESTART, 'YES', HSY12.VALUE, HSY12.VALUE - 
        LAG(HSY12.VALUE, 1) OVER (PARTITION BY SS.INSTANCE_NUMBER ORDER BY SS.SNAP_ID)) CUR_BLK_SERVED,
      SS.PREV_SNAP_ID,
      SS.MIN_SNAP_ID
    FROM
      SNAPSHOTS SS,
      DBA_HIST_SYSSTAT HSY1, 
      DBA_HIST_SYSSTAT HSY2, 
      DBA_HIST_SYSSTAT HSY3,
      DBA_HIST_SYSSTAT HSY4,
      DBA_HIST_SYSSTAT HSY5,
      DBA_HIST_SYSSTAT HSY6,
	  DBA_HIST_SYSSTAT HSY7, 
      DBA_HIST_SYSSTAT HSY8, 
      DBA_HIST_SYSSTAT HSY9,
      DBA_HIST_SYSSTAT HSY10,
      DBA_HIST_SYSSTAT HSY11,
      DBA_HIST_SYSSTAT HSY12
    WHERE
      HSY1.DBID = SS.DBID AND
      HSY2.DBID = SS.DBID AND
      HSY3.DBID = SS.DBID AND
      HSY4.DBID = SS.DBID AND
      HSY5.DBID = SS.DBID AND
      HSY6.DBID = SS.DBID AND
      HSY7.DBID = SS.DBID AND
      HSY8.DBID = SS.DBID AND
      HSY9.DBID = SS.DBID AND
      HSY10.DBID = SS.DBID AND
      HSY11.DBID = SS.DBID AND
      HSY12.DBID = SS.DBID AND
      HSY1.INSTANCE_NUMBER = SS.INSTANCE_NUMBER AND
      HSY2.INSTANCE_NUMBER = SS.INSTANCE_NUMBER AND
      HSY3.INSTANCE_NUMBER = SS.INSTANCE_NUMBER AND
      HSY4.INSTANCE_NUMBER = SS.INSTANCE_NUMBER AND
      HSY5.INSTANCE_NUMBER = SS.INSTANCE_NUMBER AND
      HSY6.INSTANCE_NUMBER = SS.INSTANCE_NUMBER AND
      HSY7.INSTANCE_NUMBER = SS.INSTANCE_NUMBER AND
      HSY8.INSTANCE_NUMBER = SS.INSTANCE_NUMBER AND
      HSY9.INSTANCE_NUMBER = SS.INSTANCE_NUMBER AND
      HSY10.INSTANCE_NUMBER = SS.INSTANCE_NUMBER AND
      HSY11.INSTANCE_NUMBER = SS.INSTANCE_NUMBER AND
      HSY12.INSTANCE_NUMBER = SS.INSTANCE_NUMBER AND
      HSY1.SNAP_ID = SS.SNAP_ID AND
      HSY2.SNAP_ID = SS.SNAP_ID AND
      HSY3.SNAP_ID = SS.SNAP_ID AND
      HSY4.SNAP_ID = SS.SNAP_ID AND
      HSY5.SNAP_ID = SS.SNAP_ID AND
      HSY6.SNAP_ID = SS.SNAP_ID AND
      HSY7.SNAP_ID = SS.SNAP_ID AND
      HSY8.SNAP_ID = SS.SNAP_ID AND
      HSY9.SNAP_ID = SS.SNAP_ID AND
      HSY10.SNAP_ID = SS.SNAP_ID AND
      HSY11.SNAP_ID = SS.SNAP_ID AND
      HSY12.SNAP_ID = SS.SNAP_ID AND
      HSY1.STAT_NAME = 'gc cr block receive time' AND
      HSY2.STAT_NAME = 'gc cr blocks received' AND
      HSY3.STAT_NAME = 'gc cr block build time' AND
      HSY4.STAT_NAME = 'gc cr block flush time' AND
      HSY5.STAT_NAME = 'gc cr block send time' AND
      HSY6.STAT_NAME = 'gc cr blocks served' AND
      HSY7.STAT_NAME = 'gc current block receive time' AND
      HSY8.STAT_NAME = 'gc current blocks received' AND
      HSY9.STAT_NAME = 'gc current block pin time' AND
      HSY10.STAT_NAME = 'gc current block flush time' AND
      HSY11.STAT_NAME = 'gc current block send time' AND
      HSY12.STAT_NAME = 'gc current blocks served' 
  )
  WHERE
    SNAP_ID != MIN_SNAP_ID
)
SELECT 
  'BEGIN TIME:' BEGIN_TIME, 
  TO_CHAR(MIN(END_INTERVAL_TIME), 'dd.mm.yyyy') CR_LATENCY_AVG_MS, 
  TO_CHAR(MIN(END_INTERVAL_TIME), 'hh24:mi:ss') CR_BUILD, 
  NULL CR_FLUSH, NULL CR_SEND, NULL CR_LMS,
  NULL CUR_LATENCY, NULL CUR_PIN, NULL CUR_FLUSH,
  NULL CUR_SEND, NULL CUR_LMS
FROM
  SNAPSHOTS
UNION ALL
( SELECT 
    'END TIME:' BEGIN_TIME, 
    TO_CHAR(MAX(END_INTERVAL_TIME), 'dd.mm.yyyy') CR_LATENCY_AVG_MS, 
    TO_CHAR(MAX(END_INTERVAL_TIME), 'hh24:mi:ss') CR_BUILD, 
    NULL CR_FLUSH, NULL CR_SEND, NULL CR_LMS,
    NULL CUR_LATENCY, NULL CUR_PIN, NULL CUR_FLUSH,
	NULL CUR_SEND, NULL CUR_LMS
  FROM 
    SNAPSHOTS
)
UNION ALL
( SELECT 
    'INSTANCE:' BEGIN_TIME, 
    DECODE(INSTANCE_NUMBER, -2, 'ALL', TO_CHAR(INSTANCE_NUMBER)) CR_LATENCY_AVG_MS, 
    NULL CR_BUILD, 
    NULL CR_FLUSH, NULL CR_SEND, NULL CR_LMS,
    NULL CUR_LATENCY, NULL CUR_PIN, NULL CUR_FLUSH,
    NULL CUR_SEND, NULL CUR_LMS
  FROM 
    BASIS_INFO
)
UNION ALL
( SELECT 
    'AGGREGATION BY:' BEGINTIME, 
    AGGREGATE_BY CR_LATENCY_AVG_MS, 
    NULL CR_BUILD, 
    NULL CR_FLUSH, NULL CR_SEND, NULL CR_LMS,
    NULL CUR_LATENCY, NULL CUR_PIN, NULL CUR_FLUSH,
    NULL CUR_SEND, NULL CUR_LMS
  FROM 
    BASIS_INFO
)
UNION ALL
( SELECT 
    'WEEKENDS EXCLUDED:' BEGIN_TIME, 
    DECODE(EXCLUDE_WEEKENDS, 'X', 'YES', 'NO') CR_LATENCY_AVG_MS, 
    NULL CR_BUILD, 
    NULL CR_FLUSH, NULL CR_SEND, NULL CR_LMS,
    NULL CUR_LATENCY, NULL CUR_PIN, NULL CUR_FLUSH,
    NULL CUR_SEND, NULL CUR_LMS
  FROM 
    BASIS_INFO
)
UNION ALL
( SELECT 
    NULL BEGINTIME, 
    NULL CR_LATENCY_AVG_MS, 
    NULL CR_BUILD, 
    NULL CR_FLUSH, NULL CR_SEND, NULL CR_LMS,
    NULL CUR_LATENCY, NULL CUR_PIN, NULL CUR_FLUSH,
    NULL CUR_SEND, NULL CUR_LMS
  FROM 
    BASIS_INFO
)
UNION ALL
( SELECT 
    BEGIN_TIME,
    AVG_CR_LATENCY_MS,
    AVG_CR_BUILD_MS,
    AVG_CR_FLUSH_MS,
    AVG_CR_SEND_MS,
    AVG_CR_LMS_MS,
    AVG_CUR_LATENCY_MS,
    AVG_CUR_PIN_MS,
    AVG_CUR_FLUSH_MS,
    AVG_CUR_SEND_MS,
    AVG_CUR_LMS_MS
  FROM
  ( SELECT 
      BEGIN_TIME, 
      TO_CHAR(DECODE(SUM(CR_BLK_RECEIVED),0,0,SUM(CR_BLK_RECEIVE_TIME)*10/SUM(CR_BLK_RECEIVED)),99999999990.9999) AVG_CR_LATENCY_MS, 
      TO_CHAR(DECODE(SUM(CR_BLK_SERVED),0,0,SUM(CR_BLK_BUILD_TIME)*10/SUM(CR_BLK_SERVED)),999999990.9999) AVG_CR_BUILD_MS,
      TO_CHAR(DECODE(SUM(CR_BLK_SERVED),0,0,SUM(CR_BLK_FLUSH_TIME)*10/SUM(CR_BLK_SERVED)),999999990.9999) AVG_CR_FLUSH_MS,
      TO_CHAR(DECODE(SUM(CR_BLK_SERVED),0,0,SUM(CR_BLK_SEND_TIME)*10/SUM(CR_BLK_SERVED)),99999990.9999) AVG_CR_SEND_MS,
      TO_CHAR(DECODE(SUM(CR_BLK_RECEIVED),0,0,SUM(CR_BLK_RECEIVE_TIME)*10/SUM(CR_BLK_RECEIVED))-
        DECODE(SUM(CR_BLK_SERVED),0,0,SUM(CR_BLK_BUILD_TIME+CR_BLK_FLUSH_TIME+CR_BLK_SEND_TIME)*10/SUM(CR_BLK_SERVED)),9999990.9999) AVG_CR_LMS_MS,
      TO_CHAR(DECODE(SUM(CUR_BLK_RECEIVED),0,0,SUM(CUR_BLK_RECEIVE_TIME)*10/SUM(CUR_BLK_RECEIVED)),999999999990.9999) AVG_CUR_LATENCY_MS, 
      TO_CHAR(DECODE(SUM(CUR_BLK_SERVED),0,0,SUM(CUR_BLK_PIN_TIME)*10/SUM(CUR_BLK_SERVED)),99999990.9999) AVG_CUR_PIN_MS,
      TO_CHAR(DECODE(SUM(CUR_BLK_SERVED),0,0,SUM(CUR_BLK_FLUSH_TIME)*10/SUM(CUR_BLK_SERVED)),9999999990.9999) AVG_CUR_FLUSH_MS,
      TO_CHAR(DECODE(SUM(CUR_BLK_SERVED),0,0,SUM(CUR_BLK_SEND_TIME)*10/SUM(CUR_BLK_SERVED)),999999990.9999) AVG_CUR_SEND_MS,
      TO_CHAR(DECODE(SUM(CUR_BLK_RECEIVED),0,0,SUM(CUR_BLK_RECEIVE_TIME)*10/SUM(CUR_BLK_RECEIVED))-
      DECODE(SUM(CUR_BLK_SERVED),0,0,SUM(CUR_BLK_PIN_TIME+CUR_BLK_FLUSH_TIME+CUR_BLK_SEND_TIME)*10/SUM(CUR_BLK_SERVED)),99999990.9999) AVG_CUR_LMS_MS
    FROM
    ( SELECT
        DECODE(BI.AGGREGATE_BY,
          'SNAPSHOT', TO_CHAR(K.BEGIN_INTERVAL_TIME, 'YYYY-MM-DD HH24:MI:SS'),
          'DAY', TO_CHAR(K.BEGIN_INTERVAL_TIME, 'YYYY-MM-DD (DY)'),
          'HOUR_OF_DAY', TO_CHAR(K.BEGIN_INTERVAL_TIME, 'HH24') || ':00',
          'INSTANCE', 'Instance: ' || TO_CHAR(K.INSTANCE_NUMBER),
          'SS_INST', TO_CHAR(K.BEGIN_INTERVAL_TIME, 'YYYY-MM-DD HH24:MI:SS') ||
             ' (Instance: ' || TO_CHAR(K.INSTANCE_NUMBER) || ')',
          'DAY_INST', TO_CHAR(K.BEGIN_INTERVAL_TIME, 'YYYY-MM-DD (DY)') ||
             ' (Instance: ' || TO_CHAR(K.INSTANCE_NUMBER) || ')',
          'HOD_INST', TO_CHAR(K.BEGIN_INTERVAL_TIME, 'HH24') || ':00' ||
             ' (Instance: ' || TO_CHAR(K.INSTANCE_NUMBER) || ')') BEGIN_TIME,
          K.*,
          BI.SORT_ORDER,
          BI.AGGREGATE_BY
        FROM
          BASIS_INFO BI,
          BLKTIME_PER_INTERVAL K
        WHERE
          K.PREV_SNAP_ID IS NOT NULL AND
          ( BI.EXCLUDE_WEEKENDS = ' ' OR 
            TO_CHAR(K.BEGIN_INTERVAL_TIME, 'D') NOT IN (7, 1) )
      )
      GROUP BY
        BEGIN_TIME,
        SORT_ORDER,
        AGGREGATE_BY
      ORDER BY
        DECODE(SORT_ORDER, 
          'ASC', MIN(BEGIN_TIME), SYSDATE),
        DECODE(SORT_ORDER, 
          'DESC', MIN(BEGIN_TIME), SYSDATE) DESC
  )
)		
));
