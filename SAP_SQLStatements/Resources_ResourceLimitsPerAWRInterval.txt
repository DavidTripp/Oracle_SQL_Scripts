SELECT  NULL BEGIN_TIME, NULL PROC_CUR, NULL PROC_MAX, NULL SESS_CUR, NULL SESS_MAX,
  NULL ENQ_CUR, NULL ENQ_MAX, NULL PX_CUR, NULL PX_MAX FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT  NULL BEGIN_TIME, NULL PROC_CUR, NULL PROC_MAX, NULL SESS_CUR, NULL SESS_MAX,
  NULL ENQ_CUR, NULL ENQ_MAX, NULL PX_CUR, NULL PX_MAX FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT /*+ MATERIALIZE */
    DECODE(DBID, -1, OWN_DBID, DBID) DBID,
    DECODE(INSTANCE_NUMBER, -1, USERENV('INSTANCE'), INSTANCE_NUMBER) INSTANCE_NUMBER,
    BEGIN_DATE,
    END_DATE,
    TO_TIMESTAMP(TO_CHAR(BEGIN_DATE, 'dd.mm.yyyy hh24:mi:ss'), 
      'dd.mm.yyyy hh24:mi:ss') BEGIN_TIME,
    TO_TIMESTAMP(TO_CHAR(END_DATE, 'dd.mm.yyyy hh24:mi:ss'), 
      'dd.mm.yyyy hh24:mi:ss') END_TIME
  FROM
  ( SELECT
      -1 DBID,
      -1 INSTANCE_NUMBER,          
      TO_DATE('01.01.1000 01:04:00', 'dd.mm.yyyy hh24:mi:ss') BEGIN_DATE,
      TO_DATE('31.12.9999 01:05:00', 'dd.mm.yyyy hh24:mi:ss') END_DATE
    FROM
      DUAL
  ),
  ( SELECT DBID OWN_DBID FROM V$DATABASE )
),
SNAPSHOTS AS
( SELECT 
    HSS.DBID,
    HSS.INSTANCE_NUMBER,
    HSS.SNAP_ID,
    HSS.BEGIN_INTERVAL_TIME BEGIN_TIME
  FROM 
    DBA_HIST_SNAPSHOT HSS,
    BASIS_INFO BI
  WHERE
    HSS.DBID = BI.DBID AND
    HSS.INSTANCE_NUMBER = BI.INSTANCE_NUMBER AND
    HSS.END_INTERVAL_TIME >= BI.BEGIN_TIME AND
    HSS.BEGIN_INTERVAL_TIME <= BI.END_TIME 
)
SELECT
  TO_CHAR(BEGIN_TIME, 'dd.mm.yyyy hh24:mi:ss') BEGIN_TIME,
  TO_CHAR(PROC_CUR, 9999990) PROC_CUR,
  TO_CHAR(PROC_MAX, 9999990) PROC_MAX,
  TO_CHAR(SESS_CUR, 9999990) SESS_CUR,
  TO_CHAR(SESS_MAX, 9999990) SESS_MAX,
  TO_CHAR(ENQ_CUR, 999990) ENQ_CUR,
  TO_CHAR(ENQ_MAX, 999990) ENQ_MAX,
  TO_CHAR(PX_CUR, 99990) PX_CUR,
  TO_CHAR(PX_MAX, 99990) PX_MAX
FROM
( SELECT
    SS.BEGIN_TIME,
    SUM(DECODE(RESOURCE_NAME, 'processes', CURRENT_UTILIZATION, 0)) PROC_CUR,
    SUM(DECODE(RESOURCE_NAME, 'processes', MAX_UTILIZATION, 0)) PROC_MAX,
    SUM(DECODE(RESOURCE_NAME, 'sessions', CURRENT_UTILIZATION, 0)) SESS_CUR,
    SUM(DECODE(RESOURCE_NAME, 'sessions', MAX_UTILIZATION, 0)) SESS_MAX,
    SUM(DECODE(RESOURCE_NAME, 'enqueue_locks', CURRENT_UTILIZATION, 0)) ENQ_CUR,
    SUM(DECODE(RESOURCE_NAME, 'enqueue_locks', MAX_UTILIZATION, 0)) ENQ_MAX,
    SUM(DECODE(RESOURCE_NAME, 'parallel_max_servers', CURRENT_UTILIZATION, 0)) PX_CUR,
    SUM(DECODE(RESOURCE_NAME, 'parallel_max_servers', MAX_UTILIZATION, 0)) PX_MAX,
    SS.SNAP_ID
  FROM
    SNAPSHOTS SS,
    DBA_HIST_RESOURCE_LIMIT RL
  WHERE
    SS.DBID = RL.DBID AND
    SS.INSTANCE_NUMBER = RL.INSTANCE_NUMBER AND
    SS.SNAP_ID = RL.SNAP_ID
  GROUP BY
    SS.BEGIN_TIME,
    SS.SNAP_ID
)
ORDER BY
  SNAP_ID DESC
));
